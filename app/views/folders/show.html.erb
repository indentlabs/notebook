<div x-data="{
  showNewFolderModal: false,
  showEditFolderModal: false,
  leftSidebarOpen: window.innerWidth >= 1280,
  rightSidebarOpen: window.innerWidth >= 1536,
  viewMode: 'grid',
  searchQuery: '',
  folderSearchQuery: ''
}" 
x-init="
  // Handle responsive sidebar behavior
  window.addEventListener('resize', () => {
    if (window.innerWidth < 1280) {
      leftSidebarOpen = false;
      rightSidebarOpen = false;
    } else if (window.innerWidth < 1536) {
      leftSidebarOpen = true;
      rightSidebarOpen = false;
    } else {
      leftSidebarOpen = true;
      rightSidebarOpen = true;
    }
  });
"
class="min-h-screen bg-gray-50">
  
  <!-- Three Column Layout -->
  <div class="flex h-screen">
    
    <!-- Mobile Backdrop -->
    <div x-show="(leftSidebarOpen || rightSidebarOpen) && window.innerWidth < 1280" 
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="leftSidebarOpen = false; rightSidebarOpen = false"
         class="fixed inset-0 bg-black bg-opacity-25 z-40 lg:hidden"></div>

    <!-- Left Sidebar - Quick Actions & Navigation -->
    <aside x-show="leftSidebarOpen" 
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="-translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition ease-in duration-300"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="-translate-x-full"
           class="w-80 bg-white border-r border-gray-200 flex-shrink-0 overflow-y-auto fixed lg:relative lg:translate-x-0 h-full z-40 top-0 pt-14 lg:pt-0 lg:top-auto"
           :class="{ 'translate-x-0': leftSidebarOpen, '-translate-x-full': !leftSidebarOpen }">
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Quick Access</h2>
        <button @click="leftSidebarOpen = false" class="lg:hidden p-1 text-gray-400 hover:text-gray-600">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <!-- Folder Search -->
      <div class="p-4 border-b border-gray-200">
        <div class="relative">
          <input
            type="text"
            placeholder="Search folders..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            x-model="folderSearchQuery"
          />
          <i class="material-icons absolute left-3 top-2.5 text-gray-400 text-lg">search</i>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="p-4 space-y-2 border-b border-gray-200">
        <% @quick_actions.each do |action| %>
          <% if action[:path] %>
            <%= link_to action[:path], class: "w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-#{action[:color]}-500", style: "background-color: #{action[:color]}" do %>
              <i class="material-icons mr-2 text-sm"><%= action[:icon] %></i>
              <%= action[:label] %>
            <% end %>
          <% else %>
            <button
              @click="<%= action[:action] %>"
              class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <i class="material-icons mr-2 text-sm"><%= action[:icon] %></i>
              <%= action[:label] %>
            </button>
          <% end %>
        <% end %>
      </div>

      <!-- Recently Accessed Folders -->
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
          <i class="material-icons text-purple-500 text-sm mr-1">history</i>
          Recent Folders
        </h3>
        <% if @recent_folders.any? %>
          <div class="space-y-2">
            <% @recent_folders.first(5).each do |folder| %>
              <%= link_to folder_path(folder), class: "block group" do %>
                <div class="p-2 rounded-lg hover:bg-gray-50 transition-colors">
                  <div class="flex items-center">
                    <i class="material-icons <%= Folder.text_color %> text-sm mr-2"><%= Folder.icon %></i>
                    <div class="flex-1 min-w-0">
                      <h4 class="text-sm font-medium text-gray-900 truncate group-hover:text-blue-600">
                        <%= folder.title %>
                      </h4>
                      <div class="text-xs text-gray-500">
                        <%= folder.context %> folder
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No recent folders</p>
        <% end %>
      </div>

      <!-- Folders in Current Folder -->
      <div class="p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
          <i class="material-icons <%= Folder.text_color %> text-sm mr-1">folder</i>
          Folders
        </h3>
        <% if @child_folders.any? %>
          <div class="space-y-2">
            <% @child_folders.each do |folder| %>
              <%= link_to folder_path(folder), class: "block group" do %>
                <div class="p-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                  <i class="material-icons <%= Folder.text_color %> text-sm mr-2">folder</i>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 truncate group-hover:text-blue-600">
                      <%= folder.title %>
                    </h4>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No folders</p>
        <% end %>
      </div>
    </aside>


    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden">

      <!-- Header -->
      <div class="bg-white border-b border-gray-200">
        <div class="px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 sm:space-x-4">
              <!-- Left Sidebar Toggle -->
              <button
                @click="leftSidebarOpen = !leftSidebarOpen"
                class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                :class="{ 'bg-gray-100 text-gray-600': leftSidebarOpen }"
              >
                <i class="material-icons" x-text="leftSidebarOpen ? 'menu_open' : 'menu'"></i>
              </button>
            
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900">
                <%= @folder.title %>
              </h1>
            </div>
          
            <!-- Right Sidebar Toggle -->
            <button
              @click="rightSidebarOpen = !rightSidebarOpen"
              class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
              :class="{ 'bg-gray-100 text-gray-600': rightSidebarOpen }"
            >
              <i class="material-icons">insights</i>
            </button>
          </div>
        </div>
        
        <!-- Breadcrumb & Actions Bar -->
        <div class="px-6 pb-4 flex items-center justify-between">
          <nav class="flex items-center space-x-2 text-sm">
            <% if @parent_folder %>
              <%= link_to @parent_folder.title, @parent_folder, class: "text-gray-500 hover:text-gray-700 hover:underline" %>
              <i class="material-icons text-gray-400 text-sm">chevron_right</i>
            <% else %>
              <%
                context_class = @folder.context.constantize rescue Document
                if context_class.column_names.include?('folder_id')
                  context_path = context_class.name.downcase.pluralize + "_path"
                  context_name = @folder.context.pluralize
                else
                  context_path = "documents_path"
                  context_name = "Documents"
                end
              %>
              <%= link_to context_name, send(context_path), class: "text-gray-500 hover:text-gray-700 hover:underline" %>
              <i class="material-icons text-gray-400 text-sm">chevron_right</i>
            <% end %>
            <span class="font-medium text-gray-900"><%= @folder.title %></span>
          </nav>
          
          <button
            @click="showEditFolderModal = true"
            class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50"
          >
            <i class="material-icons mr-1 text-sm">edit</i>
            <span class="hidden sm:inline">Edit Folder</span>
          </button>
        </div>
        
        <!-- Filter Bar -->
        <div class="px-4 sm:px-6 pb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
            <!-- Search -->
            <div class="relative flex-1 sm:flex-initial">
              <input
                x-model="searchQuery"
                type="text"
                placeholder="Filter current view..."
                class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
              />
              <i class="material-icons absolute left-3 top-2.5 text-gray-400 text-sm">search</i>
            </div>
            
            <div class="flex items-center gap-3">
              <!-- View Toggle -->
              <div class="flex border border-gray-300 rounded-lg">
                <button @click="viewMode = 'grid'" :class="viewMode === 'grid' ? 'bg-gray-100 text-gray-900' : 'text-gray-500 hover:text-gray-700'" class="p-2 rounded-l-lg">
                  <i class="material-icons text-sm">grid_view</i>
                </button>
                <button @click="viewMode = 'list'" :class="viewMode === 'list' ? 'bg-gray-100 text-gray-900' : 'text-gray-500 hover:text-gray-700'" class="p-2 rounded-r-lg">
                  <i class="material-icons text-sm">view_list</i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Quick Stats -->
          <div class="flex items-center gap-4 sm:gap-6 text-sm">
            <div class="flex items-center text-gray-500">
              <i class="material-icons <%= @content_type_class.text_color %> mr-1 text-sm"><%= @content_type_class.icon %></i>
              <span><%= pluralize(@total_items_in_folder, @folder.context.downcase) %></span>
            </div>
            <div class="flex items-center text-gray-500">
              <i class="material-icons <%= Folder.text_color %> mr-1 text-sm">folder</i>
              <span><%= pluralize(@child_folders.count, 'folder') %></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div class="flex-1 overflow-y-auto px-4 sm:px-6 py-4 sm:py-6">
        <% if @child_folders.any? || @content.any? %>
          <!-- Grid View -->
          <div x-show="viewMode === 'grid'" class="space-y-8">
            <!-- Folders Section -->
            <% if @child_folders.any? %>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-4">Folders</h3>
                <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
                  <% @child_folders.each do |folder| %>
                    <div x-show="searchQuery === '' || '<%= folder.title.downcase %>'.includes(searchQuery.toLowerCase())"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 transform scale-90"
                         x-transition:enter-end="opacity-100 transform scale-100">
                      <%= link_to folder_path(folder), class: "block group" do %>
                        <div class="relative transform transition-all duration-200 hover:-translate-y-0.5 hover:scale-105">
                          <div class="relative overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-all duration-200">
                            <div class="h-1 <%= Folder.color %>"></div>
                            <div class="bg-white border border-gray-200 rounded-b-lg">
                              <div class="p-3">
                                <div class="flex items-start space-x-3">
                                  <div class="<%= Folder.color %> rounded-lg p-2 flex-shrink-0 shadow-sm">
                                    <i class="material-icons text-white text-base"><%= Folder.icon %></i>
                                  </div>
                                  <div class="flex-1 min-w-0">
                                    <h3 class="text-gray-900 font-medium text-sm truncate"><%= folder.title %></h3>
                                    <div class="mt-1 flex items-center text-xs text-gray-600">
                                      <%
                                        begin
                                          context_class = folder.context.constantize
                                          if context_class.column_names.include?('folder_id')
                                            content_count = context_class.where(folder: folder).count
                                            content_type_label = folder.context.downcase
                                          else
                                            content_count = 0
                                            content_type_label = 'item'
                                          end
                                        rescue
                                          content_count = 0
                                          content_type_label = 'item'
                                        end
                                      %>
                                      <% if content_count > 0 %>
                                        <i class="material-icons text-xs mr-1">description</i>
                                        <span><%= content_count %> <%= content_count == 1 ? content_type_label : content_type_label.pluralize %></span>
                                      <% else %>
                                        <i class="material-icons text-xs mr-1 opacity-50">folder_open</i>
                                        <span>Empty</span>
                                      <% end %>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
            
            <!-- Contents Section -->
            <% if @content.any? %>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-4">Contents</h3>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4">
                  <% @content.each do |content_item| %>
            <div
              class="group relative"
              x-show="searchQuery === '' || '<%= content_item.name.downcase %>'.includes(searchQuery.toLowerCase()) || '<%= content_item.respond_to?(:page_type) ? content_item.page_type.downcase : content_item.class.name.downcase %>'.includes(searchQuery.toLowerCase())"
              x-data="{
                isFavorite: <%= content_item.respond_to?(:favorite?) ? content_item.favorite? : false %>,
                isLoading: false,
                async toggleFavorite(event) {
                  if (!this.canFavorite) return;
                  event.preventDefault();
                  event.stopPropagation();
                  this.isLoading = true;
                  try {
                    const result = await window.toggleItemFavorite('<%= content_item.id %>', '<%= content_item.respond_to?(:page_type) ? content_item.page_type.downcase.pluralize : content_item.class.name.downcase.pluralize %>');
                    if (result.success) {
                      this.isFavorite = !this.isFavorite;
                    } else {
                      alert('Error toggling favorite. Please try again.');
                    }
                  } catch (error) {
                    console.error('Error:', error);
                    alert('An unexpected error occurred. Please check the console.');
                  } finally {
                    this.isLoading = false;
                  }
                },
                canFavorite: <%= content_item.respond_to?(:favorite?) ? 'true' : 'false' %>
              }"
            >
              <%= link_to (content_item.respond_to?(:view_path) ? content_item.view_path : content_item), class: "block" do %>
                <div class="bg-white hover:shadow-xl rounded-lg transition-shadow duration-200 overflow-hidden">
                  <%
                    content_image = nil
                    if content_item.respond_to?(:random_image_including_private)
                      content_image = content_item.random_image_including_private(format: :medium)
                    end
                    content_type = if content_item.respond_to?(:page_type) && content_item.page_type.present?
                                     content_item.page_type
                                   else
                                     content_item.class.name
                                   end
                    content_image ||= asset_path("card-headers/#{content_type.downcase.pluralize}.jpg")
                  %>
                  <%= image_tag content_image, class: 'h-48 w-full object-cover' %>
                  <div class="p-4">
                    <div class="flex items-start justify-between">
                      <div class="flex-1 min-w-0 pr-8">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide <%= content_item.text_color %> truncate">
                          <%= content_type %>
                        </h3>
                        <h2 class="mt-1 text-lg font-semibold text-gray-900 line-clamp-2" title="<%= content_item.name %>">
                          <%= content_item.name %>
                        </h2>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
              <% if content_item.respond_to?(:favorite?) %>
                <button
                  @click="toggleFavorite"
                  :disabled="isLoading"
                  class="absolute top-4 right-4 group p-1 text-xl rounded-lg bg-white/80 backdrop-blur-sm hover:bg-notebook-blue hover:shadow-md focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all"
                  :class="{ 'opacity-50 cursor-not-allowed': isLoading }"
                  title="Toggle favorite"
                >
                  <i class="material-icons" :class="isFavorite ? 'text-yellow-400' : 'text-gray-400 group-hover:text-yellow-400'" x-text="isFavorite ? 'star' : 'star_outline'"></i>
                </button>
              <% end %>
            </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          
          <!-- List View -->
          <div x-show="viewMode === 'list'" style="display: none;" class="space-y-6">
            <!-- Folders Section -->
            <% if @child_folders.any? %>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-4">Folders</h3>
                <div class="bg-white shadow overflow-hidden sm:rounded-md border border-gray-200">
                  <ul class="divide-y divide-gray-200">
                    <% @child_folders.each do |folder| %>
                      <li x-show="searchQuery === '' || '<%= folder.title.downcase %>'.includes(searchQuery.toLowerCase())"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100">
                        <%= link_to folder_path(folder), class: "block hover:bg-gray-50" do %>
                          <div class="px-4 py-4 flex items-center sm:px-6">
                            <div class="min-w-0 flex-1 sm:flex sm:items-center sm:justify-between">
                              <div class="flex items-center">
                                <div class="<%= Folder.color %> rounded-lg p-2 mr-3 shadow-sm">
                                  <i class="material-icons text-white text-xl"><%= Folder.icon %></i>
                                </div>
                                <div>
                                  <div class="text-sm font-medium text-gray-900"><%= folder.title %></div>
                                  <div class="mt-1 text-xs text-gray-500">
                                    <%
                                      begin
                                        context_class = folder.context.constantize
                                        if context_class.column_names.include?('folder_id')
                                          content_count = context_class.where(folder: folder).count
                                          content_type_label = folder.context.downcase
                                        else
                                          content_count = 0
                                          content_type_label = 'item'
                                        end
                                      rescue
                                        content_count = 0
                                        content_type_label = 'item'
                                      end
                                    %>
                                    <% if content_count > 0 %>
                                      <%= content_count %> <%= content_type_label.pluralize(content_count) %>
                                    <% else %>
                                      Empty folder
                                    <% end %>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="ml-5 flex-shrink-0">
                              <i class="material-icons text-gray-400">chevron_right</i>
                            </div>
                          </div>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
            
            <!-- Contents Section -->
            <% if @content.any? %>
              <div>
                <h3 class="text-sm font-medium text-gray-500 mb-4">Contents</h3>
                <div class="bg-white shadow overflow-hidden sm:rounded-md border border-gray-200">
                  <ul class="divide-y divide-gray-200">
                    <% @content.each_with_index do |content_item, index| %>
                      <li x-show="searchQuery === '' || '<%= content_item.name.downcase %>'.includes(searchQuery.toLowerCase())"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100"
                          x-data="{
                            isFavorite: <%= content_item.respond_to?(:favorite?) ? content_item.favorite? : false %>,
                            isLoading: false,
                            async toggleFavorite(event) {
                              event.preventDefault();
                              event.stopPropagation();
                              this.isLoading = true;
                              try {
                                const result = await window.toggleItemFavorite('<%= content_item.id %>', '<%= content_item.respond_to?(:page_type) ? content_item.page_type.downcase.pluralize : content_item.class.name.downcase.pluralize %>');
                                if (result.success) {
                                  this.isFavorite = !this.isFavorite;
                                } else {
                                  alert('Error toggling favorite. Please try again.');
                                }
                              } catch (error) {
                                console.error('Error:', error);
                                alert('An unexpected error occurred. Please check the console.');
                              } finally {
                                this.isLoading = false;
                              }
                            }
                          }">
                        <%= link_to (content_item.respond_to?(:view_path) ? content_item.view_path : content_item), class: "block hover:bg-gray-50 group" do %>
                          <div class="relative px-4 py-3 flex items-center">
                            <!-- Content icon -->
                            <div class="flex-shrink-0 mr-3">
                              <% content_type = content_item.respond_to?(:page_type) && content_item.page_type.present? ? content_item.page_type : content_item.class.name %>
                              <i class="material-icons <%= content_item.text_color %> text-lg"><%= content_item.icon %></i>
                            </div>
                            
                            <!-- Content info -->
                            <div class="min-w-0 flex-1">
                              <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                  <h3 class="text-sm font-medium text-gray-900 truncate"><%= content_item.name %></h3>
                                </div>
                                <div class="flex items-center space-x-6 text-xs">
                                  <% if content_item.respond_to?(:cached_word_count) && content_item.cached_word_count %>
                                    <span class="text-gray-600 font-medium">
                                      <i class="material-icons text-xs mr-0.5 <%= content_item.text_color %> align-middle">description</i>
                                      <%= number_with_delimiter(content_item.cached_word_count) %> words
                                    </span>
                                  <% end %>
                                  <% if content_item.respond_to?(:updated_at) %>
                                    <span class="text-gray-500 font-medium"><%= time_ago_in_words(content_item.updated_at) %> ago</span>
                                  <% end %>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Favorite Toggle Button -->
                            <% if content_item.respond_to?(:favorite?) %>
                              <button
                                @click="toggleFavorite"
                                :disabled="isLoading"
                                class="ml-2 p-1 text-lg rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                :class="{ 'opacity-50 cursor-not-allowed': isLoading }"
                                title="Toggle favorite"
                              >
                                <i class="material-icons" :class="isFavorite ? 'text-yellow-400' : 'text-gray-400'" x-text="isFavorite ? 'star' : 'star_outline'"></i>
                              </button>
                            <% end %>
                            
                            <!-- Chevron -->
                            <div class="ml-2 flex-shrink-0">
                              <i class="material-icons text-gray-400 text-lg">chevron_right</i>
                            </div>
                          </div>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <!-- Empty State -->
          <div class="flex items-center justify-center h-full">
            <div class="text-center max-w-lg">
              <div class="mx-auto h-24 w-24 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mb-6 shadow-sm">
                <i class="material-icons text-4xl text-gray-400">folder_open</i>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-3">This folder is empty</h3>
              <p class="text-gray-600 mb-8">Add content to this folder by selecting "Move to folder" when viewing any page.</p>
              <div class="flex justify-center space-x-3">
                <% if @quick_actions.any? %>
                  <% action = @quick_actions.first %>
                  <% if action[:path] %>
                    <%= link_to action[:path], class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white hover:opacity-90", style: "background-color: #{action[:color]}" do %>
                      <i class="material-icons mr-2 text-sm"><%= action[:icon] %></i>
                      <%= action[:label] %>
                    <% end %>
                  <% end %>
                <% end %>
                <button @click="showNewFolderModal = true" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white <%= Folder.color %> hover:opacity-90">
                  <i class="material-icons mr-2 text-sm">create_new_folder</i>
                  Create Folder
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </main>
    
    <!-- Right Sidebar - Folder Stats -->
    <aside x-show="rightSidebarOpen"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition ease-in duration-300"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full"
           class="w-80 bg-white border-l border-gray-200 flex-shrink-0 overflow-y-auto fixed lg:relative lg:translate-x-0 h-full z-40 right-0 top-0 pt-14 lg:pt-0 lg:top-auto"
           :class="{ 'translate-x-0': rightSidebarOpen, 'translate-x-full': !rightSidebarOpen }">
      
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Folder Stats</h2>
        <button @click="rightSidebarOpen = false" class="lg:hidden p-1 text-gray-400 hover:text-gray-600">
          <i class="material-icons">close</i>
        </button>
      </div>
      
      <!-- Overall Stats -->
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Folder Overview</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">Total Items</span>
            <span class="text-sm font-medium text-gray-900"><%= number_with_delimiter(@total_items_in_folder) %></span>
          </div>
          <% if @content_type_class.column_names.include?('cached_word_count') %>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Total Words</span>
              <span class="text-sm font-medium text-gray-900"><%= number_with_delimiter(@total_words_in_folder) %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Average per Item</span>
              <span class="text-sm font-medium text-gray-900"><%= @total_items_in_folder > 0 ? number_with_delimiter((@total_words_in_folder.to_f / @total_items_in_folder).round) : 0 %></span>
            </div>
          <% end %>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600">Items This Month</span>
            <span class="text-sm font-medium text-gray-900"><%= @items_this_month %></span>
          </div>
        </div>
      </div>
      
      <!-- Content Type Breakdown -->
      <%
        content_counts_per_type = Hash.new(0)
        @content.each { |page| content_counts_per_type[page.respond_to?(:page_type) ? page.page_type : page.class.name] += 1 }
      %>
      <% if content_counts_per_type.keys.count > 1 %>
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Content Types</h3>
          <div class="space-y-2">
            <% content_counts_per_type.each do |content_type, count| %>
              <div class="flex items-center justify-between text-sm">
                <div class="flex items-center">
                  <i class="material-icons text-sm mr-2 <%= content_class_from_name(content_type).text_color %>">
                    <%= content_class_from_name(content_type).icon %>
                  </i>
                  <span class="text-gray-700"><%= content_type.downcase.pluralize.humanize %></span>
                </div>
                <span class="text-gray-900 font-medium"><%= count %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <!-- Activity -->
      <div class="p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Activity</h3>
        <div class="space-y-3">
          <% if @last_activity %>
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600">Last Updated</span>
              <span class="text-gray-900"><%= time_ago_in_words(@last_activity) %> ago</span>
            </div>
          <% end %>
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-600">Created</span>
            <span class="text-gray-900"><%= time_ago_in_words(@folder.created_at) %> ago</span>
          </div>
        </div>
      </div>
    </aside>
  </div>
  
  <!-- Include modals -->
  <div x-show="showNewFolderModal">
    <%= render partial: 'folders/tailwind_new_modal', locals: { content_type: @content_type_class, parent_folder: @folder } %>
  </div>
  
  <div x-show="showEditFolderModal">
    <%= render partial: 'folders/tailwind_edit_modal', locals: { folder: @folder } %>
  </div>

  <!-- Enhanced JavaScript -->
  <script>
    // Global function for toggling favorites
    window.toggleItemFavorite = async function(contentId, contentClass) {
      const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
      let postUrl = contentClass === 'documents'
        ? `/documents/${contentId}/toggle_favorite`
        : `/plan/${contentClass}/${contentId}/toggle_favorite`;
      
      try {
        let response = await fetch(postUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ id: contentId })
        });
        
        if (!response.ok && postUrl.startsWith('/plan/')) {
          postUrl = `/${contentClass}/${contentId}/toggle_favorite`;
          response = await fetch(postUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ id: contentId })
          });
        }
        
        return { success: response.ok };
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Only if not typing in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        // CMD/Ctrl + K to focus search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          const searchInput = document.querySelector('input[x-model="searchQuery"]');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }
        
        // CMD/Ctrl + \ to toggle left sidebar
        if ((e.metaKey || e.ctrlKey) && e.key === '\\') {
          e.preventDefault();
          window.Alpine && window.Alpine.evaluate(document.querySelector('[x-data]'), 'leftSidebarOpen = !leftSidebarOpen');
        }
        
        // 1 for grid view, 2 for list view
        if (e.key === '1') {
          e.preventDefault();
          window.Alpine && window.Alpine.evaluate(document.querySelector('[x-data]'), 'viewMode = "grid"');
        }
        if (e.key === '2') {
          e.preventDefault();
          window.Alpine && window.Alpine.evaluate(document.querySelector('[x-data]'), 'viewMode = "list"');
        }
      });

      // Search empty state management
      function updateSearchEmptyState() {
        const searchInput = document.querySelector('input[x-model="searchQuery"]');
        const searchEmptyState = document.getElementById('search-empty-state');
        
        if (!searchInput || !searchEmptyState) return;
        
        const searchQuery = searchInput.value.trim();
        const visibleItems = document.querySelectorAll('[x-show*="searchQuery"]:not([style*="display: none"])');
        
        if (searchQuery && visibleItems.length === 0) {
          searchEmptyState.style.display = 'block';
        } else {
          searchEmptyState.style.display = 'none';
        }
      }
      
      // Watch for search input changes
      const searchInput = document.querySelector('input[x-model="searchQuery"]');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          setTimeout(updateSearchEmptyState, 100); // Small delay to let Alpine.js update visibility
        });
      }
    });
  </script>
</div>
