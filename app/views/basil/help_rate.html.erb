<%
  # Define colors and labels map for reuse
  rating_config = {
    -2 => { color: 'red', label: 'Very Bad', icon: ":'(" },
    -1 => { color: 'orange', label: 'Bad', icon: ':(' },
     0 => { color: 'gray', label: 'Meh', icon: ':|' },
     1 => { color: 'green', label: 'Good', icon: ':)' },
     2 => { color: 'blue', label: 'Great', icon: ':D' },
     3 => { color: 'pink', label: 'Loved', icon: 'â™¥uâ™¥' }
  }
  
  # Helper to get generic tailwind classes for rating colors
  def rating_classes(color)
    case color
    when 'red' then 'bg-red-50 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800 hover:bg-red-100 dark:hover:bg-red-900/50 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-600'
    when 'orange' then 'bg-orange-50 text-orange-800 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800 hover:bg-orange-100 dark:hover:bg-orange-900/50 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-600'
    when 'gray' then 'bg-gray-50 text-gray-800 border-gray-200 dark:bg-gray-700/50 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 peer-checked:bg-gray-500 peer-checked:text-white peer-checked:border-gray-600'
    when 'green' then 'bg-green-50 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800 hover:bg-green-100 dark:hover:bg-green-900/50 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-600'
    when 'blue' then 'bg-blue-50 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/50 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-600'
    when 'pink' then 'bg-pink-50 text-pink-800 border-pink-200 dark:bg-pink-900/30 dark:text-pink-300 dark:border-pink-800 hover:bg-pink-100 dark:hover:bg-pink-900/50 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-pink-600'
    end
  end

  current_rating_filter = params[:rating].present? ? params[:rating].to_i : nil
%>

<div class="container mx-auto px-4 py-8">
  <!-- Back Link -->
  <div class="mb-6">
    <%= link_to basil_path, class: "inline-flex items-center text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" do %>
      <i class="material-icons mr-1">chevron_left</i>
      <span>Back to Basil</span>
    <% end %>
  </div>

  <div class="flex flex-col lg:flex-row gap-8">
    <!-- Sidebar -->
    <aside class="w-full lg:w-1/4 space-y-6">
      <!-- Stats Card -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-1">
          <%= number_with_delimiter @reviewed_commission_count %>
        </h1>
        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">
          Images rated
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-600">
          <h3 class="font-semibold text-gray-700 dark:text-gray-200">Filter by Rating</h3>
        </div>
        <nav class="flex flex-col">
          <%= link_to basil_rating_queue_path, class: "flex items-center justify-between px-4 py-3 border-b border-gray-50 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors #{'bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300' if current_rating_filter.nil?}" do %>
            <span>Unrated images</span>
            <% if current_rating_filter.nil? %>
              <i class="material-icons text-sm">check</i>
            <% end %>
          <% end %>

          <% [3, 2, 1, 0, -1, -2].each do |rating| %>
            <%= link_to basil_rating_queue_path(rating: rating), class: "flex items-center justify-between px-4 py-3 border-b border-gray-50 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors #{'bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300' if current_rating_filter == rating}" do %>
              <span><%= rating_config[rating][:label] %> images</span>
              <% if current_rating_filter == rating %>
                <i class="material-icons text-sm">check</i>
              <% end %>
            <% end %>
          <% end %>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="w-full lg:w-3/4">
      <% if current_rating_filter %>
        <!-- Filter Context Header -->
        <div class="mb-6 p-4 rounded-lg <%= rating_classes(rating_config[current_rating_filter][:color]).split(' ').select{|c| c.start_with?('bg-', 'text-', 'border-', 'dark:')}.join(' ') %> border">
          <p class="text-lg">
            Showing <strong><%= pluralize @commissions.count, 'image' %></strong> you rated
            <span class="font-bold">"<%= rating_config[current_rating_filter][:label] %>"</span>.
          </p>
        </div>
      <% else %>
        <!-- Generic Intro Header -->
        <div class="mb-6 bg-purple-600 rounded-lg shadow-lg p-6 text-white">
          <p class="text-xl font-bold mb-2">
            You have <%= 'at least' if @commissions.count >= 50 %>
            <%= pluralize @commissions.count, 'generated image' %> without feedback.
          </p>
          <p class="opacity-90 leading-relaxed max-w-2xl">
            Feedback is optional but helps Basil understand what he does well and what he could improve on.
            Below are 50 random images of yours that haven't been rated. You can refresh the page at any time for 50 more.
          </p>
          <div class="mt-4">
            <%= link_to 'View global stats â†’', basil_stats_path, class: 'text-orange-300 hover:text-orange-200 font-bold underline' %>
          </div>
        </div>
      <% end %>

      <% if @commissions.empty? %>
        <div class="flex flex-col items-center justify-center p-12 text-center bg-gray-50 dark:bg-gray-800 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700">
          <div class="text-6xl mb-4">ðŸŽ‰</div>
          <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-200 mb-2">Hurrah, inbox zero!</h2>
          <p class="text-gray-500 dark:text-gray-400">
             Your images will appear here when you have any that you haven't rated.
          </p>
        </div>
      <% end %>

      <div class="space-y-8">
        <% @commissions.each do |commission| %>
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition hover:shadow-lg">
            <% if commission.complete? %>
              <!-- Header Image -->
              <div class="relative group bg-gray-100 dark:bg-gray-900 text-center">
                <%= link_to commission.image, class: "block" do %>
                  <%= image_tag commission.image, class: "mx-auto max-h-[500px] object-contain" %>
                <% end %>
              </div>

              <!-- Content -->
              <div class="p-6">
                <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-2 mb-4">
                  <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">
                      <%= link_to commission.entity.name, basil_content_path(content_type: commission.entity_type, id: commission.entity_id), class: "hover:underline hover:text-blue-600" %>
                    </h3>
                    <% if commission.style? %>
                      <p class="text-sm text-gray-500 dark:text-gray-400 italic">
                        (<%= commission.style.humanize %>)
                      </p>
                    <% end %>
                  </div>
                  <div class="text-xs text-gray-400 dark:text-gray-500 flex flex-col sm:items-end">
                    <span>Completed <%= time_ago_in_words commission.completed_at %> ago</span>
                    <span>Took <%= distance_of_time_in_words commission.completed_at - commission.created_at %></span>
                  </div>
                </div>
                
                <hr class="border-gray-100 dark:border-gray-700 my-4" />

                <!-- Feedback Section -->
                <div>
                  <div class="text-center text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Feedback for Basil</div>
                  
                  <%= form_for commission.basil_feedbacks.find_or_initialize_by(user: current_user), url: basil_feedback_path(commission.job_id), method: :POST, remote: true, html: { class: "w-full" } do |f| %>
                    <% f.object.score_adjustment = nil if !f.object.persisted? %>
                    
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                       <% [-2, -1, 0, 1, 2, 3].each do |score| %>
                         <% config = rating_config[score] %>
                         <label class="cursor-pointer group relative">
                           <%= f.radio_button :score_adjustment, score, class: 'peer sr-only autosave-closest-form-on-change' %>
                           
                           <!-- Button visual -->
                           <div class="flex flex-col items-center justify-center p-3 rounded-lg border transition-all duration-200 ease-in-out <%= rating_classes(config[:color]) %> h-full">
                             <span class="text-2xl mb-1 group-hover:scale-110 transition-transform block">
                               <%= config[:icon] %>
                             </span>
                           </div>
                           
                           <!-- Tooltip on hover (optional enhancement) -->
                           <div class="absolute inset-x-0 -bottom-6 opacity-0 group-hover:opacity-100 transition-opacity text-center pointer-events-none">
                             <span class="text-xs font-bold text-gray-500"><%= config[:label] %></span>
                           </div>
                         </label>
                       <% end %>
                    </div>
                  <% end %>
                </div>

              </div>
            <% else %>
              <!-- Pending State -->
              <div class="bg-green-700 text-white p-6">
                <div class="flex items-start gap-4">
                  <div class="animate-pulse bg-white/20 rounded-full p-2">
                     <i class="material-icons">palette</i>
                  </div>
                  <div>
                    <h3 class="font-bold text-lg">Basil is still working on this commission...</h3>
                    <p class="text-green-100">Style: <%= commission.style %></p>
                    <p class="text-green-200 text-sm mt-2">Requested <%= time_ago_in_words(commission.created_at) %> ago</p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </main>
  </div>
</div>
