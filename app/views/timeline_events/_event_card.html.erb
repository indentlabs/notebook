<%# Local variables: event, timeline, index (optional) %>
<% index ||= 0 %>
<div class="timeline-event-container relative mb-8 last:mb-0"
     data-event-id="<%= event.id %>"
     data-timeline-id="<%= timeline.id %>"
     data-position="<%= index %>"
     data-event-type="<%= event.event_type || 'general' %>"
     data-importance="<%= event.importance_level || 'minor' %>"
     data-status="<%= event.status || 'completed' %>">

  <!-- Timeline Connection -->
  <div class="absolute w-12 h-12 <%= Timeline.color %> rounded-full z-10 timeline-dot shadow-lg flex items-center justify-center ring-4 ring-white"
       style="left: 16px; top: 16px;"
       title="<%= event.event_type_name %>">
    <i class="material-icons text-white text-2xl"><%= event.event_type_icon %></i>
  </div>

  <!-- Event Card -->
  <div class="ml-20 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 timeline-event-card group cursor-pointer event-drop-zone"
       data-event-id="<%= event.id %>"
       @click="$event.alpineProcessed = true; selectEvent(<%= event.id %>, {
         id: <%= event.id %>,
         title: '<%= j(event.title) %>',
         time_label: '<%= j(event.time_label) %>',
         end_time_label: '<%= j(event.end_time_label) %>',
         description: '<%= j(event.description) %>',
         event_type: '<%= event.event_type || 'general' %>',
         status: '<%= event.status || 'completed' %>',
         tags: [<%= event.page_tags.map { |tag| "'#{j(tag.tag)}'" }.join(', ') %>]
       })"
       :class="{ 'ring-2 ring-green-500 ring-opacity-50': selectedEventId === <%= event.id %> }">
    <!-- Card Header -->
    <div class="px-6 py-4 border-b border-gray-100">
      <div class="flex items-start justify-between">
        <div class="flex-1 min-w-0">
          <div class="group relative">
            <%= form_for event, html: { class: 'autosave-form' }, remote: true, url: "/plan/timeline_events/#{event.id}" do |f| %>
              <%= f.text_field :title,
                  value: event.title.presence || "Untitled Event",
                  class: "text-xl font-semibold text-gray-900 bg-transparent border-0 border-b-2 border-transparent hover:border-gray-300 focus:border-green-500 focus:ring-0 w-full transition-all duration-200 placeholder-gray-400",
                  placeholder: "Event title...",
                  '@focus': '$el.select()',
                  '@keydown.enter.prevent': '$el.blur()',
                  '@input.debounce.500ms': 'submitFormRemotely($el.form)' %>
            <% end %>
          </div>

          <% if event.time_label.present? || true %>
            <div class="mt-2 timeline-duration-container">
              <div class="timeline-duration-fields" x-data="{ startTime: '<%= j(event.time_label) %>' }">
                <!-- Start Time Field -->
                <div class="timeline-duration-start">
                  <div class="timeline-duration-field-wrapper">
                    <i class="material-icons timeline-duration-icon">schedule</i>
                    <%= form_for event, html: { class: 'autosave-form' }, remote: true, url: "/plan/timeline_events/#{event.id}" do |f| %>
                      <%= f.text_field :time_label,
                          value: event.time_label,
                          class: "timeline-duration-input text-sm text-gray-600 bg-transparent border-0 border-b border-transparent hover:border-gray-300 focus:border-green-500 focus:ring-0 transition-all duration-200 placeholder-gray-400",
                          placeholder: "Start time",
                          'x-model': 'startTime',
                          '@keydown.enter.prevent': '$el.blur()',
                          '@input.debounce.500ms': 'submitFormRemotely($el.form)' %>
                    <% end %>
                  </div>
                </div>

                <!-- Duration Connector and End Field -->
                <div class="timeline-duration-end-section">
                  <!-- Duration Connector -->
                  <div class="timeline-duration-connector">
                    <span class="timeline-duration-arrow">â€”</span>
                  </div>

                  <!-- End Time Field -->
                  <div class="timeline-duration-end">
                    <div class="timeline-duration-field-wrapper">
                      <i class="material-icons timeline-duration-icon">schedule</i>
                      <%= form_for event, html: { class: 'autosave-form' }, remote: true, url: "/plan/timeline_events/#{event.id}" do |f| %>
                        <%= f.text_field :end_time_label,
                            value: event.end_time_label,
                            class: "timeline-duration-input text-sm text-gray-600 bg-transparent border-0 border-b border-transparent hover:border-gray-300 focus:border-green-500 focus:ring-0 transition-all duration-200 placeholder-gray-400",
                            placeholder: "End time",
                            '@keydown.enter.prevent': '$el.blur()',
                            '@input.debounce.500ms': 'submitFormRemotely($el.form)' %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Drag Handle -->
        <div class="timeline-event-drag-handle mr-2 p-2 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing rounded-lg transition-colors opacity-0 group-hover:opacity-100"
             title="Click and drag to reorder this event in the timeline">
          <i class="material-icons text-lg">drag_indicator</i>
        </div>

        <!-- Event Actions -->
        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity timeline-move-controls">
          <button type="button"
                  @click="typeof openLinkModal !== 'undefined' ? openLinkModal(<%= event.id %>) : console.error('openLinkModal not available')"
                  class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors">
            <i class="material-icons text-lg">link</i>
          </button>

          <div class="relative" x-data="{ showMoveMenu: false }">
            <button @click="showMoveMenu = !showMoveMenu"
                    class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
              <i class="material-icons text-lg">more_vert</i>
            </button>

            <div x-show="showMoveMenu"
                 x-transition
                 @click.away="showMoveMenu = false"
                 class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-20">
              <div class="py-1">
                <a href="#" class="js-move-event-to-top flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                  <i class="material-icons text-sm mr-3">vertical_align_top</i>
                  Move to Top
                </a>
                <a href="#" class="js-move-event-up flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                  <i class="material-icons text-sm mr-3">keyboard_arrow_up</i>
                  Move Up
                </a>
                <a href="#" class="js-move-event-down flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                  <i class="material-icons text-sm mr-3">keyboard_arrow_down</i>
                  Move Down
                </a>
                <a href="#" class="js-move-event-to-bottom flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                  <i class="material-icons text-sm mr-3">vertical_align_bottom</i>
                  Move to Bottom
                </a>
                <div class="border-t border-gray-100"></div>
                <a href="#" onclick="deleteEvent(<%= event.id %>, this); return false;" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                  <i class="material-icons text-sm mr-3">delete</i>
                  Delete Event
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card Body -->
    <div class="px-6 py-4 space-y-4">
      <!-- Description -->
      <div>
        <%= form_for event, html: { class: 'autosave-form' }, remote: true, url: "/plan/timeline_events/#{event.id}" do |f| %>
          <%= f.text_area :description,
              rows: 4,
              class: "w-full text-gray-700 bg-transparent border border-gray-200 rounded-lg px-3 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all duration-200 placeholder-gray-400 resize-none",
              placeholder: "What happens in this event?",
              'x-init': '$el.style.height = $el.scrollHeight + "px"',
              '@input': '$el.style.height = "auto"; $el.style.height = $el.scrollHeight + "px"',
              '@input.debounce.500ms': 'submitFormRemotely($el.form)' %>
        <% end %>
      </div>

      <!-- Tags Display -->
      <% if event.page_tags.any? %>
        <div class="flex flex-wrap gap-1" id="event-tags-<%= event.id %>">
          <% event.page_tags.each do |tag| %>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
              <%= tag.tag %>
            </span>
          <% end %>
        </div>
      <% else %>
        <!-- Empty container for tags to be populated by JavaScript -->
        <div class="flex flex-wrap gap-1 hidden" id="event-tags-<%= event.id %>"></div>
      <% end %>

      <!-- Linked Content -->
      <%= render 'shared/timeline_event_linked_content', timeline_event: event %>
    </div>
  </div>
</div>
