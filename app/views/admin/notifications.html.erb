<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Notification Analytics</h1>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
      Track open rates and engagement across notification campaigns
    </p>
  </div>

  <!-- Search Box -->
  <div class="mb-8">
    <%= form_tag(nil, method: :get, id: 'reference-code-search', class: 'flex gap-4') do %>
      <div class="flex-1 max-w-md">
        <label for="reference_code_input" class="sr-only">Search reference code</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <input type="text"
                 id="reference_code_input"
                 name="reference_code"
                 list="reference_codes_list"
                 placeholder="Search by reference code..."
                 class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <datalist id="reference_codes_list">
            <% @codes.compact.each do |code| %>
              <option value="<%= code %>">
            <% end %>
          </datalist>
        </div>
      </div>
      <button type="submit"
              class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-colors">
        View Analytics
      </button>
    <% end %>
  </div>

  <script>
    document.getElementById('reference-code-search').addEventListener('submit', function(e) {
      e.preventDefault();
      var code = document.getElementById('reference_code_input').value.trim();
      if (code) {
        window.location.href = '/admin/notifications/' + encodeURIComponent(code);
      }
    });
  </script>

  <%
    total_count = @total_count
    clicked_count = @clicked_count
    overall_rate = total_count > 0 ? (clicked_count / total_count.to_f * 100).round(1) : 0

    # Use pre-calculated average from controller (calculated in SQL)
    avg_seconds = @avg_seconds
    if avg_seconds.present? && avg_seconds > 0
      if avg_seconds < 60
        avg_time_display = "#{avg_seconds} seconds"
      elsif avg_seconds < 3600
        avg_time_display = "#{(avg_seconds / 60.0).round(1)} minutes"
      elsif avg_seconds < 86400
        avg_time_display = "#{(avg_seconds / 3600.0).round(1)} hours"
      else
        avg_time_display = "#{(avg_seconds / 86400.0).round(1)} days"
      end
    else
      avg_time_display = "N/A"
    end
  %>

  <!-- Summary Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Sent -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0 p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
          <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Sent</p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= number_with_delimiter total_count %></p>
        </div>
      </div>
    </div>

    <!-- Total Clicked -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0 p-3 bg-green-100 dark:bg-green-900 rounded-lg">
          <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Clicked</p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= number_with_delimiter clicked_count %></p>
        </div>
      </div>
    </div>

    <!-- Overall Click Rate -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0 p-3 <%= overall_rate >= 20 ? 'bg-green-100 dark:bg-green-900' : overall_rate >= 10 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-red-100 dark:bg-red-900' %> rounded-lg">
          <svg class="h-6 w-6 <%= overall_rate >= 20 ? 'text-green-600 dark:text-green-400' : overall_rate >= 10 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Click Rate</p>
          <p class="text-2xl font-semibold <%= overall_rate >= 20 ? 'text-green-600 dark:text-green-400' : overall_rate >= 10 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400' %>"><%= overall_rate %>%</p>
        </div>
      </div>
    </div>

    <!-- Average Time to Click -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0 p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
          <svg class="h-6 w-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="ml-4">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Time to Click</p>
          <p class="text-2xl font-semibold text-gray-900 dark:text-white"><%= avg_time_display %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Click Rate Trend Chart -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Notification Trend (Last 12 Months)</h3>
      <%=
        line_chart [
          { name: "Sent", data: @sent_by_month },
          { name: "Clicked", data: @clicked_by_month }
        ], colors: ['#3B82F6', '#10B981']
      %>
    </div>
  </div>

  <!-- By Reference Code Section -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">By Reference Code (Top 50 by Volume)</h2>

    <% if @code_stats.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @code_stats.each do |stats| %>
          <%
            total = stats.total_count.to_i
            clicked = stats.clicked_count.to_i
            rate = total > 0 ? (clicked / total.to_f * 100).round(1) : 0
            bar_color = rate >= 20 ? 'bg-green-500' : rate >= 10 ? 'bg-yellow-500' : 'bg-red-500'
            text_color = rate >= 20 ? 'text-green-600 dark:text-green-400' : rate >= 10 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'
          %>
          <% if stats.reference_code.present? %>
            <%= link_to admin_notification_reference_path(stats.reference_code), class: "block bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer" do %>
              <div class="p-6">
                <!-- Code name -->
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate" title="<%= stats.reference_code %>">
                    <%= stats.reference_code %>
                  </h3>
                  <span class="text-lg font-bold <%= text_color %>"><%= rate %>%</span>
                </div>

                <!-- Progress bar -->
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3">
                  <div class="<%= bar_color %> h-2 rounded-full" style="width: <%= [rate, 100].min %>%"></div>
                </div>

                <!-- Stats -->
                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                  <span><%= number_with_delimiter clicked %> clicked</span>
                  <span><%= number_with_delimiter total %> sent</span>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
              <div class="p-6">
                <!-- Code name -->
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate">
                    (no code)
                  </h3>
                  <span class="text-lg font-bold <%= text_color %>"><%= rate %>%</span>
                </div>

                <!-- Progress bar -->
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3">
                  <div class="<%= bar_color %> h-2 rounded-full" style="width: <%= [rate, 100].min %>%"></div>
                </div>

                <!-- Stats -->
                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                  <span><%= number_with_delimiter clicked %> clicked</span>
                  <span><%= number_with_delimiter total %> sent</span>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow">
        <p class="text-gray-500 dark:text-gray-400">No reference codes found.</p>
      </div>
    <% end %>
  </div>

  <!-- Link Performance Section -->
  <% if @link_stats.any? %>
    <div class="mb-8">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Link Performance (Top 50 by Volume)</h2>

      <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Destination Link</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sent</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Clicked</th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Click Rate</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            <% @link_stats.each do |stats| %>
              <%
                total = stats.total_count.to_i
                clicked = stats.clicked_count.to_i
                rate = total > 0 ? (clicked / total.to_f * 100).round(1) : 0
                text_color = rate >= 20 ? 'text-green-600 dark:text-green-400' : rate >= 10 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'
              %>
              <tr>
                <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
                  <span class="truncate block max-w-md" title="<%= stats.passthrough_link %>"><%= stats.passthrough_link.truncate(60) %></span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-right"><%= number_with_delimiter total %></td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-right"><%= number_with_delimiter clicked %></td>
                <td class="px-6 py-4 text-sm font-medium text-right <%= text_color %>"><%= rate %>%</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- Recent Activity Feed -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Recent Activity</h2>

    <% recent_notifications = Notification.order(created_at: :desc).limit(20) %>

    <% if recent_notifications.any? %>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
          <% recent_notifications.each do |notification| %>
            <li class="px-6 py-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                  <!-- Status indicator -->
                  <% if notification.viewed_at.present? %>
                    <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full" title="Clicked"></span>
                  <% else %>
                    <span class="flex-shrink-0 w-2 h-2 bg-gray-300 dark:bg-gray-600 rounded-full" title="Not clicked"></span>
                  <% end %>

                  <!-- Message -->
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-900 dark:text-white truncate">
                      <%= strip_tags(notification.message_html).truncate(80) if notification.message_html.present? %>
                    </p>
                    <div class="flex items-center space-x-2 mt-1">
                      <% if notification.reference_code.present? %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                          <%= notification.reference_code %>
                        </span>
                      <% end %>
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        <%= time_ago_in_words(notification.created_at) %> ago
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Click status -->
                <div class="ml-4 flex-shrink-0">
                  <% if notification.viewed_at.present? %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                      Clicked
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                      Pending
                    </span>
                  <% end %>
                </div>
              </div>
            </li>
          <% end %>
        </ul>
      </div>
    <% else %>
      <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow">
        <p class="text-gray-500 dark:text-gray-400">No recent notifications.</p>
      </div>
    <% end %>
  </div>
</div>
