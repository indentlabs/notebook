<% topic = @posts.topic %>
<% content_for :thredded_page_title, topic.title %>
<% content_for :thredded_page_id, 'thredded--topic-show' %>
<% content_for :thredded_breadcrumbs, '' %>

<%= thredded_page do %>
  <!-- Compact Topic Header -->
  <div class="thredded-topic-header bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-stone-200 dark:border-gray-700 mb-4">
    <div class="px-5 py-4">
      <!-- Title Row -->
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1 min-w-0">
          <h1 class="font-bold text-xl md:text-2xl text-stone-900 dark:text-white leading-tight">
            <% if topic.locked? %>
              <i class="material-icons text-yellow-500 align-middle mr-1" style="font-size: 20px;" title="Locked">lock</i>
            <% end %>
            <%= topic.title %>
          </h1>

          <!-- Inline Meta -->
          <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-stone-500 dark:text-gray-400">
            <span class="flex items-center gap-1.5">
              <%= image_tag topic.user.image_url(size: 24), class: "w-5 h-5 rounded" %>
              <%= user_link topic.user %>
              <% if topic.user.forums_badge_text.present? %>
                <span class="text-xs text-blue-600 dark:text-blue-400 font-medium"><%= topic.user.forums_badge_text %></span>
              <% end %>
            </span>
            <span class="flex items-center gap-1">
              <i class="material-icons" style="font-size: 14px;">forum</i>
              <%= topic.posts_count %> comments
            </span>
            <span class="flex items-center gap-1">
              <i class="material-icons" style="font-size: 14px;">schedule</i>
              <%= time_ago topic.created_at %>
            </span>
            <% topic.categories.each do |category| %>
              <span class="px-2 py-0.5 rounded text-xs bg-stone-100 dark:bg-gray-700 text-stone-600 dark:text-gray-300"><%= category.name %></span>
            <% end %>
          </div>
        </div>

        <!-- Compact Actions -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <% if thredded_current_user %>
            <% if topic.followed? %>
              <%= button_to topic.unfollow_path,
                            method: :post,
                            class: 'flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-500 text-white text-sm font-medium hover:bg-blue-600 transition-colors',
                            title: topic_follow_reason_text(topic.follow_reason) do %>
                <i class="material-icons" style="font-size: 16px;">notifications_active</i>
                Following
              <% end %>
            <% else %>
              <%= button_to topic.follow_path,
                            method: :post,
                            class: 'flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-stone-100 dark:bg-gray-700 text-stone-700 dark:text-gray-200 text-sm font-medium border border-stone-200 dark:border-gray-600 hover:bg-stone-200 dark:hover:bg-gray-600 transition-colors',
                            title: "Follow this topic" do %>
                <i class="material-icons" style="font-size: 16px;">notifications_none</i>
                Follow
              <% end %>
            <% end %>
          <% end %>

          <% if topic.can_update? %>
            <%= link_to topic.edit_path, rel: 'nofollow', class: 'flex items-center gap-1 px-2 py-1.5 rounded-lg text-stone-500 dark:text-gray-400 text-sm hover:bg-stone-100 dark:hover:bg-gray-700 transition-colors', title: 'Edit Topic' do %>
              <i class="material-icons" style="font-size: 16px;">edit</i>
            <% end %>
          <% end %>

          <% if topic.can_destroy? %>
            <%= button_to topic.destroy_path,
                          method: :delete,
                          data: { confirm: t('thredded.topics.delete_confirm') },
                          class: 'flex items-center gap-1 px-2 py-1.5 rounded-lg text-red-500 dark:text-red-400 text-sm hover:bg-red-50 dark:hover:bg-red-900 dark:hover:bg-opacity-20 transition-colors',
                          title: 'Delete Topic' do %>
              <i class="material-icons" style="font-size: 16px;">delete</i>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Narrower Content Area -->
  <div class="topic-content-area">
    <%= content_tag :section,
                    id: dom_id(topic),
                    class: ['thredded--topic', *topic_css_classes(topic)] do %>
      
      <!-- Top Pagination -->
      <% if @posts.respond_to?(:total_pages) && @posts.total_pages > 1 %>
        <div class="topic-pagination">
          <%= paginate @posts %>
        </div>
      <% end %>
      
      <!-- Posts Container -->
      <div class="posts-container">
        <%= render_posts @posts,
                         partial: 'thredded/posts/post',
                         content_partial: 'thredded/posts/content',
                         locals: { actions: { quote: true } } %>
      </div>
      
      <!-- Bottom Pagination -->
      <% if @posts.respond_to?(:total_pages) && @posts.total_pages > 1 %>
        <div class="topic-pagination">
          <%= paginate @posts %>
        </div>
      <% end %>
      
      <!-- Locked Topic Notice -->
      <% if topic.locked? %>
        <div class="locked-notice">
          <i class="material-icons">lock</i>
          <p><%= t 'thredded.topics.locked.message' %></p>
        </div>
      <% end %>
      
      <!-- Reply Form -->
      <% if policy(@new_post.post).create? %>
        <div class="reply-form-section">
          <div class="reply-form-header">
            <h3>
              <i class="material-icons">reply</i>
              <%= t('thredded.posts.form.title_label') %>
            </h3>
          </div>
          <div class="reply-form-body">
            <%= render 'thredded/posts/form',
                       post: @new_post,
                       button_text: t('thredded.posts.form.create_btn'),
                       button_submitting_text: t('thredded.posts.form.create_btn_submitting') %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>