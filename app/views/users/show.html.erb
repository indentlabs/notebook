<!-- SEO and Metadata -->
<script type="application/ld+json">
  <%
    set_meta_tags title: "#{@user.name || @user.display_name}'s profile",
                  description: "#{@user.display_name} is creating fictional worlds on Notebook.ai.",
                  image_src: URI.join(root_url, @user.image_url(120)),
                  og: { type: 'profile' }

    content_jsonld = {
      '@id': user_url(id: @user.id),
      '@type': 'https://schema.org/Person',
      'https://schema.org/name': @user.name,
      'https://schema.org/description': "#{@user.name}'s worldbuilding profile on Notebook.ai",
      'https://schema.org/image': URI.join(root_url, @user.image_url(120))
    }
  %>
  <%= content_jsonld.to_json.html_safe %> %>
</script>

<!-- Modern User Profile Page -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">

  <!-- Floating Share FAB -->
  <button type="button" class="share-profile-btn fixed top-20 right-4 z-50 w-10 h-10 bg-white border border-gray-200 text-gray-600 rounded-full shadow-lg hover:bg-gray-100 hover:shadow-xl hover:text-gray-900 transition-all duration-200 flex items-center justify-center" title="Share this profile">
    <i class="material-icons text-lg">share</i>
  </button>
  
  <!-- Hero Section with Banner and User Identity -->
  <div class="relative">
    <!-- Banner Image -->
    <div class="h-80 bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 relative overflow-hidden">
      <% if @user.respond_to?(:banner_image) && @user.banner_image.present? %>
        <%= image_tag @user.banner_image, class: "w-full h-full object-cover" %>
      <% else %>
        <!-- Fallback gradient with subtle pattern -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600"></div>
        <div class="absolute inset-0 opacity-20" style="background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><defs><pattern id=\"grain\" width=\"100\" height=\"100\" patternUnits=\"userSpaceOnUse\"><circle cx=\"50\" cy=\"50\" r=\"1\" fill=\"white\" opacity=\"0.1\"/></pattern></defs><rect width=\"100\" height=\"100\" fill=\"url(%23grain)\"/></svg>');"></div>
      <% end %>
      
      <!-- Overlay for better text readability -->
      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
    </div>
    
    <!-- User Identity Section -->
    <div class="relative -mt-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0">
          
          <!-- Left: Profile Info -->
          <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
            <!-- Profile Picture -->
            <div class="relative flex-shrink-0">
              <%= image_tag @user.image_url(120), class: "w-24 h-24 rounded-full border-4 border-white shadow-lg" %>
              <% if @user.respond_to?(:online?) && @user.online? %>
                <div class="absolute bottom-1 right-1 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
              <% end %>
            </div>
            
            <!-- Name and Bio -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center space-x-3">
                <h1 class="text-3xl font-bold text-gray-900 truncate">
                  <%= @user.name || @user.display_name %>
                </h1>
                <% if @user.respond_to?(:verified?) && @user.verified? %>
                  <i class="material-icons text-blue-500" title="Verified User">verified</i>
                <% end %>
              </div>
              
              <% if @user.username.present? %>
                <p class="text-lg text-gray-500 mt-1">@<%= @user.username %></p>
              <% end %>
              
              <% if @user.bio.present? %>
                <p class="text-gray-700 mt-3 max-w-2xl line-clamp-2"><%= @user.bio %></p>
              <% end %>
              
              <!-- User Details -->
              <div class="flex flex-wrap items-center space-x-6 mt-4 text-sm text-gray-500">
                <% if @user.respond_to?(:location) && @user.location.present? %>
                  <div class="flex items-center space-x-1">
                    <i class="material-icons text-xs">location_on</i>
                    <span><%= @user.location %></span>
                  </div>
                <% end %>
                
                <% if @join_date %>
                  <div class="flex items-center space-x-1">
                    <i class="material-icons text-xs">calendar_today</i>
                    <span>Joined <%= @join_date.strftime('%B %Y') %></span>
                  </div>
                <% end %>
                
                <% if @user.respond_to?(:website) && @user.website.present? %>
                  <div class="flex items-center space-x-1">
                    <i class="material-icons text-xs">link</i>
                    <%= link_to @user.website, @user.website, target: '_blank', rel: 'nofollow', class: 'text-blue-600 hover:text-blue-700' %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Right: Stats and Actions -->
          <div class="flex flex-col space-y-4">
            <!-- User Stats -->
            <div class="flex items-center space-x-6">
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-900"><%= number_with_delimiter @total_public_pages %></div>
                <div class="text-sm text-gray-500">Pages</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600"><%= number_with_delimiter @followers_count %></div>
                <div class="text-sm text-gray-500">Followers</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600"><%= number_with_delimiter @following_count %></div>
                <div class="text-sm text-gray-500">Following</div>
              </div>
              <% if @total_words > 0 %>
                <div class="text-center">
                  <div class="text-2xl font-bold text-purple-600"><%= number_with_delimiter @total_words %></div>
                  <div class="text-sm text-gray-500">Words</div>
                </div>
              <% end %>
            </div>
            
            <!-- Action Buttons -->
            <% unless user_signed_in? && @user == current_user %>
              <div class="flex items-center space-x-3">
                <% if user_signed_in? %>
                  <% unless @is_blocked %>
                    <% if @is_following %>
                      <%= form_with model: current_user.user_followings.find_by(followed_user_id: @user.id),
                                    method: :delete,
                                    local: true,
                                    class: 'inline' do |f| %>
                        <%= f.submit 'Unfollow',
                            class: 'bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 inline-flex items-center space-x-2 cursor-pointer' %>
                      <% end %>
                    <% else %>
                      <%= form_with model: UserFollowing.new,
                                    method: :post,
                                    local: true,
                                    class: 'inline' do |f| %>
                        <%= f.hidden_field :followed_user_id, value: @user.id %>
                        <%= f.submit 'Follow',
                            class: 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 inline-flex items-center space-x-2 cursor-pointer' %>
                      <% end %>
                    <% end %>

                    <% if @user.username.present? %>
                      <%= link_to Thredded::UrlsHelper.send_private_message_path(current_user: current_user, to: @user),
                          class: "border border-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors duration-200 flex items-center space-x-2" do %>
                        <i class="material-icons text-sm">message</i>
                        <span>Message</span>
                      <% end %>
                    <% else %>
                      <span class="text-xs text-gray-400 italic self-center">Not accepting messages</span>
                    <% end %>
                  <% else %>
                    <div class="text-sm text-gray-500 italic">You've blocked this user</div>
                  <% end %>
                <% else %>
                  <%= link_to new_user_session_path, class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2" do %>
                    <i class="material-icons text-sm">person_add</i>
                    <span>Follow</span>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Section with Tabs -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    
    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
      <nav class="flex space-x-8 px-6" aria-label="Profile Tabs">
        <button class="profile-tab active-tab border-b-2 border-blue-500 text-blue-600 py-4 px-1 font-medium text-sm" data-tab="overview">
          <i class="material-icons mr-2 text-sm">dashboard</i>
          Overview
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="universes">
          <i class="material-icons mr-2 text-sm">public</i>
          Universes
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="content">
          <i class="material-icons mr-2 text-sm">library_books</i>
          Content
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="tags">
          <i class="material-icons mr-2 text-sm">tag</i>
          Tags
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="activity">
          <i class="material-icons mr-2 text-sm">timeline</i>
          Activity
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="collections">
          <i class="material-icons mr-2 text-sm">collections_bookmark</i>
          Collections
        </button>
        <button class="profile-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium text-sm" data-tab="community">
          <i class="material-icons mr-2 text-sm">people</i>
          Community
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-container">
      
      <!-- Overview Tab (Default) -->
      <div id="overview-content" class="tab-content active">
        <%= render partial: 'users/tabs/overview' %>
      </div>
      
      <!-- Universes Tab -->
      <div id="universes-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/universes' %>
      </div>
      
      <!-- Content Tab -->
      <div id="content-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/content' %>
      </div>
      
      <!-- Tags Tab -->
      <div id="tags-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/tags' %>
      </div>
      
      <!-- Activity Tab -->
      <div id="activity-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/activity' %>
      </div>
      
      <!-- Collections Tab -->
      <div id="collections-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/collections' %>
      </div>
      
      <!-- Community Tab -->
      <div id="community-content" class="tab-content hidden">
        <%= render partial: 'users/tabs/community' %>
      </div>
      
    </div>
  </div>
</div>

<!-- Styles -->
<style>
  /* Line clamp utilities */
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tab transitions */
  .tab-content {
    transition: opacity 0.3s ease-in-out;
  }
  
  .tab-content.hidden {
    opacity: 0;
  }
  
  .tab-content.active {
    opacity: 1;
  }
  
  /* Profile tab active state */
  .profile-tab.active-tab {
    border-color: #3b82f6;
    color: #3b82f6;
  }
</style>

<!-- JavaScript for Tab Navigation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.profile-tab');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Remove active state from all tabs
      tabs.forEach(t => {
        t.classList.remove('active-tab', 'border-blue-500', 'text-blue-600');
        t.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Hide all tab contents
      tabContents.forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
      });
      
      // Activate clicked tab
      this.classList.add('active-tab', 'border-blue-500', 'text-blue-600');
      this.classList.remove('border-transparent', 'text-gray-500');
      
      // Show corresponding content
      const targetContent = document.getElementById(targetTab + '-content');
      if (targetContent) {
        targetContent.classList.remove('hidden');
        targetContent.classList.add('active');
      }
    });
  });
});

// Share button functionality
document.addEventListener('DOMContentLoaded', function() {
  const shareBtn = document.querySelector('.share-profile-btn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async function() {
      const profileUrl = window.location.href;
      const profileName = document.querySelector('h1')?.textContent?.trim() || 'User Profile';

      if (navigator.share) {
        try {
          await navigator.share({
            title: profileName,
            url: profileUrl
          });
        } catch (err) {
          // User cancelled or error - fall back to clipboard
          copyProfileLink(profileUrl);
        }
      } else {
        copyProfileLink(profileUrl);
      }
    });
  }

  function copyProfileLink(url) {
    navigator.clipboard.writeText(url).then(() => {
      if (window.showToast) {
        window.showToast('Profile link copied to clipboard!', 'success');
      }
    }).catch(() => {
      if (window.showToast) {
        window.showToast('Failed to copy link', 'error');
      }
    });
  }
});
</script>

<%= render partial: 'javascripts/content_linking_alpine' %>