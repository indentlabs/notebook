<%#
  We're using the medium-editor CDN here instead of the rails-medium-editor gem because it broke in the latest
  version of Chrome, and has been archived for no more changes. Ergo, we gotta move off of it. :)
%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-editor/5.23.3/js/medium-editor.min.js" integrity="sha512-5D/0tAVbq1D3ZAzbxOnvpLt7Jl/n8m/YGASscHTNYsBvTcJnrYNiDIJm6We0RPJCpFJWowOPNz9ZJx7Ei+yFiA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/medium-editor/5.23.3/css/medium-editor.min.css" integrity="sha512-zYqhQjtcNMt8/h4RJallhYRev/et7+k/HDyry20li5fWSJYSExP9O07Ung28MUuXDneIFg0f2/U3HJZWsTNAiw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<% set_meta_tags title: "Editing: " + @document.title, description: truncate(@document.body) %>

<!-- Set document ID for Alpine components (used by utility functions) -->
<script>
  window.DOCUMENT_ID = <%= @document.id %>;
</script>

<div x-data="documentEdit()" class="min-h-screen bg-white dark:bg-gray-900 flex flex-col overflow-x-hidden">

  <!-- Main content area - Flex layout -->
  <main class="flex-1 pt-14">
    <div class="flex relative">
    <!-- Center column (editor) - seamless canvas -->
    <div class="flex-1 pl-4 sm:pl-20 lg:pl-24 xl:pl-36 pr-4 py-12">
      <!-- Editor container with max width -->
      <div class="max-w-3xl">
        <!-- Document title input - Medium style: large, borderless -->
        <div class="mb-8">
          <div class="text-xs <%= Document.text_color %> font-medium uppercase tracking-wide mb-2">Editing</div>
          <%= form_for @document do |f| %>
            <%= f.text_field :title,
              id: "document_title",
              class: "w-full text-3xl md:text-4xl font-bold bg-transparent border-0 focus:outline-none focus:ring-0 text-gray-900 dark:text-gray-100 placeholder-gray-300 dark:placeholder-gray-600",
              placeholder: "Untitled"
            %>
          <% end %>
        </div>

        <!-- Editor - clean, borderless canvas -->
        <div class="min-h-[60vh]">
          <!-- Wrap editor in Alpine component for @mentions -->
          <div x-data="contentLinking()" class="relative">
            <!-- Editor content area -->
            <div id="editor"
                 class="editable js-can-mention-pages prose prose-lg dark:prose-invert max-w-none min-h-[60vh] focus:outline-none text-gray-900 dark:text-gray-100"
                 data-save-url="<%= document_url(@document) %>"
                 x-ref="editor"><%= @document.body.try(:html_safe) %></div>

            <!-- Include shared dropdown template for @mentions -->
            <%= render partial: 'javascripts/content_linking_dropdown' %>

            <!-- Mention Helper Tooltip - dismissable after first use -->
            <div x-data="{ dismissed: localStorage.getItem('mentionTipDismissed') === 'true' }"
                 x-show="!dismissed"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="dismissed = true; localStorage.setItem('mentionTipDismissed', 'true')"
                 class="absolute bottom-4 right-4 text-xs text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 px-3 py-1.5 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-1.5 shadow-sm">
              <span>Press @ to link pages</span>
              <i class="material-icons text-xs">close</i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Desktop Sidebar (Toggleable) -->
    <div x-show="showRightSidebar && isDesktop" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transform transition ease-in-out duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="fixed right-0 top-14 w-80 h-screen-minus-nav bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 overflow-y-auto z-40"
         role="complementary"
         :aria-label="activeSidebarPanel === 'information' ? 'Information' : activeSidebarPanel === 'actions' ? 'Actions' : activeSidebarPanel === 'books' ? 'Books' : 'Linked Pages'">

      <!-- Desktop Header - Dynamic based on active panel -->
      <div class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
        <button @click="activeSidebarPanel = null"
                class="flex items-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors p-1.5 -ml-1.5"
                :title="activeSidebarPanel === 'information' ? 'Hide Information' : activeSidebarPanel === 'actions' ? 'Hide Actions' : activeSidebarPanel === 'books' ? 'Hide Books' : 'Hide Linked Pages'"
                :aria-label="activeSidebarPanel === 'information' ? 'Hide Information' : activeSidebarPanel === 'actions' ? 'Hide Actions' : activeSidebarPanel === 'books' ? 'Hide Books' : 'Hide Linked Pages'">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_right</i>
          <div class="w-6 h-6 rounded-full bg-notebook-blue flex items-center justify-center mr-1.5">
            <i class="material-icons text-white text-xs" x-text="activeSidebarPanel === 'information' ? 'info' : activeSidebarPanel === 'actions' ? 'bolt' : activeSidebarPanel === 'books' ? 'menu_book' : 'link'"></i>
          </div>
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white" x-text="activeSidebarPanel === 'information' ? 'Information' : activeSidebarPanel === 'actions' ? 'Actions' : activeSidebarPanel === 'books' ? 'Books' : 'Linked Pages'"></h2>
        </button>
      </div>

      <!-- Information Panel -->
      <div x-show="activeSidebarPanel === 'information'">
        <%= render partial: 'documents/information_sidebar' %>
      </div>

      <!-- Linked Pages Panel -->
      <div x-show="activeSidebarPanel === 'linked_pages'">
        <div x-data="documentEntitiesSidebar({ documentId: <%= @document.id %> })">
          <%= render partial: 'documents/entities_sidebar' %>
        </div>
      </div>

      <!-- Actions Panel -->
      <div x-show="activeSidebarPanel === 'actions'">
        <%= render partial: 'documents/actions_sidebar' %>
      </div>

      <!-- Books Panel -->
      <div x-show="activeSidebarPanel === 'books'">
        <div x-data="documentBooksSidebar({ documentId: <%= @document.id %>, initialExpandedBooks: <%= (@document_books.count == 1 ? [@document_books.first&.id].compact : []).to_json %> })">
          <%= render partial: 'documents/books_sidebar' %>
        </div>
      </div>
    </div>

    </div> <!-- Close flex container -->

    <!-- Desktop Information Toggle Tab -->
    <div x-show="isDesktop"
         x-cloak
         @click="togglePanel('information')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'information',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'information'
         }"
         class="fixed z-40 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 76px;"
         data-tooltip="Information"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'information'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'information'">chevron_right</i>
      <i class="material-icons text-base">info</i>
    </div>

    <!-- Desktop Linked Pages Toggle Tab -->
    <div x-show="isDesktop"
         x-cloak
         @click="togglePanel('linked_pages')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'linked_pages',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'linked_pages'
         }"
         class="fixed z-40 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 124px;"
         data-tooltip="Linked Pages"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'linked_pages'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'linked_pages'">chevron_right</i>
      <i class="material-icons text-base">link</i>
    </div>

    <!-- Mobile/Tablet Information Toggle Tab -->
    <div x-show="!isDesktop"
         x-cloak
         @click="togglePanel('information')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'information',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'information'
         }"
         class="fixed z-30 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 76px;"
         data-tooltip="Information"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'information'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'information'">chevron_right</i>
      <i class="material-icons text-base">info</i>
    </div>

    <!-- Mobile/Tablet Linked Pages Toggle Tab -->
    <div x-show="!isDesktop"
         x-cloak
         @click="togglePanel('linked_pages')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'linked_pages',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'linked_pages'
         }"
         class="fixed z-30 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 124px;"
         data-tooltip="Linked Pages"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'linked_pages'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'linked_pages'">chevron_right</i>
      <i class="material-icons text-base">link</i>
    </div>

    <!-- Desktop Actions Toggle Tab -->
    <div x-show="isDesktop"
         x-cloak
         @click="togglePanel('actions')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'actions',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'actions'
         }"
         class="fixed z-40 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 172px;"
         data-tooltip="Actions"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'actions'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'actions'">chevron_right</i>
      <i class="material-icons text-base">bolt</i>
    </div>

    <!-- Mobile/Tablet Actions Toggle Tab -->
    <div x-show="!isDesktop"
         x-cloak
         @click="togglePanel('actions')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'actions',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'actions'
         }"
         class="fixed z-30 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 172px;"
         data-tooltip="Actions"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'actions'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'actions'">chevron_right</i>
      <i class="material-icons text-base">bolt</i>
    </div>

    <!-- Desktop Books Toggle Tab -->
    <div x-show="isDesktop"
         x-cloak
         @click="togglePanel('books')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'books',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'books'
         }"
         class="fixed z-40 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 220px;"
         data-tooltip="Books"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'books'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'books'">chevron_right</i>
      <i class="material-icons text-base">menu_book</i>
    </div>

    <!-- Mobile/Tablet Books Toggle Tab -->
    <div x-show="!isDesktop"
         x-cloak
         @click="togglePanel('books')"
         :class="{
           'right-80': showRightSidebar,
           'right-0': !showRightSidebar,
           'bg-teal-500 hover:bg-teal-600': activeSidebarPanel === 'books',
           'bg-notebook-blue hover:bg-blue-600': activeSidebarPanel !== 'books'
         }"
         class="fixed z-30 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 cursor-pointer flex items-center gap-1 tooltip-left"
         style="top: 220px;"
         data-tooltip="Books"
         role="button">
      <i class="material-icons text-base" x-show="activeSidebarPanel !== 'books'">chevron_left</i>
      <i class="material-icons text-base" x-show="activeSidebarPanel === 'books'">chevron_right</i>
      <i class="material-icons text-base">menu_book</i>
    </div>

    <!-- Mobile/Tablet Right Sidebar Overlay -->
    <div x-show="showRightSidebar && !isDesktop" x-cloak
         x-transition:enter="transition-opacity ease-linear duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="closeMobileSidebar()"
         @keydown.escape.window="closeMobileSidebar()"
         class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40"
         role="presentation"
         aria-hidden="true">
    </div>

    <!-- Mobile/Tablet Right Sidebar -->
    <div x-show="showRightSidebar && !isDesktop" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transform transition ease-in-out duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         @keydown.escape="closeMobileSidebar()"
         class="lg:hidden fixed right-0 top-14 h-screen-minus-nav w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-xl z-50 overflow-y-auto"
         role="dialog"
         aria-modal="true"
         :aria-labelledby="activeSidebarPanel === 'information' ? 'mobile-information-title' : activeSidebarPanel === 'actions' ? 'mobile-actions-title' : activeSidebarPanel === 'books' ? 'mobile-books-title' : 'mobile-entities-title'">

      <!-- Mobile Header - Dynamic based on active panel -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
        <button @click="closeMobileSidebar()"
                class="flex items-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors p-1.5 -ml-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                :aria-label="activeSidebarPanel === 'information' ? 'Close Information' : activeSidebarPanel === 'actions' ? 'Close Actions' : activeSidebarPanel === 'books' ? 'Close Books' : 'Close Linked Pages'">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_right</i>
          <div class="w-6 h-6 rounded-full bg-notebook-blue flex items-center justify-center mr-1.5">
            <i class="material-icons text-white text-xs" x-text="activeSidebarPanel === 'information' ? 'info' : activeSidebarPanel === 'actions' ? 'bolt' : activeSidebarPanel === 'books' ? 'menu_book' : 'link'"></i>
          </div>
          <h2 :id="activeSidebarPanel === 'information' ? 'mobile-information-title' : activeSidebarPanel === 'actions' ? 'mobile-actions-title' : activeSidebarPanel === 'books' ? 'mobile-books-title' : 'mobile-entities-title'"
              class="text-sm font-semibold text-gray-900 dark:text-white"
              x-text="activeSidebarPanel === 'information' ? 'Information' : activeSidebarPanel === 'actions' ? 'Actions' : activeSidebarPanel === 'books' ? 'Books' : 'Linked Pages'"></h2>
        </button>
      </div>

      <!-- Information Panel -->
      <div x-show="activeSidebarPanel === 'information'">
        <%= render partial: 'documents/information_sidebar' %>
      </div>

      <!-- Linked Pages Panel -->
      <div x-show="activeSidebarPanel === 'linked_pages'">
        <div x-data="documentEntitiesSidebar({ documentId: <%= @document.id %> })">
          <%= render partial: 'documents/entities_sidebar' %>
        </div>
      </div>

      <!-- Actions Panel -->
      <div x-show="activeSidebarPanel === 'actions'">
        <%= render partial: 'documents/actions_sidebar' %>
      </div>

      <!-- Books Panel -->
      <div x-show="activeSidebarPanel === 'books'">
        <div x-data="documentBooksSidebar({ documentId: <%= @document.id %>, initialExpandedBooks: <%= (@document_books.count == 1 ? [@document_books.first&.id].compact : []).to_json %> })">
          <%= render partial: 'documents/books_sidebar' %>
        </div>
      </div>
    </div>

    <!-- Modals (fixed position, outside flex layout) -->
    <div>
      <%= render partial: 'javascripts/content_linking_alpine' %>
        
        <!-- Privacy modal -->
        <%= render 'documents/privacy_modal' %>

        <!-- Document Notes modal -->
        <div
          id="document-notes-modal"
          x-data="{ open: false }"
          x-show="open"
          @open-modal.window="if ($event.detail === 'document-notes-modal') open = true"
          @close-modal.window="open = false"
          @keydown.escape.window="open = false"
          class="fixed inset-0 z-50 overflow-y-auto"
          x-cloak
        >
          <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" x-show="open" @click="open = false"></div>
          <div class="relative min-h-screen flex items-center justify-center p-4">
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-3xl transform transition-all"
              x-show="open"
              x-transition:enter="ease-out duration-300"
              x-transition:enter-start="opacity-0 translate-y-4"
              x-transition:enter-end="opacity-100 translate-y-0"
              x-transition:leave="ease-in duration-200"
              x-transition:leave-start="opacity-100 translate-y-0"
              x-transition:leave-end="opacity-0 translate-y-4"
              @click.away="open = false"
            >
              <%= form_for(@document, remote: true, html: { id: 'document-notes-form', class: 'metadata-form' }) do |f| %>
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-teal-500 to-teal-600">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-900 flex items-center justify-center mr-3">
                        <i class="material-icons text-teal-500">notes</i>
                      </div>
                      <h3 class="text-lg font-medium text-white">Document Notes</h3>
                    </div>
                    <button type="button" @click="open = false" class="text-white hover:text-gray-100 focus:outline-none">
                      <i class="material-icons">close</i>
                    </button>
                  </div>
                </div>
                <div class="p-6">
                  <div class="flex items-start mb-4">
                    <i class="material-icons text-teal-500 mr-3 mt-0.5">info</i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">
                      Document notes are for your reference only and won't be visible to readers. Use this space for research notes, planning, or any other information you want to keep with your document.
                    </span>
                  </div>
                  <%= f.text_area :notes_text,
                    class: 'w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-500 focus:ring-opacity-30 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100',
                    placeholder: "Write as little or as much as you'd like!",
                    style: 'min-height: 300px; padding: 12px;'
                  %>
                </div>
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                  <div class="flex space-x-3">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Cancel
                    </button>
                    <button type="button" class="save-metadata-button px-4 py-2 text-sm font-medium text-white bg-teal-500 border border-transparent rounded-md shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Save & Close
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Document Synopsis modal -->
        <div
          id="document-synopsis-modal"
          x-data="{ open: false }"
          x-show="open"
          @open-modal.window="if ($event.detail === 'document-synopsis-modal') open = true"
          @close-modal.window="open = false"
          @keydown.escape.window="open = false"
          class="fixed inset-0 z-50 overflow-y-auto"
          x-cloak
        >
          <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" x-show="open" @click="open = false"></div>
          <div class="relative min-h-screen flex items-center justify-center p-4">
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-3xl transform transition-all"
              x-show="open"
              x-transition:enter="ease-out duration-300"
              x-transition:enter-start="opacity-0 translate-y-4"
              x-transition:enter-end="opacity-100 translate-y-0"
              x-transition:leave="ease-in duration-200"
              x-transition:leave-start="opacity-100 translate-y-0"
              x-transition:leave-end="opacity-0 translate-y-4"
              @click.away="open = false"
            >
              <%= form_for(@document, remote: true, html: { id: 'document-synopsis-form', class: 'metadata-form' }) do |f| %>
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-teal-500 to-teal-600">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-900 flex items-center justify-center mr-3">
                        <i class="material-icons text-teal-500">short_text</i>
                      </div>
                      <h3 class="text-lg font-medium text-white">Document Synopsis</h3>
                    </div>
                    <button type="button" @click="open = false" class="text-white hover:text-gray-100 focus:outline-none">
                      <i class="material-icons">close</i>
                    </button>
                  </div>
                </div>
                <div class="p-6">
                  <div class="flex items-start mb-4">
                    <i class="material-icons text-teal-500 mr-3 mt-0.5">visibility</i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">
                      A brief summary of your document's content. This will be displayed in document listings and previews to give readers an idea of what your document is about.
                    </span>
                  </div>
                  <%= f.text_area :synopsis,
                    class: 'w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-500 focus:ring-opacity-30 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100',
                    placeholder: "Summarize your document in a few sentences...",
                    style: 'min-height: 300px; padding: 12px;'
                  %>
                </div>
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                  <div class="flex space-x-3">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Cancel
                    </button>
                    <button type="button" class="save-metadata-button px-4 py-2 text-sm font-medium text-white bg-teal-500 border border-transparent rounded-md shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Save & Close
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Document Universe modal -->
        <div
          id="document-universe-modal"
          x-data="{ open: false }"
          x-show="open"
          @open-modal.window="if ($event.detail === 'document-universe-modal') open = true"
          @close-modal.window="open = false"
          @keydown.escape.window="open = false"
          class="fixed inset-0 z-50 overflow-y-auto"
          x-cloak
        >
          <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" x-show="open" @click="open = false"></div>
          <div class="relative min-h-screen flex items-center justify-center p-4">
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-3xl transform transition-all"
              x-show="open"
              x-transition:enter="ease-out duration-300"
              x-transition:enter-start="opacity-0 translate-y-4"
              x-transition:enter-end="opacity-100 translate-y-0"
              x-transition:leave="ease-in duration-200"
              x-transition:leave-start="opacity-100 translate-y-0"
              x-transition:leave-end="opacity-0 translate-y-4"
              @click.away="open = false"
            >
              <%= form_for(@document, remote: true, html: { id: 'document-universe-form', class: 'metadata-form' }) do |f| %>
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-purple-700 to-purple-800">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-900 flex items-center justify-center mr-3">
                        <i class="material-icons text-purple-800">public</i>
                      </div>
                      <h3 class="text-lg font-medium text-white">Document Universe</h3>
                    </div>
                    <button type="button" @click="open = false" class="text-white hover:text-gray-100 focus:outline-none">
                      <i class="material-icons">close</i>
                    </button>
                  </div>
                </div>
                <div class="p-6">
                  <div class="flex items-start mb-4">
                    <i class="material-icons text-purple-800 mr-3 mt-0.5">public</i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">
                      Select a universe for this document. Documents in a universe can be organized together and share common worldbuilding elements.
                    </span>
                  </div>
                  <div class="mt-4">
                    <label for="document_universe_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Universe</label>
                    <%= f.collection_select :universe_id,
                        current_user.universes.order(:name),
                        :id,
                        :name,
                        { include_blank: "No universe" },
                        { class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" }
                    %>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                      Selecting a universe will make this document part of that universe's worldbuilding.
                    </p>
                  </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                  <div class="flex space-x-3">
                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Cancel
                    </button>
                    <button type="button" class="save-metadata-button px-4 py-2 text-sm font-medium text-white bg-teal-500 border border-transparent rounded-md shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500" @click="open = false">
                      Save & Close
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
    </div>
  </main>
      
      <!-- Subtle save status indicator - minimal Medium style -->
      <div id="save-indicator" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 flex items-center bg-gray-100/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-full px-3 py-1 transition-all duration-300">
        <i class="material-icons js-autosave-icon text-gray-400 dark:text-gray-500 mr-1.5 text-xs">cloud_done</i>
        <span class="js-autosave-status text-xs text-gray-500 dark:text-gray-400">Saved</span>
      </div>

      <!-- Initialize Medium Editor with enhanced toolbar -->
      <script>
      document.addEventListener('DOMContentLoaded', function() {
        window.editor = new MediumEditor('#editor', {
          targetBlank: true,
          autoLink: false,
          buttonLabels: 'fontawesome',
          placeholder: {
            text: 'Write as little or as much as you want!',
            hideOnClick: false
          },
          toolbar: {
            buttons: [
              'bold',
              'italic',
              'underline',
              'strikethrough',
              {
                name: 'h1',
                action: 'append-h2',
                aria: 'header type 1',
                tagNames: ['h2'],
                contentDefault: '<b>H1</b>',
                classList: ['custom-class-h1'],
                attrs: {'data-custom-attr': 'attr-value-h1'}
              },
              {
                name: 'h2',
                action: 'append-h3',
                aria: 'header type 2',
                tagNames: ['h3'],
                contentDefault: '<b>H2</b>',
                classList: ['custom-class-h2'],
                attrs: {'data-custom-attr': 'attr-value-h2'}
              },
              {
                name: 'h3',
                action: 'append-h4',
                aria: 'header type 3',
                tagNames: ['h4'],
                contentDefault: '<b>H3</b>',
                classList: ['custom-class-h3'],
                attrs: {'data-custom-attr': 'attr-value-h3'}
              },
              'justifyLeft',
              'justifyCenter',
              'justifyRight',
              'justifyFull',
              'orderedlist',
              'unorderedlist',
              'quote',
              'anchor',
              'removeFormat'
            ]
          },
          anchorPreview: {
            hideDelay: 0
          },
          paste: {
            forcePlainText: false
          }
        });

        // Add tooltips to toolbar buttons
        setTimeout(function() {
          const tooltips = {
            'bold': 'Bold (Ctrl+B)',
            'italic': 'Italic (Ctrl+I)',
            'underline': 'Underline (Ctrl+U)',
            'strikethrough': 'Strikethrough',
            'append-h2': 'Heading 1',
            'append-h3': 'Heading 2',
            'append-h4': 'Heading 3',
            'justifyLeft': 'Align Left',
            'justifyCenter': 'Align Center',
            'justifyRight': 'Align Right',
            'justifyFull': 'Justify',
            'insertorderedlist': 'Numbered List',
            'insertunorderedlist': 'Bullet List',
            'append-blockquote': 'Block Quote',
            'createLink': 'Insert Link (Ctrl+K)',
            'removeFormat': 'Clear Formatting'
          };

          document.querySelectorAll('.medium-editor-action').forEach(function(btn) {
            const action = btn.getAttribute('data-action');
            if (tooltips[action]) {
              btn.setAttribute('title', tooltips[action]);
            }
          });
        }, 100);

        // Set up CSRF token for AJAX requests
        $.ajaxSetup({
          headers: {
            'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
          }
        });
        
        // Autosave variables
        let short_timer = null;           // Timer that resets on each change (2 seconds)
        let long_timer = null;            // Timer that forces save after 30 seconds
        let last_autosave = null;         // Last AJAX request
        let first_change_time = null;     // When the first unsaved change was made
        let has_unsaved_changes = false;  // Whether we have unsaved changes
        let autosave_hide_timeout = null; // Timeout for hiding success indicator
        
        // Function to perform the actual save
        const performSave = function() {
          console.log('Performing save');

          // Update save indicator to saving state (subtle)
          $('.js-autosave-status').text('Saving...');
          $('.js-autosave-icon').text('cloud_upload').addClass('text-gray-400').removeClass('text-gray-500 text-red-400');
          $('#save-indicator').removeClass('bg-red-500/80').addClass('bg-gray-100/80 dark:bg-gray-800/80 pulse-animation');
          $('.js-autosave-status').removeClass('text-white').addClass('text-gray-500 dark:text-gray-400');

          // Update mini save indicator
          $('#mini-save-indicator i').addClass('pulse-animation');

          // Clear both timers
          clearTimeout(short_timer);
          clearTimeout(long_timer);
          short_timer = null;
          long_timer = null;

          // Reset change tracking
          first_change_time = null;
          has_unsaved_changes = false;

          // Do the autosave
          last_autosave = $.ajax({
            type: 'PATCH',
            url: $('#editor').data('save-url'),
            data: {
              document: {
                title: $('#document_title').val(),
                body: $('#editor').html()
              }
            }
          });

          last_autosave.fail(function(jqXHR, textStatus) {
            // Update indicator to error state (subtle red)
            $('.js-autosave-status').text('Error!');
            $('.js-autosave-icon').text('cloud_off').addClass('text-white').removeClass('text-gray-400 text-gray-500');
            $('#save-indicator').removeClass('bg-gray-100/80 dark:bg-gray-800/80 bg-green-100/80').addClass('bg-red-500/90');
            $('.js-autosave-status').removeClass('text-gray-500 dark:text-gray-400').addClass('text-white');

            // Mark that we still have unsaved changes
            has_unsaved_changes = true;
          });

          last_autosave.done(function() {
            // Update indicator to saved state (subtle)
            $('.js-autosave-status').text('Saved');
            $('.js-autosave-icon').text('cloud_done').addClass('text-gray-400 dark:text-gray-500').removeClass('text-white text-red-400');
            $('#save-indicator').removeClass('bg-red-500/90 pulse-animation').addClass('bg-gray-100/80 dark:bg-gray-800/80');
            $('.js-autosave-status').removeClass('text-white').addClass('text-gray-500 dark:text-gray-400');

            // Update mini save indicator
            $('#mini-save-indicator i').removeClass('pulse-animation');

            // Brief subtle green flash for success
            $('#save-indicator').addClass('bg-green-100/80 dark:bg-green-900/30');
            clearTimeout(autosave_hide_timeout);
            autosave_hide_timeout = setTimeout(function() {
              $('#save-indicator').removeClass('bg-green-100/80 dark:bg-green-900/30');
            }, 800);
          });
        };
        
        // Function to queue an autosave after a change
        const queueAutosave = function() {
          // If this is the first unsaved change, record the time
          if (!has_unsaved_changes) {
            first_change_time = new Date();
            has_unsaved_changes = true;
            
            // Set long timer for 30 seconds (won't be reset by further changes)
            if (!long_timer) {
              long_timer = setTimeout(function() {
                console.log('Long timer triggered - 30 seconds since first change');
                performSave();
              }, 30000); // 30 seconds
            }
          }
          
          // Update indicator to show pending changes (subtle)
          $('.js-autosave-status').text('Unsaved');
          $('.js-autosave-icon').text('edit');
          
          // Clear and reset the short timer (2 seconds)
          clearTimeout(short_timer);
          short_timer = setTimeout(function() {
            console.log('Short timer triggered - 2 seconds since last change');
            performSave();
          }, 2000); // 2 seconds
        };
        
        // Function to count words - matches Ruby's WordCountService behavior
        // Rules: split on /\, ignore ..., ---, ___, ignore stray punctuation
        const countWords = function() {
          // textContent is browser-optimized and strips HTML automatically
          let text = document.getElementById('editor').textContent || '';
          if (text.length === 0) return 0;

          // Preserve dates like 01/02/2024 by temporarily replacing slashes in them
          text = text.replace(/(\d{1,2})\/(\d{1,2})(\/\d{2,4})?/g, function(match) {
            return match.replace(/\//g, '-SLASH-');
          });
          // Split on forward slashes
          text = text.replace(/\//g, ' ');
          // Restore dates
          text = text.replace(/-SLASH-/g, '/');

          // Split on backslashes
          text = text.replace(/\\/g, ' ');

          // Remove dotted lines, dashed lines, underscores (standalone)
          text = text.replace(/\.{2,}/g, ' ');  // ... or ....
          text = text.replace(/-{2,}/g, ' ');   // -- or ---
          text = text.replace(/_{2,}/g, ' ');   // __ or ___

          // Remove stray punctuation (standalone punctuation not part of words)
          text = text.replace(/(?<!\w)[^\w\s]+(?!\w)/g, ' ');

          // Count words (non-empty sequences after splitting on whitespace)
          const words = text.trim().split(/\s+/).filter(function(w) { return w.length > 0; });
          return words.length;
        };

        // Function to count characters (uses textContent for efficiency)
        const countCharacters = function() {
          const text = document.getElementById('editor').textContent || '';
          return text.length;
        };

        // Function to calculate reading time (avg 200 words per minute)
        const calculateReadingTime = function(wordCount) {
          const minutes = Math.ceil(wordCount / 200);
          return minutes < 1 ? '<1' : minutes.toString();
        };

        // Update word count display
        const updateWordCount = function() {
          // Use optimized functions that read textContent directly
          const wordCount = countWords();
          const charCount = countCharacters();
          const readingTime = calculateReadingTime(wordCount);

          // Update navbar word count
          $('#word-count').text(wordCount);
          $('#mini-word-count').text(wordCount);

          // Update sidebar stats
          $('#sidebar-word-count').text(wordCount);
          $('#sidebar-char-count').text(charCount.toLocaleString());
          $('#sidebar-reading-time').text(readingTime);
        };

        // Initial word count
        updateWordCount();

        // Debounced word count to prevent performance issues on large documents
        let wordCountTimeout = null;
        const debouncedWordCount = function() {
          clearTimeout(wordCountTimeout);
          wordCountTimeout = setTimeout(updateWordCount, 500); // Max 2x/sec instead of 60x/sec
        };

        // Trigger autosave and update word count on content changes
        editor.subscribe('editableInput', function() {
          // Queue an autosave
          queueAutosave();
          // Update word count (debounced for performance on large docs)
          debouncedWordCount();
        });
        
        // Trigger autosave on title changes
        $('#document_title').on('change', function() {
          queueAutosave();
        });
        
        $('#document_title').on('keyup', function() {
          if ($(this).val().length > 0) {
            queueAutosave();
          }
        });
        
        // Manual save on click - immediate save, not queued
        $('.js-autosave-status').on('click', performSave);
        
        // Set up beforeunload handler to warn about unsaved changes
        window.addEventListener('beforeunload', function(e) {
          // Only show warning if we have unsaved changes
          if (has_unsaved_changes) {
            // Modern browsers
            e.preventDefault();
            e.returnValue = ''; // Chrome requires this
            
            // Legacy browsers (return value is ignored in modern browsers)
            return 'You have unsaved changes. Are you sure you want to leave?';
          }
        });
        
        // Alternative legacy approach for older browsers
        window.onbeforeunload = function() {
          if (has_unsaved_changes) {
            return 'You have unsaved changes. Are you sure you want to leave?';
          }
        };
        
        // Allow entering `tab` into the editor
        $(document).delegate('#editor', 'keydown', function(e) {
          const keyCode = e.keyCode || e.which;
          if (keyCode === 9) {
            e.preventDefault();
          }
        });
        
        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
          // Save (Ctrl+S)
          if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            performSave();
          }
        });
      });
      </script>
      
      <!-- Document metadata modals AJAX functionality -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Handle Save & Close button click for all metadata modals
          $('.save-metadata-button').on('click', function() {
            // Get the form closest to this button
            const form = $(this).closest('form.metadata-form');

            // Show saving state
            const button = $(this);
            const originalText = button.text();
            button.html('<i class="material-icons text-sm align-middle mr-1">hourglass_top</i> Saving...');
            button.prop('disabled', true);

            // Submit the form via AJAX
            $.ajax({
              type: 'PATCH',
              url: form.attr('action'),
              data: form.serialize(),
              success: function() {
                // Show success state
                button.html('<i class="material-icons text-sm align-middle mr-1">check</i> Saved!');

                // Close the modal after a short delay
                setTimeout(function() {
                  // Reset button
                  button.html(originalText);
                  button.prop('disabled', false);

                  // The modal should already be closed by the @click="open = false" on the button
                }, 1000);
              },
              error: function() {
                // Show error state
                button.html('<i class="material-icons text-sm align-middle mr-1">error</i> Error!');

                // Reset button after delay
                setTimeout(function() {
                  button.html(originalText);
                  button.prop('disabled', false);
                }, 2000);
              }
            });
          });
        });
      </script>
      
      <!-- Privacy toggle functionality -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Document privacy toggle
          $('#document-privacy-toggle').on('change', function() {
            const isPublic = $(this).is(':checked');
            const privacyValue = isPublic ? 'public' : 'private';
            
            // Update hidden field
            $('#document_privacy_field').val(privacyValue);
            
            // Update icon in navbar
            const privacyIcon = isPublic ? 'visibility' : 'visibility_off';
            $('button[type="button"][@click*="document-privacy-modal"] i').text(privacyIcon);
            
            // Also update the privacy status indicator in the navbar
            // Update the privacy button in the top right
            const privacyButton = $('button[type="button"][@click*="document-privacy-modal"]');
            privacyButton.find('i.material-icons').first().text(isPublic ? 'public' : 'lock');
            privacyButton.find('i.material-icons').first().removeClass('text-gray-500 text-green-500').addClass(isPublic ? 'text-green-500' : 'text-gray-500');
            privacyButton.find('span.capitalize.font-medium').text(isPublic ? 'public' : 'private');
            
            // Submit form
            $('#document-privacy-form').submit();
            
            // Show saving indicator
            const saveIndicator = $('#save-indicator');
            saveIndicator.addClass('pulse-animation');
            $('.js-autosave-status').text('Saving privacy...');
            
            // Reset indicator after delay
            setTimeout(function() {
              saveIndicator.removeClass('pulse-animation');
              $('.js-autosave-status').text('Saved');
            }, 1500);
          });
          
          // Universe privacy toggle (if present)
          $('#universe-privacy-toggle').on('change', function() {
            const isPublic = $(this).is(':checked');
            const privacyValue = isPublic ? 'public' : 'private';
            
            // Update hidden field
            $('#universe_privacy_field').val(privacyValue);
            
            // Submit form
            $('#universe-privacy-form').submit();
            
            // Show saving indicator
            const saveIndicator = $('#save-indicator');
            saveIndicator.addClass('pulse-animation');
            $('.js-autosave-status').text('Saving universe privacy...');
            
            // Reset indicator after delay
            setTimeout(function() {
              saveIndicator.removeClass('pulse-animation');
              $('.js-autosave-status').text('Saved');
            }, 1500);
          });
          
          // Helper functions for privacy radio buttons
          window.updateDocumentPrivacy = function(radio) {
            // Disable all radio buttons during submission to prevent multiple clicks
            document.querySelectorAll('[name="document-privacy-option"]').forEach(function(option) {
              option.disabled = true;
              option.parentElement.classList.add('opacity-50');
            });
            
            const value = radio.value;
            document.getElementById('document_privacy_field').value = value;
            
            // Update selected state visually
            document.querySelectorAll('[name="document-privacy-option"]').forEach(function(option) {
              const container = option.closest('div');
              if (option.value === value) {
                container.classList.add('bg-white', 'dark:bg-gray-800', 'border', 'border-teal-500');
              } else {
                container.classList.remove('bg-white', 'dark:bg-gray-800', 'border', 'border-teal-500');
              }
            });
            
            // Update UI immediately
            const statusIcon = value === 'public' ? 'public' : 'lock';
            const isPublic = value === 'public';

            // Update the privacy button in the top right navbar
            const privacyButton = $('button[type="button"][\\@click*="document-privacy-modal"]');
            privacyButton.find('i.material-icons').first().text(statusIcon);
            privacyButton.find('i.material-icons').first().removeClass('text-gray-500 text-green-500').addClass(isPublic ? 'text-green-500' : 'text-gray-500');
            privacyButton.find('span.capitalize.font-medium').text(value);

            // Update sidebar privacy UI
            const sidebarBadge = document.getElementById('sidebar-privacy-badge');
            const sidebarIcon = document.getElementById('sidebar-privacy-icon');
            const sidebarText = document.getElementById('sidebar-privacy-text');

            if (sidebarBadge) {
              sidebarBadge.className = 'w-8 h-8 rounded-full flex items-center justify-center mr-3 ' +
                (isPublic ? 'bg-green-100 dark:bg-green-900/30' : 'bg-gray-200 dark:bg-gray-600');
            }
            if (sidebarIcon) {
              sidebarIcon.textContent = statusIcon;
              sidebarIcon.className = 'material-icons text-sm ' +
                (isPublic ? 'text-green-500' : 'text-gray-500 dark:text-gray-400');
            }
            if (sidebarText) {
              sidebarText.textContent = value;
            }
            
            // Show saving indicator
            const saveIndicator = $('#save-indicator');
            saveIndicator.addClass('pulse-animation');
            $('.js-autosave-status').text('Saving privacy...');
            
            // Submit the form
            $('#document-privacy-form').submit();
          };
          
          // Flag to track if a submission is in progress
          let universePrivacySubmissionInProgress = false;
          
          // Direct AJAX update function for universe privacy
          window.updateUniversePrivacy = function(radio) {
            console.log('updateUniversePrivacy called with value:', radio.value);
            
            // Prevent multiple submissions
            if (universePrivacySubmissionInProgress) {
              console.log('Universe privacy update already in progress, ignoring this request');
              return;
            }
            
            // Set flag to prevent multiple submissions
            universePrivacySubmissionInProgress = true;
            
            // Disable all radio buttons immediately to prevent multiple clicks
            document.querySelectorAll('[name="universe-privacy-option"]').forEach(function(option) {
              option.disabled = true;
              option.parentElement.classList.add('opacity-50');
            });
            
            // Update selected state visually immediately
            const value = radio.value;
            document.querySelectorAll('[name="universe-privacy-option"]').forEach(function(option) {
              const container = option.closest('div');
              if (option.value === value) {
                container.classList.add('bg-white', 'dark:bg-gray-800', 'border', 'border-blue-500');
              } else {
                container.classList.remove('bg-white', 'dark:bg-gray-800', 'border', 'border-blue-500');
              }
            });
            
            // Show saving indicator immediately
            const saveIndicator = $('#save-indicator');
            saveIndicator.addClass('pulse-animation');
            $('.js-autosave-status').text('Saving universe privacy...');
            
            // Get universe ID from form action
            const universeId = $('#universe-privacy-form').attr('action').split('/').pop();
            const csrfToken = $('meta[name="csrf-token"]').attr('content');
            
            console.log('Making AJAX request to update universe privacy to:', value);
            
            // Make direct AJAX call instead of form submission
            $.ajax({
              type: 'PATCH',
              url: '/plan/universes/' + universeId,
              headers: {
                'X-CSRF-Token': csrfToken
              },
              data: {
                universe: {
                  privacy: value
                }
              },
              success: function(data, textStatus, xhr) {
                console.log('Universe privacy update successful');
                handleUniversePrivacySuccess(value === 'public');
              },
              error: function(xhr, status, error) {
                console.log('Universe privacy update response:', xhr.status, status);
                
                // The server is redirecting, which jQuery treats as an error
                // But we know the update was successful if we get a 302 Found
                if (xhr.status === 200 || xhr.status === 302) {
                  console.log('Treating redirect as success');
                  handleUniversePrivacySuccess(value === 'public');
                } else {
                  // Only show error for actual errors
                  console.error("Universe privacy update error:", status, error);
                  const saveIndicator = $('#save-indicator');
                  saveIndicator.removeClass('bg-white pulse-animation').addClass('bg-red-500');
                  $('.js-autosave-status').text('Error saving universe privacy!').addClass('text-white');
                  
                  // Reset indicator after delay
                  setTimeout(function() {
                    saveIndicator.removeClass('bg-red-500').addClass('bg-white');
                    $('.js-autosave-status').text('Saved').removeClass('text-white');
                  }, 2000);
                }
              },
              complete: function() {
                console.log('Universe privacy update request completed');
                // Re-enable radio buttons
                document.querySelectorAll('[name="universe-privacy-option"]').forEach(function(option) {
                  option.disabled = false;
                  option.parentElement.classList.remove('opacity-50');
                });
                
                // Reset submission flag
                universePrivacySubmissionInProgress = false;
                
                // Always remove the pulse animation when the request completes
                $('#save-indicator').removeClass('pulse-animation');
              }
            });
            
            // Helper function to handle successful universe privacy updates
            function handleUniversePrivacySuccess(isPublic) {
              // Update UI elements based on the new privacy setting
              window.updateUniversePrivacyUI(isPublic);
              
              // Show success in save indicator
              const saveIndicator = $('#save-indicator');
              saveIndicator.removeClass('pulse-animation bg-red-500').addClass('bg-green-50');
              $('.js-autosave-status').text('Universe privacy saved').removeClass('text-white');
              
              // Reset indicator after delay
              setTimeout(function() {
                saveIndicator.removeClass('bg-green-50');
                $('.js-autosave-status').text('Saved');
              }, 2000);
            }
          };

          // Function to update UI elements based on universe privacy
          window.updateUniversePrivacyUI = function(isPublic) {
            // Update the badge on the Universe tab
            const universeTab = document.querySelector('button[type="button"][\\@click*="activeTab = \'universe\'"]');
            if (universeTab) {
              let badge = universeTab.querySelector('span.ml-2');
              
              if (isPublic) {
                // Add badge if it doesn't exist
                if (!badge) {
                  badge = document.createElement('span');
                  badge.className = 'ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                  badge.textContent = 'Public';
                  universeTab.appendChild(badge);
                }
              } else {
                // Remove badge if it exists
                if (badge) {
                  badge.remove();
                }
              }
            }
            
            // Update the notice in the document privacy tab
            const universeNotice = document.querySelector('.mb-4.p-3.rounded-md.border');
            if (universeNotice) {
              if (isPublic) {
                universeNotice.classList.remove('bg-gray-50', 'border-gray-200');
                universeNotice.classList.add('bg-yellow-50', 'border-yellow-200');
                
                // Update icon container
                const iconContainer = universeNotice.querySelector('.w-8.h-8.rounded-full');
                iconContainer.classList.remove('bg-gray-100');
                iconContainer.classList.add('bg-yellow-100');
                
                // Update icon
                const icon = iconContainer.querySelector('.material-icons');
                icon.classList.remove('text-gray-500');
                icon.classList.add('text-yellow-600');
                icon.textContent = 'warning';
                
                // Update text
                const title = universeNotice.querySelector('.text-sm.font-medium');
                title.classList.remove('text-gray-700');
                title.classList.add('text-yellow-800');
                
                const description = universeNotice.querySelector('.text-xs');
                description.classList.remove('text-gray-500');
                description.classList.add('text-yellow-600');
                description.innerHTML = '<strong>Note:</strong> This universe is <strong>public</strong>, so this document will be visible to anyone who can view the universe, regardless of its own privacy setting. <a @click="activeTab = \'universe\'" class="underline cursor-pointer text-yellow-700 hover:opacity-80">Manage universe privacy</a>';
              } else {
                universeNotice.classList.remove('bg-yellow-50', 'border-yellow-200');
                universeNotice.classList.add('bg-gray-50', 'border-gray-200');
                
                // Update icon container
                const iconContainer = universeNotice.querySelector('.w-8.h-8.rounded-full');
                iconContainer.classList.remove('bg-yellow-100');
                iconContainer.classList.add('bg-gray-100');
                
                // Update icon
                const icon = iconContainer.querySelector('.material-icons');
                icon.classList.remove('text-yellow-600');
                icon.classList.add('text-gray-500');
                icon.textContent = 'info';
                
                // Update text
                const title = universeNotice.querySelector('.text-sm.font-medium');
                title.classList.remove('text-yellow-800');
                title.classList.add('text-gray-700');
                
                const description = universeNotice.querySelector('.text-xs');
                description.classList.remove('text-yellow-600');
                description.classList.add('text-gray-500');
                description.innerHTML = 'This universe is <strong>private</strong>, so this document\'s privacy setting will be respected. <a @click="activeTab = \'universe\'" class="underline cursor-pointer text-gray-600 hover:opacity-80">Manage universe privacy</a>';
              }
            }
          };
          
          // Handle form submission for document-privacy-form
          $('#document-privacy-form').on('submit', function(e) {
            e.preventDefault();
            
            const form = $(this);
            
            $.ajax({
              type: 'PATCH',
              url: form.attr('action'),
              data: form.serialize(),
              success: function() {
                // Show success in save indicator
                const saveIndicator = $('#save-indicator');
                saveIndicator.removeClass('pulse-animation bg-red-500').addClass('bg-green-50');
                $('.js-autosave-status').text('Privacy saved').removeClass('text-white');
                
                // Reset indicator after delay
                setTimeout(function() {
                  saveIndicator.removeClass('bg-green-50');
                  $('.js-autosave-status').text('Saved');
                }, 1500);
              },
              error: function() {
                // Show error in save indicator
                const saveIndicator = $('#save-indicator');
                saveIndicator.removeClass('bg-white pulse-animation').addClass('bg-red-500');
                $('.js-autosave-status').text('Error saving privacy!').addClass('text-white');
                
                // Reset indicator after delay
                setTimeout(function() {
                  saveIndicator.removeClass('bg-red-500').addClass('bg-white');
                  $('.js-autosave-status').text('Saved').removeClass('text-white');
                }, 2000);
              },
              complete: function() {
                // Re-enable radio buttons
                document.querySelectorAll('[name="document-privacy-option"]').forEach(function(option) {
                  option.disabled = false;
                  option.parentElement.classList.remove('opacity-50');
                });
              }
            });
          });
          
          // Prevent the default form submission entirely
          $('#universe-privacy-form').on('submit', function(e) {
            console.log('Preventing default form submission for universe privacy');
            e.preventDefault();
            return false;
          });
          
          // Make sure the radio buttons trigger the updateUniversePrivacy function
          document.querySelectorAll('[name="universe-privacy-option"]').forEach(function(radio) {
            // Re-attach the onchange handler to ensure it works
            radio.onchange = function() {
              updateUniversePrivacy(this);
            };
          });
          
          // Initialize UI based on current universe privacy
          $(document).ready(function() {
            <% if @document.universe.present? %>
              window.updateUniversePrivacyUI(<%= @document.universe.privacy == 'public' ? 'true' : 'false' %>);
            <% end %>
          });
          
          // Add event listener for Alpine.js tab changes to ensure badge visibility
          document.addEventListener('alpine:initialized', function() {
            // When the universe tab becomes active, ensure the badge is properly displayed
            document.addEventListener('x-on:click', function(event) {
              if (event.target.getAttribute('@click') &&
                  event.target.getAttribute('@click').includes("activeTab = 'universe'")) {
                <% if @document.universe.present? %>
                  window.updateUniversePrivacyUI(<%= @document.universe.privacy == 'public' ? 'true' : 'false' %>);
                <% end %>
              }
            });
          });
        });
      </script>
      
      <!-- Custom styles for Medium Editor to match Tailwind design -->
      <style>
        /* Remove Medium Editor's default border/box from editable area */
        .medium-editor-element {
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
          outline: none !important;
          background: transparent !important;
        }

        /* Align title input with editor content - strip browser default padding */
        #document_title {
          padding: 0;
        }

        /* Enhanced Medium Editor toolbar styling */
        .medium-editor-toolbar {
          border-radius: 0.5rem !important;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
          border: none !important;
          background-color: white !important;
          transition: all 0.2s ease;
          transform-origin: center bottom;
          animation: toolbar-appear 0.2s ease;
          max-width: calc(100vw - 2rem) !important;
          overflow: hidden !important;
        }

        .dark .medium-editor-toolbar {
          background-color: #1f2937 !important; /* gray-800 */
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
        }

        /* Style the toolbar arrow */
        .medium-editor-toolbar:after {
          border-top-color: white !important;
        }

        .dark .medium-editor-toolbar:after {
          border-top-color: #1f2937 !important;
        }

        @keyframes toolbar-appear {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .medium-editor-toolbar-active {
          visibility: visible;
        }

        .medium-editor-toolbar-actions {
          display: flex !important;
          padding: 4px !important;
          gap: 2px;
          flex-wrap: wrap;
        }

        .medium-editor-action {
          width: 36px !important;
          height: 36px !important;
          border-radius: 0.375rem !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          transition: all 0.15s ease;
          background-color: white !important;
          color: #14b8a6 !important; /* teal-500 */
          border: none !important;
        }

        .dark .medium-editor-action {
          background-color: #1f2937 !important; /* gray-800 */
          color: #5eead4 !important; /* teal-300 */
        }

        .medium-editor-action:hover {
          background-color: rgba(240, 253, 250, 1) !important; /* teal-50 */
          color: #0d9488 !important; /* teal-600 */
        }

        .dark .medium-editor-action:hover {
          background-color: #374151 !important; /* gray-700 */
          color: #5eead4 !important; /* teal-300 */
        }

        .medium-editor-button-active {
          background-color: rgba(204, 251, 241, 1) !important; /* teal-100 */
          color: #0f766e !important; /* teal-700 */
        }

        .dark .medium-editor-button-active {
          background-color: rgba(20, 184, 166, 0.2) !important; /* teal-500/20 */
          color: #5eead4 !important; /* teal-300 */
        }

        /* Muted text selection highlight */
        #editor ::selection {
          background-color: rgba(204, 251, 241, 0.6) !important; /* teal-100 with opacity */
        }

        .dark #editor ::selection {
          background-color: rgba(20, 184, 166, 0.3) !important; /* teal-500 with opacity */
        }
        
        .medium-editor-placeholder::after {
          font-style: normal;
          color: rgba(156, 163, 175, 1);
          padding: 0;
          margin: 0;
        }

        .dark .medium-editor-placeholder::after {
          color: rgba(107, 114, 128, 1); /* gray-500 */
        }
        
        /* Improve the prose styling for the editor */
        .prose {
          max-width: none;
        }
        
        .prose h2 {
          margin-top: 1.5em;
          margin-bottom: 0.5em;
        }
        
        .prose h3 {
          margin-top: 1.5em;
          margin-bottom: 0.5em;
        }
        
        .prose p {
          margin-top: 1em;
          margin-bottom: 1em;
        }
        
        .prose ul, .prose ol {
          margin-top: 1em;
          margin-bottom: 1em;
        }

        /* Autosave indicator animation */
        @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.6; }
          100% { opacity: 1; }
        }
        
        .pulse-animation {
          animation: pulse 1.5s infinite ease-in-out;
        }

        /* Remove focus outline from editor to prevent misalignment with parent border */
        #editor:focus,
        #editor:focus-visible {
          outline: none !important;
          box-shadow: none !important;
        }

        /* Force long words/strings to break to prevent horizontal overflow */
        #editor {
          overflow-wrap: break-word;
          word-break: break-word;
        }

        /* Mobile responsiveness */
        @media (max-width: 640px) {
          .medium-editor-action {
            width: 32px;
            height: 32px;
          }
          
          #editor {
            padding: 1rem;
          }
        }
      </style>

</div> <!-- Close main page container -->