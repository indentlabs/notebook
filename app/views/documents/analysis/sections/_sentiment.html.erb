<%
  sentiment_color = (analysis.sentiment_score < 0) ? 'blue' : 'green'
  sentiment_bg = (analysis.sentiment_score < 0) ? 'bg-blue-100' : 'bg-green-100'
  sentiment_text = (analysis.sentiment_score < 0) ? 'text-blue-600' : 'text-green-600'
%>

<h5 class="text-gray-500 text-xl font-semibold mb-4">Sentiment</h5>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="<%= sentiment_bg %> p-6">
      <h5 class="text-xl font-bold text-gray-900 mb-4">
        Overall <%= analysis.sentiment_label %>
      </h5>
      <div class="flex items-start gap-4">
        <div class="<%= sentiment_text %> text-center flex-shrink-0">
          <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7,9.5C7,8.7 7.7,8 8.5,8C9.3,8 10,8.7 10,9.5C10,10.3 9.3,11 8.5,11C7.7,11 7,10.3 7,9.5M12,17.23C9.97,17.23 8.16,16.5 6.76,15.36L8.67,13.45C9.66,14.13 10.81,14.54 12,14.54C13.19,14.54 14.34,14.13 15.33,13.45L17.24,15.36C15.84,16.5 14.03,17.23 12,17.23M15.5,11C14.7,11 14,10.3 14,9.5C14,8.7 14.7,8 15.5,8C16.3,8 17,8.7 17,9.5C17,10.3 16.3,11 15.5,11Z" />
          </svg>
          <div class="text-2xl font-bold mt-2">
            <%= (analysis.sentiment_score * 100).round.abs %>
          </div>
        </div>
        <div class="text-gray-900">
          <p class="mb-3">
            <%
              modifier = case analysis.sentiment_score * 100
              when 0..25
                'somewhat'
              when 26..50
                'mostly'
              when 51..100
                'very'
              else
                'generally'
              end
            %>
            This document expresses a <%= modifier %> <strong><%= analysis.sentiment_label %></strong> sentiment throughout.
          </p>
          <p class="text-sm text-gray-600">
            Your score is based on a scale from 1 to 100 based on how intense this emotion appears to be, where 100 is most intense.
          </p>
        </div>
      </div>
    </div>
  </div>

  <% if analysis.has_sentiment_scores? %>
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="p-6">
        <h5 class="text-xl font-bold mb-4">Evoked emotions</h5>
        <div id="graph-emotions"></div>
      </div>
    </div>
  <% end %>

</div>

<%
  entities_in_table = analysis.document_entities
    .order('relevance desc')
    .where(entity_type: 'Character')
    .reject { |e| e.dominant_emotion.first.second.nil? }
    .reject { |e| e.recessive_emotion.first.second.nil? }
%>
<% if entities_in_table.any? %>
  <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
    <div class="p-6">
      <h5 class="text-xl font-bold mb-4">Character emotions</h5>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b">
              <th class="text-left py-3 px-4 font-semibold">Character</th>
              <th class="text-left py-3 px-4 font-semibold">Dominant emotion</th>
              <th class="text-left py-3 px-4 font-semibold">Recessive emotion</th>
            </tr>
          </thead>
          <tbody>
            <% entities_in_table.each do |character| %>
              <tr class="border-b hover:bg-gray-50">
                <td class="py-3 px-4"><%= character.text %></td>
                <td class="py-3 px-4">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold <%= EmotionService.color_for_emotion(character.dominant_emotion.first.first) %> bg-opacity-20">
                    <%= character.dominant_emotion.first.first.to_s.titleize %>
                    (<%= (character.dominant_emotion.first.second * 100).round %>%)
                  </span>
                </td>
                <td class="py-3 px-4">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold <%= EmotionService.color_for_emotion(character.recessive_emotion.first.first) %> bg-opacity-20">
                    <%= character.recessive_emotion.first.first.to_s.titleize %>
                    (<%= (character.recessive_emotion.first.second * 100).round %>%)
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<style>
.bar {
  fill: <%= Document.hex_color %>;
}

.axis {
  font-size: 13px;
}
.label {
  font-size: 11px;
}

.axis path,
.axis line {
  fill: none;
  display: none;
}
</style>

<script type="text/javascript">
$(document).ready(function () {
  var data = [
    <% if analysis.joy_score %>
    {
        "name": "Joy",
        "value": <%= (100 * analysis.joy_score).round(1) %>,
    },
    <% end %>
    <% if analysis.sadness_score %>
    {
        "name": "Sadness",
        "value": <%= (100 * analysis.sadness_score).round(1) %>,
    },
    <% end %>
    <% if analysis.fear_score %>
    {
        "name": "Fear",
        "value": <%= (100 * analysis.fear_score).round(1) %>,
    },
    <% end %>
    <% if analysis.disgust_score %>
    {
        "name": "Disgust",
        "value": <%= (100 * analysis.disgust_score).round(1) %>,
    },
    <% end %>
    <% if analysis.anger_score %>
    {
        "name": "Anger",
        "value": <%= (100 * analysis.anger_score).round(1) %>,
    }
    <% end %>
  ];

  //sort bars based on value
  data = data.sort(function (a, b) {
    return d3.ascending(a.value, b.value);
  })

  var margin = {
    top: 10,
    right: 0,
    bottom: 30,
    left: 60
  };

  var width = 400,
      height = 300;

  var svg = d3.select("#graph-emotions")
    .append("svg")
      .attr("width", '100%')
      .attr("height", height)
      .attr('viewBox','0 0 ' + Math.min(width, height) + ' ' + Math.min(width, height + margin.bottom))
      .attr('preserveAspectRatio', 'xMinYMin')
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scaleLinear()
    .range([0, width])
    .domain([0, d3.max(data, function (d) {
      return d.value;
    })]);

  var y = d3.scalePoint()
    .rangeRound([height, 0], .1)
    .domain(data.map(function (d) {
      return d.name;
    }));

  //make y axis to show bar names
  var yAxis = d3.axisLeft()
    .scale(y)
    .tickSize(0); // no tick marks

  var gy = svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)

  var bars = svg.selectAll(".bar")
    .data(data)
    .enter()
    .append("g")

  //append rects
  bars.append("rect")
    .attr("class", "bar")
    .attr("y", function (d) {
        return y(d.name) - 10;
    })
    .attr("height", 30)
    .attr("x", 0)
    .attr("width", function (d) {
        return x(d.value);
    });

  //add a value label to the right of each bar
  bars.append("text")
    .attr("class", "label")
    .attr("y", function (d) {
        return y(d.name) + 20;
    })
    .attr("x", function (d) {
        return -25;
    })
    .text(function (d) {
        return d.value;
    });
});
</script>
