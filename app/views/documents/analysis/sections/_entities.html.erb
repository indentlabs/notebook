<%
  entities = analysis.document_entities.includes(:entity, entity: [:image_uploads]).order('entity_type asc, relevance desc')
  entity_types = entities.group_by(&:entity_type)
%>

<script type="text/javascript">
  var color = d3.scalePoint().range(["#EDC951","#CC333F","#00A0B0"]);
  var radarChartOptions = {
    h: 200,
    margin: { top: 10, right: 10, bottom: 10, left: 10 },
    levels: 4,
    maxValue: 100,
    roundStrokes: true,
    color: color,
    dotRadius: 2
  };
</script>

<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
    <div>
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Entities</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Characters, locations, and other entities detected in your writing</p>
    </div>
    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
      <%= entities.count %> found
    </span>
  </div>

  <div class="p-6">
    <% if entity_types.any? %>
      <% entity_types.each do |type, type_entities| %>
        <% entity_class = content_class_from_name(type) %>
        <div class="mb-8 last:mb-0">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
            <span class="w-3 h-3 rounded-full" style="background-color: <%= entity_class.hex_color %>"></span>
            <%= type.pluralize %> (<%= type_entities.count %>)
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <% type_entities.each do |entity| %>
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <div class="flex items-start gap-4 p-4">
                      <!-- Entity Image/Avatar -->
                      <div class="flex-shrink-0">
                        <% if entity.entity && entity.entity.image_uploads.any? %>
                          <%= image_tag entity.entity.image_uploads.sample.src.url(:thumb), class: 'w-12 h-12 rounded-lg object-cover' %>
                        <% else %>
                          <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: <%= entity_class.hex_color %>20">
                            <svg class="w-6 h-6" style="color: <%= entity_class.hex_color %>" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                            </svg>
                          </div>
                        <% end %>
                      </div>

                      <!-- Entity Info -->
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                          <h4 class="font-semibold text-gray-900 dark:text-gray-100 truncate">
                            <%= entity.text %>
                          </h4>
                          <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform flex-shrink-0 ml-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
                          </svg>
                        </div>

                        <!-- Relevance Bar -->
                        <div class="mt-2">
                          <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                            <span>Relevance</span>
                            <span class="font-medium"><%= entity.relevance.present? ? (entity.relevance * 100).round : 0 %>%</span>
                          </div>
                          <div class="h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: <%= entity.relevance.present? ? (entity.relevance * 100).round : 0 %>%; background-color: <%= entity_class.hex_color %>"></div>
                          </div>
                        </div>

                        <!-- Sentiment Badge -->
                        <% if entity.sentiment_label.present? %>
                          <div class="mt-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                              <%= case entity.sentiment_label.to_s.downcase
                                  when 'positive' then 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
                                  when 'negative' then 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                                  else 'bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200'
                                  end %>">
                              <%= entity.sentiment_label.capitalize %>
                            </span>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </summary>

                  <!-- Expanded Details -->
                  <div class="px-4 pb-4 pt-2 border-t border-gray-200 dark:border-gray-600">
                    <!-- Emotional Range Chart -->
                    <div class="mb-4">
                      <h5 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-2">Emotional Range</h5>
                      <div id="graph-character-emotions-<%= entity.id %>" class="flex justify-center"></div>
                    </div>

                    <!-- Emotion Bars -->
                    <div class="space-y-2 mb-4">
                      <% [:joy, :sadness, :fear, :disgust, :anger].each do |emotion| %>
                        <% emotion_score = entity.send("#{emotion}_score") %>
                        <% pct = emotion_score.present? ? (100 * emotion_score).round : 0 %>
                        <div class="flex items-center gap-2 text-xs">
                          <span class="w-16 text-gray-600 dark:text-gray-400"><%= emotion.to_s.titleize %></span>
                          <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                            <div class="h-full rounded-full <%= EmotionService.color_for_emotion(emotion) %>" style="width: <%= pct %>%"></div>
                          </div>
                          <span class="w-8 text-right text-gray-500 dark:text-gray-400"><%= pct %>%</span>
                        </div>
                      <% end %>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                      <% if entity.entity_id %>
                        <% linked_entity_class = entity.entity.class %>
                        <%= link_to polymorphic_path(linked_entity_class.name.downcase, id: entity.entity_id), class: 'inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 transition' do %>
                          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                          </svg>
                          View
                        <% end %>
                        <%= link_to edit_polymorphic_path(linked_entity_class.name.downcase, id: entity.entity_id), class: 'inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500 transition' do %>
                          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
                          </svg>
                          Edit
                        <% end %>
                      <% else %>
                        <%= link_to new_polymorphic_path(entity_class, document_entity: entity.id), class: 'inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg text-white hover:opacity-90 transition', style: "background-color: #{entity_class.hex_color}" do %>
                          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                          </svg>
                          Create <%= entity_class.name %>
                        <% end %>
                        <%= link_to '#', class: 'inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500 transition js-link-entity', data: { id: entity.id } do %>
                          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3.9,12C3.9,10.29 5.29,8.9 7,8.9H11V7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 3.9,13.71 3.9,12M8,13H16V11H8V13M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.71 18.71,15.1 17,15.1H13V17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7Z" />
                          </svg>
                          Link existing
                        <% end %>
                      <% end %>
                      <%= link_to destroy_entity_document_path(entity), class: 'inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 transition', data: { confirm: 'Remove this entity from the analysis?' } do %>
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                        </svg>
                        Remove
                      <% end %>
                    </div>
                  </div>
                </details>

                <script type="text/javascript">
                  $(document).ready(function () {
                    var data = [
                      [
                        { axis: "Joy",     value: <%= (100 * (entity.joy_score.presence || 0)).round(1) %> },
                        { axis: "Sadness", value: <%= (100 * (entity.sadness_score.presence || 0)).round(1) %> },
                        { axis: "Fear",    value: <%= (100 * (entity.fear_score.presence || 0)).round(1) %> },
                        { axis: "Disgust", value: <%= (100 * (entity.disgust_score.presence || 0)).round(1) %> },
                        { axis: "Anger",   value: <%= (100 * (entity.anger_score.presence || 0)).round(1) %> }
                      ]
                    ];
                    RadarChart("#graph-character-emotions-<%= entity.id %>", data, radarChartOptions);
                  });
                </script>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- Add Entity Card -->
    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <div class="flex-1">
          <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100">Missing an entity?</h4>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Link a page from your universe that wasn't automatically detected.</p>
        </div>
        <%= link_to '#', class: 'inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition js-link-entity', data: { id: -1 } do %>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
          </svg>
          Link a page
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Entity Link Modal -->
<div id="entity-link-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="$('#entity-link-modal').addClass('hidden')"></div>

    <div class="relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Link an existing page</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Connect a detected entity to a page you've already created.</p>
        </div>
        <button type="button" class="modal-close text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
          </svg>
        </button>
      </div>

      <div class="p-6 max-h-96 overflow-y-auto">
        <%= form_with url: link_entity_documents_path do |f| %>
          <%= f.hidden_field :document_id, value: analysis.document_id %>
          <%= f.hidden_field :document_analysis_id, value: analysis.id %>
          <%= f.hidden_field :entity_type, value: nil %>
          <%= f.hidden_field :entity_id, value: nil %>
          <%= f.hidden_field :document_entity_id, value: nil %>

          <% @current_user_content.each do |content_type, content_list| %>
            <% content_type_class = content_class_from_name(content_type) %>
            <% next if content_type == 'Document' %>

            <div class="mb-6 last:mb-0">
              <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full" style="background-color: <%= content_type_class.hex_color %>"></span>
                <%= content_type.pluralize %>
              </h4>

              <div class="space-y-1">
                <% content_list.each do |content| %>
                  <a href="#"
                     class="js-link-entity-selection flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition group"
                     data-id="<%= content.id %>"
                     data-type="<%= content_type %>">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: <%= content_type_class.hex_color %>20">
                        <svg class="w-4 h-4" style="color: <%= content_type_class.hex_color %>" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                        </svg>
                      </div>
                      <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= content.name %></span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 opacity-0 group-hover:opacity-100 transition" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
                    </svg>
                  </a>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function () {
    $('.js-link-entity').click(function () {
      $('#entity-link-modal').find('input[name=document_entity_id]').val($(this).data('id'));
      $('#entity-link-modal').removeClass('hidden');
      return false;
    });

    $('.modal-close').click(function () {
      $('#entity-link-modal').addClass('hidden');
      return false;
    });

    $('.js-link-entity-selection').click(function () {
      var entity = $(this);
      var form = $(this).closest('form');
      form.find('input[name=entity_id]').val(entity.data('id'));
      form.find('input[name=entity_type]').val(entity.data('type'));
      form.submit();
      return false;
    });
  });
</script>
