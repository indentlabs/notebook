<style>
  /* Subtle scrollbar styling */
  .styled-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .styled-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .styled-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }

  .styled-scrollbar:hover::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.8);
  }

  /* Firefox scrollbar styling */
  .styled-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }

  .styled-scrollbar:hover {
    scrollbar-color: rgba(156, 163, 175, 0.8) transparent;
  }
</style>

<div x-data="documentsIndexController()"
     x-init="init()"
     class="min-h-screen bg-gray-50 dark:bg-gray-900">

  <!-- Three Column Layout -->
  <div class="flex min-h-screen"> <!-- Natural height with sticky sidebars -->
    
    <!-- Left Column - Navigation (Desktop) -->
    <div x-show="showLeftSidebar && isDesktop" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         class="hidden lg:block w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 h-screen sticky top-0 overflow-y-auto styled-scrollbar">

      <!-- Desktop Header with Title and Toggle Button -->
      <div class="hidden lg:flex items-center justify-end p-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <button @click="toggleLeftSidebar()"
                class="flex items-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors p-1.5"
                title="Hide Quick Access"
                aria-label="Hide Quick Access">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_left</i>
          <i class="material-icons text-gray-600 dark:text-gray-300 text-lg mr-1.5">bolt</i>
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Quick Access</h2>
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="space-y-2">
          <%= link_to new_document_path(folder: @current_folder&.id),
              class: "flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-lg #{Document.color} text-white hover:opacity-90 transition-opacity" do %>
            <span class="flex items-center">
              <i class="material-icons text-sm mr-2"><%= Document.icon %></i>
              New Document
            </span>
            <i class="material-icons text-sm">add</i>
          <% end %>
          <button @click="showNewFolderModal = true"
              class="flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-lg <%= Folder.color %> text-white hover:opacity-90 transition-opacity">
            <span class="flex items-center">
              <i class="material-icons text-sm mr-2"><%= Folder.icon %></i>
              New Folder
            </span>
            <i class="material-icons text-sm">add</i>
          </button>
        </div>
      </div>

      <!-- Recent Documents -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="material-icons text-purple-500 text-sm mr-1">history</i>
            Recent Documents
          </h3>
          <%= link_to new_document_path(folder: @current_folder&.id), class: "p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors", title: "New Document" do %>
            <i class="material-icons text-sm">add</i>
          <% end %>
        </div>
        <% if @recent_documents.any? %>
          <div class="space-y-1">
            <% @recent_documents.first(7).each do |document| %>
              <%= link_to edit_document_path(document), class: "block group" do %>
                <div class="px-2 py-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                  <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                      <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:<%= Document.text_color %>">
                        <%= document.title %>
                      </h4>
                      <div class="flex items-center mt-1 text-xs text-gray-500 dark:text-gray-400">
                        <span><%= number_with_delimiter(document.cached_word_count || 0) %> words</span>
                        <span class="mx-1">•</span>
                        <span><%= time_ago_in_words(document.updated_at) %> ago</span>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No recent documents</p>
        <% end %>
      </div>
      
      <!-- Frequent Folders -->
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="material-icons <%= Folder.text_color %> text-sm mr-1">folder_special</i>
            Frequent Folders
          </h3>
          <button
            @click="showNewFolderModal = true"
            class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
            title="New Folder">
            <i class="material-icons text-sm">add</i>
          </button>
        </div>
        <% if @frequent_folders.any? %>
          <div class="space-y-2">
            <% @frequent_folders.each do |folder| %>
              <%= link_to folder_path(folder), class: "block group" do %>
                <div class="p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center">
                  <i class="material-icons <%= Folder.text_color %> text-sm mr-2">folder</i>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400">
                      <%= folder.title %>
                    </h4>
                  </div>
                  <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                    <%= folder.documents.count %> docs
                  </span>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No folders yet</p>
        <% end %>
      </div>
    </div>

    <!-- Mobile/Tablet Left Sidebar Overlay -->
    <div x-show="showLeftSidebar && !isDesktop" x-cloak
         x-transition:enter="transition-opacity ease-linear duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="showLeftSidebar = false"
         class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40">
    </div>

    <!-- Mobile/Tablet Left Sidebar -->
    <div x-show="showLeftSidebar && !isDesktop" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transform transition ease-in-out duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="-translate-x-full"
         class="lg:hidden fixed left-0 top-0 h-full w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-xl z-50 overflow-y-auto styled-scrollbar">
      
      <!-- Sidebar Header -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <button @click="showLeftSidebar = false"
                class="flex items-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors p-1.5 -ml-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Close Quick Access">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_left</i>
          <i class="material-icons text-gray-600 dark:text-gray-300 text-lg mr-1.5">bolt</i>
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Quick Access</h2>
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="space-y-2">
          <%= link_to new_document_path(folder: @current_folder&.id),
              class: "flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-lg #{Document.color} text-white hover:opacity-90 transition-opacity" do %>
            <span class="flex items-center">
              <i class="material-icons text-sm mr-2"><%= Document.icon %></i>
              New Document
            </span>
            <i class="material-icons text-sm">add</i>
          <% end %>
          <button @click="showNewFolderModal = true"
              class="flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-lg <%= Folder.color %> text-white hover:opacity-90 transition-opacity">
            <span class="flex items-center">
              <i class="material-icons text-sm mr-2"><%= Folder.icon %></i>
              New Folder
            </span>
            <i class="material-icons text-sm">add</i>
          </button>
        </div>
      </div>

      <!-- Recent Documents -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="material-icons text-purple-500 text-sm mr-1">history</i>
            Recent Documents
          </h3>
          <%= link_to new_document_path(folder: @current_folder&.id), class: "p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors", title: "New Document" do %>
            <i class="material-icons text-sm">add</i>
          <% end %>
        </div>
        <% if @recent_documents.any? %>
          <div class="space-y-1">
            <% @recent_documents.first(7).each do |document| %>
              <%= link_to edit_document_path(document), class: "block group" do %>
                <div class="px-2 py-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                  <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                      <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:<%= Document.text_color %>">
                        <%= document.title %>
                      </h4>
                      <div class="flex items-center mt-1 text-xs text-gray-500 dark:text-gray-400">
                        <span><%= number_with_delimiter(document.cached_word_count || 0) %> words</span>
                        <span class="mx-1">•</span>
                        <span><%= time_ago_in_words(document.updated_at) %> ago</span>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No recent documents</p>
        <% end %>
      </div>
      
      <!-- Frequent Folders -->
      <div class="p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="material-icons <%= Folder.text_color %> text-sm mr-1">folder_special</i>
            Frequent Folders
          </h3>
          <button
            @click="showNewFolderModal = true"
            class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors"
            title="New Folder">
            <i class="material-icons text-sm">add</i>
          </button>
        </div>
        <% if @frequent_folders.any? %>
          <div class="space-y-2">
            <% @frequent_folders.each do |folder| %>
              <%= link_to folder_path(folder), class: "block group" do %>
                <div class="p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center">
                  <i class="material-icons <%= Folder.text_color %> text-sm mr-2">folder</i>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400">
                      <%= folder.title %>
                    </h4>
                  </div>
                  <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                    <%= folder.documents.count %> docs
                  </span>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500 italic">No folders yet</p>
        <% end %>
      </div>
    </div>

    <!-- Desktop Collapsed Left Sidebar Toggle Tab -->
    <div x-show="!showLeftSidebar && isDesktop" x-cloak
         style="top: 132px;"
         class="hidden lg:block fixed z-40 transition-all duration-300">
      <button @click="toggleLeftSidebar()"
              class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-r-md shadow-lg transition-all duration-300 flex items-center gap-1 tooltip-right"
              data-tooltip="Show Quick Access"
              aria-label="Show Quick Access">
        <i class="material-icons text-base">bolt</i>
        <i class="material-icons text-base">chevron_right</i>
      </button>
    </div>

    <!-- Mobile/Tablet Left Sidebar Toggle Tab -->
    <div class="lg:hidden fixed z-30"
         style="top: 132px;">
      <button @click="toggleLeftSidebar()"
              @keydown.escape="showLeftSidebar && toggleLeftSidebar()"
              class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-r-md shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1 tooltip-right"
              :data-tooltip="showLeftSidebar ? 'Hide Quick Access' : 'Show Quick Access'"
              :aria-label="showLeftSidebar ? 'Close Quick Access' : 'Open Quick Access'"
              :aria-expanded="showLeftSidebar">
        <i class="material-icons text-base" x-show="!showLeftSidebar">bolt</i>
        <i class="material-icons text-base" x-show="!showLeftSidebar">chevron_right</i>
        <i class="material-icons text-base" x-show="showLeftSidebar">chevron_left</i>
      </button>
    </div>
    
    <!-- Main Content Area -->
    <main class="flex-1 min-w-0 flex flex-col">
      <!-- Header -->
      <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <!-- Breadcrumb Navigation (if in folder) -->
        <% if @current_folder %>
          <div class="px-8 sm:px-16 pt-3 pb-2 border-b border-gray-100 dark:border-gray-700">
            <nav class="flex items-center space-x-2 text-sm">
              <%= link_to documents_path, class: "text-gray-500 hover:text-gray-700 transition-colors" do %>
                <i class="material-icons text-sm">folder</i>
                <span>Documents</span>
              <% end %>
              <% if @current_folder.parent_folder %>
                <span class="text-gray-400 dark:text-gray-500">/</span>
                <%= link_to @current_folder.parent_folder.title, folder_path(@current_folder.parent_folder),
                    class: "text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors" %>
              <% end %>
              <span class="text-gray-400 dark:text-gray-500">/</span>
              <span class="text-gray-900 dark:text-white font-medium"><%= @current_folder.title %></span>
            </nav>
          </div>
        <% end %>

        <div class="px-8 sm:px-16 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 sm:space-x-4">

              <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
                <%= @current_folder ? @current_folder.title : 'Documents' %>
                <% if params[:q].present? %>
                  <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">
                    - Searching for "<%= params[:q] %>"
                  </span>
                <% end %>
              </h1>
            </div>

            <div class="flex items-center space-x-2">
              <!-- Edit Folder Button (when in folder context) -->
              <% if @current_folder %>
                <button
                  @click="showEditFolderModal = true"
                  class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                  title="Edit folder"
                >
                  <i class="material-icons">edit</i>
                </button>
              <% end %>


            </div>
          </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="px-4 sm:px-6 pb-4 flex flex-wrap items-center gap-3">
          <!-- Search -->
          <div class="relative flex-grow min-w-[140px]">
            <input
              x-model="searchQuery"
              type="text"
              placeholder="Filter current view..."
              class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
            />
            <i class="material-icons absolute left-3 top-2.5 text-gray-400 text-sm">search</i>
          </div>
          
          <div class="flex items-center gap-3 flex-shrink-0">
            <!-- View Toggle -->
            <div class="flex border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 shadow-sm">
              <button @click="viewMode = 'list'; localStorage.setItem('documentsViewMode', 'list')" :class="viewMode === 'list' ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="p-2 rounded-l-lg" title="List View">
                <i class="material-icons text-sm">view_list</i>
              </button>
              <button @click="viewMode = 'timeline'; localStorage.setItem('documentsViewMode', 'timeline')" :class="viewMode === 'timeline' ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="p-2 rounded-r-lg" title="Timeline View">
                <i class="material-icons text-sm">timeline</i>
              </button>
            </div>
          </div>

          <!-- Filter Controls with Responsive Behavior -->
          <div class="flex items-center gap-1.5 flex-shrink-0">
            <!-- Compact Filters Dropdown (shown when very tight on space) -->
            <div class="relative lg:hidden" x-data="{ open: false }" @click.away="open = false">
              <button @click="open = !open"
                      class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-lg bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 <%= (params[:tag].present? || params[:favorite_only].present?) ? 'text-blue-700 dark:text-blue-400 border-blue-300 dark:border-blue-500 bg-blue-50 dark:bg-blue-900/30' : 'text-gray-700 dark:text-gray-300' %>">
                <i class="material-icons text-sm">filter_list</i>
                <span class="ml-1.5">Filters</span>
                <% active_filters = 0 %>
                <% active_filters += 1 if params[:tag].present? %>
                <% active_filters += 1 if params[:favorite_only].present? %>
                <% if active_filters > 0 %>
                  <span class="ml-1.5 px-1.5 py-0.5 text-xs bg-blue-600 text-white rounded-full"><%= active_filters %></span>
                <% end %>
              </button>
              <div x-show="open"
                   x-transition:enter="transition ease-out duration-100"
                   x-transition:enter-start="opacity-0 transform scale-95"
                   x-transition:enter-end="opacity-100 transform scale-100"
                   class="absolute left-0 mt-2 w-64 rounded-lg shadow-lg py-2 bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-10">
                <!-- Tag Filter in Dropdown -->
                <div class="px-3 py-2 border-b border-gray-100 dark:border-gray-700">
                  <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1">Tag</div>
                  <select onchange="window.location.href = this.value" class="w-full text-sm border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="<%= documents_path(params.permit(:favorite_only)) %>" <%= !params[:tag].present? ? 'selected' : '' %>>
                      All Tags
                    </option>
                    <% @page_tags.each do |page_tag| %>
                      <option value="<%= documents_path(params.permit(:favorite_only).merge(tag: page_tag.slug)) %>" <%= params[:tag] == page_tag.slug ? 'selected' : '' %>>
                        <%= page_tag.tag %>
                      </option>
                    <% end %>
                  </select>
                </div>
                <!-- Favorites Toggle in Dropdown -->
                <div class="px-3 py-2">
                  <% if params[:favorite_only].present? %>
                    <%= link_to documents_path(params.permit(:tag)),
                                class: "block w-full text-center px-3 py-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 rounded-md hover:bg-yellow-100 dark:hover:bg-yellow-900/50 text-sm font-medium" do %>
                      <i class="material-icons text-sm align-middle">star</i>
                      <span class="ml-1">Showing Favorites</span>
                    <% end %>
                  <% else %>
                    <%= link_to documents_path(params.permit(:tag).merge(favorite_only: true)),
                                class: "block w-full text-center px-3 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm font-medium" do %>
                      <i class="material-icons text-sm align-middle">star_outline</i>
                      <span class="ml-1">Show Favorites</span>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Individual Filter Buttons (shown on larger screens) -->
            <div class="hidden lg:flex items-center gap-1.5">
              <!-- Tag Filter Dropdown -->
              <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <button @click="open = !open"
                        class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded-lg bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 <%= params[:tag].present? ? 'text-blue-700 dark:text-blue-400 border-blue-300 dark:border-blue-500 bg-blue-50 dark:bg-blue-900/30' : 'text-gray-700 dark:text-gray-300' %>"
                        title="Filter by tag">
                  <i class="material-icons text-sm">label</i>
                  <span class="hidden xl:inline ml-1 max-w-[120px] truncate">
                    <% if params[:tag].present? %>
                      <%= @page_tags.find { |t| t.slug == params[:tag] }&.tag || 'Tag' %>
                    <% else %>
                      All Tags
                    <% end %>
                  </span>
                  <i class="material-icons text-xs ml-0.5">arrow_drop_down</i>
                </button>
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:enter-start="opacity-0 transform scale-95"
                     x-transition:enter-end="opacity-100 transform scale-100"
                     class="absolute right-0 mt-2 w-56 rounded-lg shadow-lg py-1 bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-10 max-h-64 overflow-y-auto">
                  <%= link_to documents_path(params.permit(:favorite_only)),
                              class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 #{!params[:tag].present? ? 'font-medium bg-gray-50 dark:bg-gray-700' : ''}" do %>
                    <% if !params[:tag].present? %>
                      <i class="material-icons text-xs mr-1 align-middle">check</i>
                    <% end %>
                    All Tags
                  <% end %>
                  <% if @page_tags.any? %>
                    <div class="border-t border-gray-100"></div>
                    <% @page_tags.each do |page_tag| %>
                      <%= link_to documents_path(params.permit(:favorite_only).merge(tag: page_tag.slug)),
                                  class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 #{params[:tag] == page_tag.slug ? 'font-medium bg-gray-50 dark:bg-gray-700' : ''}" do %>
                        <% if params[:tag] == page_tag.slug %>
                          <i class="material-icons text-xs mr-1 align-middle">check</i>
                        <% end %>
                        <%= page_tag.tag %>
                      <% end %>
                    <% end %>
                  <% else %>
                    <div class="px-4 py-3 text-sm text-gray-500 italic">
                      No tags available
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Favorite Toggle -->
              <% if params[:favorite_only].present? %>
                <%= link_to documents_path(params.permit(:tag)),
                            class: "inline-flex items-center px-2.5 py-1.5 border border-yellow-300 dark:border-yellow-600 text-xs font-medium rounded-lg text-yellow-700 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/30 hover:bg-yellow-100 dark:hover:bg-yellow-900/50",
                            title: "Showing favorites only. Click to show all." do %>
                  <i class="material-icons text-sm">star</i>
                  <span class="hidden 2xl:inline ml-1">Favorites</span>
                <% end %>
              <% else %>
                <%= link_to documents_path(params.permit(:tag).merge(favorite_only: true)),
                            class: "inline-flex items-center px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",
                            title: "Show favorites only" do %>
                  <i class="material-icons text-sm">star_outline</i>
                  <span class="hidden 2xl:inline ml-1">Favorites</span>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div :class="(showLeftSidebar && showRightSidebar && isDesktop) ? 'px-4 py-4' : 'px-8 sm:px-16 py-4 sm:py-6'">
        <% if @folders.any? || @documents.any? %>
          <!-- Timeline View -->
          <div x-show="viewMode === 'timeline'" style="display: none;" class="space-y-8" x-transition>
            <% if @documents.any? %>
              <%
                # Group documents by date
                documents_by_date = @documents.group_by { |d| d.updated_at.to_date }.sort_by(&:first).reverse
              %>
              <div class="relative">
                <!-- Timeline line -->
                <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-300 dark:bg-gray-700"></div>

                <% documents_by_date.each do |date, docs| %>
                  <div class="mb-8">
                    <!-- Date marker -->
                    <div class="flex items-center mb-4">
                      <div class="bg-white dark:bg-gray-900 border-4 border-indigo-500 rounded-full w-4 h-4 absolute left-6"></div>
                      <div class="ml-12">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                          <%= date.strftime('%B %d, %Y') %>
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                          <%= docs.count %> <%= 'document'.pluralize(docs.count) %> updated
                        </p>
                      </div>
                    </div>

                    <!-- Documents for this date -->
                    <div class="ml-12 space-y-3">
                      <% docs.sort_by(&:updated_at).reverse.each do |document| %>
                        <%
                          time_str = document.updated_at.strftime('%l:%M %p').strip
                          preview_text = if document.body.present?
                            ActionController::Base.helpers.strip_tags(document.body).truncate(150, separator: ' ')
                          else
                            "No content yet..."
                          end
                        %>
                        <div x-show="searchQuery === '' || '<%= document.title.downcase %>'.includes(searchQuery.toLowerCase())">
                          <%= link_to edit_document_path(document), class: "block group" do %>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 p-5 border border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500">
                              <div class="flex items-start justify-between">
                                <div class="flex-1">
                                  <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-xs text-gray-500 dark:text-gray-400 font-medium"><%= time_str %></span>
                                    <% if document.folder %>
                                      <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                                        <i class="material-icons text-xs mr-1" style="font-size: 10px;">folder</i>
                                        <%= document.folder.title %>
                                      </span>
                                    <% end %>
                                  </div>
                                  <h4 class="font-semibold text-gray-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors mb-2">
                                    <%= document.title %>
                                  </h4>
                                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">
                                    <%= preview_text %>
                                  </p>
                                  <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center">
                                      <i class="material-icons text-xs mr-1">edit</i>
                                      <%= number_with_delimiter(document.cached_word_count || 0) %> words
                                    </span>
                                    <% if document.cached_word_count && document.cached_word_count > 0 %>
                                      <span class="flex items-center">
                                        <i class="material-icons text-xs mr-1">schedule</i>
                                        <%= ((document.cached_word_count || 0) / 200.0).ceil %> min read
                                      </span>
                                    <% end %>
                                  </div>
                                </div>
                                <i class="material-icons text-gray-400 group-hover:text-indigo-600 ml-4">chevron_right</i>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-12">
                <i class="material-icons text-gray-400 text-5xl mb-4">timeline</i>
                <p class="text-gray-500">No documents in your timeline yet</p>
              </div>
            <% end %>
          </div>

          <!-- List View -->
          <div x-show="viewMode === 'list'" class="space-y-6">
            <!-- No results message -->
            <template x-if="searchQuery && !Array.from(document.querySelectorAll('[x-show*=searchQuery]')).some(el => el.style.display !== 'none')">
              <div class="text-center py-12">
                <i class="material-icons text-gray-400 text-5xl mb-4">search_off</i>
                <p class="text-gray-500">No documents or folders match "<span x-text="searchQuery"></span>"</p>
                <button @click="searchQuery = ''" class="mt-4 text-sm text-blue-600 hover:text-blue-800">Clear filter</button>
              </div>
            </template>

            <!-- Folders Section -->
            <% if @folders.any? %>
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Folders</h3>
                  <button
                    @click="showNewFolderModal = true"
                    class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-lg <%= Folder.color %> text-white hover:opacity-90 transition-opacity">
                    <i class="material-icons text-xs mr-1">add</i>
                    New
                  </button>
                </div>
                <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md border border-gray-200 dark:border-gray-700">
                  <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                    <% @folders.each do |folder| %>
                      <li x-show="searchQuery === '' || '<%= folder.title.downcase %>'.includes(searchQuery.toLowerCase())"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100">
                        <%= link_to folder_path(folder), class: "block hover:bg-gray-50 dark:hover:bg-gray-700" do %>
                          <div class="px-4 py-4 flex items-center sm:px-6">
                            <div class="min-w-0 flex-1 sm:flex sm:items-center sm:justify-between">
                              <div class="flex items-center">
                                <div class="<%= Folder.color %> rounded-lg p-2 mr-3 shadow-sm">
                                  <i class="material-icons text-white text-xl"><%= Folder.icon %></i>
                                </div>
                                <div>
                                  <div class="text-sm font-medium text-gray-900 dark:text-white"><%= folder.title %></div>
                                  <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    <% if folder.documents.count > 0 %>
                                      <%= folder.documents.count %> <%= 'document'.pluralize(folder.documents.count) %>
                                    <% else %>
                                      Empty folder
                                    <% end %>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="ml-5 flex-shrink-0">
                              <i class="material-icons text-gray-400">chevron_right</i>
                            </div>
                          </div>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
            
            <!-- Documents Section -->
            <% if @documents.any? %>
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Documents</h3>
                  <%= link_to new_document_path(folder: @current_folder&.id), class: "inline-flex items-center px-3 py-1 text-xs font-medium rounded-lg #{Document.color} text-white hover:opacity-90 transition-opacity" do %>
                    <i class="material-icons text-xs mr-1">add</i>
                    New
                  <% end %>
                </div>
                <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md border border-gray-200 dark:border-gray-700">
                  <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                    <% @documents.each do |document| %>
                      <li x-show="searchQuery === '' || '<%= document.title.downcase %>'.includes(searchQuery.toLowerCase())"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100"
                          x-data="{ isFavorite: <%= document.favorite? %>, isLoading: false, async toggleFavorite(event) { event.preventDefault(); event.stopPropagation(); this.isLoading = true; try { const result = await window.toggleDocumentFavorite('<%= document.id %>'); if (result.success) { this.isFavorite = !this.isFavorite; if (window.showToast) window.showToast(this.isFavorite ? 'Added to favorites' : 'Removed from favorites', 'success'); } else { if (window.showToast) window.showToast('Error toggling favorite', 'error'); } } catch (error) { console.error('Error:', error); if (window.showToast) window.showToast('An unexpected error occurred', 'error'); } finally { this.isLoading = false; } } }">
                        <%= link_to edit_document_path(document), class: "block hover:bg-gray-50 dark:hover:bg-gray-700 group" do %>
                          <div class="relative px-4 py-3 flex items-center">
                            <!-- Document icon -->
                            <div class="flex-shrink-0 mr-3">
                              <i class="material-icons <%= Document.text_color %> text-lg">description</i>
                            </div>
                            
                            <!-- Document info -->
                            <div class="min-w-0 flex-1">
                              <h3 class="text-sm font-medium text-gray-900 dark:text-white truncate"><%= document.title %></h3>
                              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                <%= number_with_delimiter(document.cached_word_count || 0) %> words · edited <%= time_ago_in_words(document.updated_at) %> ago
                              </p>
                            </div>
                            
                            <!-- Favorite Toggle Button -->
                            <button
                              @click="toggleFavorite"
                              :disabled="isLoading"
                              class="ml-2 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                              :class="{ 'opacity-50 cursor-not-allowed': isLoading }"
                              title="Toggle favorite"
                            >
                              <i class="material-icons text-xl" :class="isFavorite ? 'text-yellow-400' : 'text-gray-400'" x-text="isFavorite ? 'star' : 'star_outline'"></i>
                            </button>
                            
                            <!-- Chevron -->
                            <div class="ml-2 flex-shrink-0">
                              <i class="material-icons text-gray-400 text-lg">chevron_right</i>
                            </div>
                          </div>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <!-- Empty State -->
          <div class="flex items-center justify-center h-full">
            <div class="text-center max-w-lg">
              <div class="mx-auto h-24 w-24 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-700 flex items-center justify-center mb-6 shadow-sm">
                <i class="material-icons text-4xl text-gray-400 dark:text-gray-500">folder_open</i>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Welcome to Documents</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-8">Start organizing your work by creating folders and documents.</p>
              <div class="flex justify-center space-x-3">
                <button @click="showNewFolderModal = true" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                  <i class="material-icons mr-2 text-sm">create_new_folder</i>
                  Create Folder
                </button>
                <%= link_to new_document_path(folder: @current_folder&.id), class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700" do %>
                  <i class="material-icons mr-2 text-sm">add</i>
                  Create Document
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </main>
    
    <!-- Right Sidebar - Writing Stats -->
    <!-- Right Column - Desktop (Toggleable) -->
    <div x-show="showRightSidebar" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         class="hidden lg:block w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-shrink-0 h-screen sticky top-0 overflow-y-auto styled-scrollbar">

      <!-- Desktop Header with Title and Toggle Button -->
      <div class="hidden lg:flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <button @click="toggleRightSidebar()"
                class="flex items-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors p-1.5 -ml-1.5"
                title="Hide writing stats"
                aria-label="Hide writing stats">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_right</i>
          <i class="material-icons text-gray-600 dark:text-gray-300 text-lg mr-1.5">insights</i>
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Writing Stats</h2>
        </button>
      </div>
      
      <!-- Overall Stats -->
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Overall Statistics</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Documents</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= number_with_delimiter(@documents.count) %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Folders</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= @folders.count %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Total Words</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= number_with_delimiter(@documents.map(&:cached_word_count).compact.sum) %></span>
          </div>
        </div>

        <!-- Data Vault Link Card -->
        <%= link_to data_documents_path, class: "block group mt-4 -mx-4" do %>
          <div class="bg-amber-900 rounded-lg px-4 py-2 hover:bg-amber-800 transition-colors">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <i class="material-icons text-white text-lg">analytics</i>
                <span class="text-xs font-medium text-white">More statistics in your Data Vault</span>
              </div>
              <i class="material-icons text-white text-lg group-hover:translate-x-1 transition-transform">arrow_forward</i>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Document Writing Streak -->
      <div class="p-6">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
          <i class="material-icons text-orange-500 text-sm mr-1">whatshot</i>
          Writing Streak
        </h3>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-7 gap-1 mb-2">
            <%
              # Batch fetch words written for last 7 days in a single query
              streak_dates = (0..6).map { |days_ago| Date.current - days_ago }
              words_by_date = WordCountUpdate.words_written_on_dates(current_user, streak_dates)

              streak_dates.reverse.each do |date|
                words_for_day = words_by_date[date] || 0

                # Determine opacity based on word count
                opacity_class = if words_for_day >= 1000
                  "bg-green-600 dark:bg-green-500"
                elsif words_for_day >= 500
                  "bg-green-400 dark:bg-green-600"
                elsif words_for_day >= 100
                  "bg-green-300 dark:bg-green-700"
                elsif words_for_day > 0
                  "bg-green-200 dark:bg-green-800"
                else
                  "bg-gray-200 dark:bg-gray-600"
                end

                is_today = date == Date.current
            %>
              <div class="relative group">
                <div class="aspect-square <%= opacity_class %> rounded-sm <%= is_today ? 'ring-1 ring-gray-400 dark:ring-gray-500' : '' %> transition-colors hover:opacity-80"
                     title="<%= date.strftime('%b %d') %>: <%= number_with_delimiter(words_for_day) %> words"></div>
                <div class="text-center mt-0.5">
                  <span class="text-xs text-gray-400 dark:text-gray-500"><%= date.strftime('%a')[0] %></span>
                </div>
              </div>
            <% end %>
          </div>
          <div class="pt-2 border-t border-gray-200 dark:border-gray-600">
            <div class="flex justify-between items-baseline">
              <div class="text-xs text-gray-600 dark:text-gray-400">
                Today: <span class="font-medium <%= @words_written_today > 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500' %>"><%= number_with_delimiter(@words_written_today) %></span>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400">
                Week: <span class="font-medium text-gray-700 dark:text-gray-300"><%= number_with_delimiter(@words_written_this_week) %></span>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Words counted across all documents and notebook pages.</p>
        </div>
      </div>
    </div>

    <!-- Desktop Collapsed Toggle Tab -->
    <div x-show="!showRightSidebar && isDesktop" x-cloak
         class="hidden lg:block fixed right-0 z-40"
         style="top: 132px;">
      <button @click="toggleRightSidebar()"
              class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 flex items-center gap-1 tooltip-left"
              data-tooltip="Show Writing Stats"
              aria-label="Show Writing Stats">
        <i class="material-icons text-base">chevron_left</i>
        <i class="material-icons text-base">insights</i>
      </button>
    </div>

    <!-- Mobile/Tablet Right Sidebar Toggle Tab -->
    <div class="lg:hidden fixed right-0 z-40"
         style="top: 116px;">
      <button @click="toggleRightSidebar()"
              @keydown.escape="showRightSidebar && toggleRightSidebar()"
              class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1 tooltip-left"
              :data-tooltip="showRightSidebar ? 'Hide Writing Stats' : 'Show Writing Stats'"
              :aria-label="showRightSidebar ? 'Close writing stats' : 'Open writing stats'"
              :aria-expanded="showRightSidebar">
        <i class="material-icons text-base" x-show="!showRightSidebar">insights</i>
        <i class="material-icons text-base" x-show="!showRightSidebar">chevron_left</i>
        <i class="material-icons text-base" x-show="showRightSidebar">chevron_right</i>
      </button>
    </div>

    <!-- Mobile/Tablet Right Sidebar Overlay -->
    <div x-show="showRightSidebar" x-cloak
         x-transition:enter="transition-opacity ease-linear duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="closeMobileSidebar()"
         @keydown.escape.window="closeMobileSidebar()"
         class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-50">
    </div>

    <!-- Mobile/Tablet Right Sidebar -->
    <div x-show="showRightSidebar" x-cloak
         x-transition:enter="transform transition ease-in-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transform transition ease-in-out duration-200"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         @keydown.escape="closeMobileSidebar()"
         class="lg:hidden fixed right-0 top-0 h-full w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-xl z-50 overflow-y-auto styled-scrollbar">

      <!-- Close button -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <button @click="closeMobileSidebar()"
                class="flex items-center hover:bg-gray-100 rounded-lg transition-colors p-1.5 -ml-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label="Close writing stats">
          <i class="material-icons text-gray-500 dark:text-gray-400 text-lg mr-1">chevron_right</i>
          <i class="material-icons text-gray-600 dark:text-gray-300 text-lg mr-1.5">insights</i>
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Writing Stats</h2>
        </button>
      </div>
      
      <!-- Overall Stats -->
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Overall Statistics</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Documents</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= number_with_delimiter(@documents.count) %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Folders</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= @folders.count %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-600 dark:text-gray-400">Total Words</span>
            <span class="text-sm font-medium text-gray-900 dark:text-white"><%= number_with_delimiter(@documents.map(&:cached_word_count).compact.sum) %></span>
          </div>
        </div>

        <!-- Data Vault Link Card -->
        <%= link_to data_documents_path, class: "block group mt-4 -mx-4" do %>
          <div class="bg-amber-900 rounded-lg px-4 py-2 hover:bg-amber-800 transition-colors">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <i class="material-icons text-white text-lg">analytics</i>
                <span class="text-xs font-medium text-white">More statistics in your Data Vault</span>
              </div>
              <i class="material-icons text-white text-lg group-hover:translate-x-1 transition-transform">arrow_forward</i>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Document Writing Streak -->
      <div class="p-6">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
          <i class="material-icons text-orange-500 text-sm mr-1">whatshot</i>
          Writing Streak
        </h3>
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-7 gap-1 mb-2">
            <%
              # Batch fetch words written for last 7 days in a single query
              streak_dates = (0..6).map { |days_ago| Date.current - days_ago }
              words_by_date = WordCountUpdate.words_written_on_dates(current_user, streak_dates)

              streak_dates.reverse.each do |date|
                words_for_day = words_by_date[date] || 0

                # Determine opacity based on word count
                opacity_class = if words_for_day >= 1000
                  "bg-green-600 dark:bg-green-500"
                elsif words_for_day >= 500
                  "bg-green-400 dark:bg-green-600"
                elsif words_for_day >= 100
                  "bg-green-300 dark:bg-green-700"
                elsif words_for_day > 0
                  "bg-green-200 dark:bg-green-800"
                else
                  "bg-gray-200 dark:bg-gray-600"
                end

                is_today = date == Date.current
            %>
              <div class="relative group">
                <div class="aspect-square <%= opacity_class %> rounded-sm <%= is_today ? 'ring-1 ring-gray-400 dark:ring-gray-500' : '' %> transition-colors hover:opacity-80"
                     title="<%= date.strftime('%b %d') %>: <%= number_with_delimiter(words_for_day) %> words"></div>
                <div class="text-center mt-0.5">
                  <span class="text-xs text-gray-400 dark:text-gray-500"><%= date.strftime('%a')[0] %></span>
                </div>
              </div>
            <% end %>
          </div>
          <div class="pt-2 border-t border-gray-200 dark:border-gray-600">
            <div class="flex justify-between items-baseline">
              <div class="text-xs text-gray-600 dark:text-gray-400">
                Today: <span class="font-medium <%= @words_written_today > 0 ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500' %>"><%= number_with_delimiter(@words_written_today) %></span>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400">
                Week: <span class="font-medium text-gray-700 dark:text-gray-300"><%= number_with_delimiter(@words_written_this_week) %></span>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Words counted across all documents and notebook pages.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- New Folder Modal -->
  <div x-show="showNewFolderModal" class="fixed z-50 inset-0" style="display: none;">
    <%= render partial: 'folders/tailwind_new_modal', locals: { content_type: Document, parent_folder: @current_folder } %>
  </div>

  <!-- Edit Folder Modal (only when in a folder context) -->
  <% if @current_folder %>
    <div x-show="showEditFolderModal" class="fixed z-50 inset-0" style="display: none;">
      <%= render partial: 'folders/tailwind_edit_modal', locals: { folder: @current_folder } %>
    </div>
  <% end %>
</div>

<script>
  // Toggle favorite function for documents
  window.toggleDocumentFavorite = async function(documentId) {
    const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
    const postUrl = `/documents/${documentId}/toggle_favorite`;
    
    try {
      const response = await fetch(postUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ id: documentId })
      });
      
      return { success: response.ok };
    } catch (error) {
      console.error('Fetch error:', error);
      throw error;
    }
  };

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    // CMD/Ctrl + K for global search
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      const searchInput = document.querySelector('input[x-model="globalSearchQuery"]');
      if (searchInput) {
        searchInput.focus();
        searchInput.select();
      }
    }
    
    // CMD/Ctrl + N for new document
    if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
      e.preventDefault();
      window.location.href = '<%= new_document_path(folder: @current_folder&.id) %>';
    }
  });
</script>

<script>
function documentsIndexController() {
  return {
    showNewFolderModal: false,
    showEditFolderModal: false,

    // Sidebar states
    showLeftSidebar: (() => {
      if (window.innerWidth >= 1024) {
        try {
          const saved = localStorage.getItem('documents_index_left_sidebar_visible');
          // Default to true only if user has documents
          return saved === null ? <%= @recent_documents.any? %> : saved === 'true';
        } catch (e) {
          return <%= @recent_documents.any? %>;
        }
      }
      return false;
    })(),
    showRightSidebar: false,

    // Breakpoint checks
    isDesktop: window.innerWidth >= 1024, // lg breakpoint for left sidebar (matching site sidebar)
    isXlDesktop: window.innerWidth >= 1024, // lg breakpoint for right sidebar (matching content#edit)
    
    // Other state
    mobileMenuOpen: false,
    viewMode: localStorage.getItem('documentsViewMode') || 'list',
    searchQuery: '',
    globalSearchQuery: '',
    isSearching: false,
    showFilters: false,
    selectedDate: 'all',
    selectedTags: [],

    init() {
      // Initialize right sidebar state
      this.initializeSidebarState();
      
      // Handle window resize
      window.addEventListener('resize', () => {
        // Left Sidebar Logic (lg breakpoint)
        const wasDesktop = this.isDesktop;
        this.isDesktop = window.innerWidth >= 1024;

        // When transitioning from mobile to desktop, restore saved left sidebar state
        if (!wasDesktop && this.isDesktop) {
          this.showLeftSidebar = this.getSavedSidebarState('left', <%= @recent_documents.any? %>);
        }
        // When transitioning from desktop to mobile, close left sidebar
        if (wasDesktop && !this.isDesktop) {
          this.showLeftSidebar = false;
        }
        // If staying on same breakpoint, don't touch the sidebar state (respect user's toggle)

        // Right Sidebar Logic (lg breakpoint)
        const wasXlDesktop = this.isXlDesktop;
        this.isXlDesktop = window.innerWidth >= 1024;

        // When transitioning from mobile to desktop (lg), restore saved right sidebar state
        if (!wasXlDesktop && this.isXlDesktop) {
          this.showRightSidebar = this.getSavedSidebarState('right', true);
        }
        // When transitioning from desktop (lg) to mobile, always close right sidebar
        if (wasXlDesktop && !this.isXlDesktop) {
          this.showRightSidebar = false;
        }
      });
    },
    
    initializeSidebarState() {
      if (this.isXlDesktop) {
        this.showRightSidebar = this.getSavedSidebarState('right', true);
      } else {
        this.showRightSidebar = false;
      }
    },

    getSavedSidebarState(side, defaultValue = true) {
      try {
        const saved = localStorage.getItem(`documents_index_${side}_sidebar_visible`);
        return saved === null ? defaultValue : saved === 'true';
      } catch (e) {
        return defaultValue;
      }
    },

    saveSidebarState(side, value) {
      try {
        localStorage.setItem(`documents_index_${side}_sidebar_visible`, value.toString());
      } catch (e) {}
    },

    toggleLeftSidebar() {
      this.showLeftSidebar = !this.showLeftSidebar;
      if (this.isDesktop) {
        this.saveSidebarState('left', this.showLeftSidebar);
      }
    },

    toggleRightSidebar() {
      this.showRightSidebar = !this.showRightSidebar;
      if (this.isXlDesktop) {
        this.saveSidebarState('right', this.showRightSidebar);
      }
    },

    closeMobileSidebar() {
      if (!this.isXlDesktop) {
        this.showRightSidebar = false;
      }
    }
  }
}
</script>