<div class="space-y-12">
  <% content.data[:categories].each do |category| %>
    <% next if category[:label] == 'Gallery' %>
    
    <div class="category-section" id="category-<%= category[:label].parameterize %>">
      <div class="pb-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <i class="material-icons text-2xl <%= content.class_text_color %> mr-3"><%= category[:icon] %></i>
            <h3 class="text-xl font-semibold text-gray-900"><%= category[:label] %></h3>
          </div>
          
          <!-- Progress indicator -->
          <% if category[:percent_complete].present? && category[:percent_complete] > 0 %>
            <div class="flex items-center space-x-3">
              <span class="text-sm text-gray-500"><%= category[:percent_complete] %>% complete</span>
              <div class="w-32 bg-gray-200 rounded-full h-2">
                <div class="<%= content.class_color %> h-2 rounded-full" style="width: <%= category[:percent_complete] %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <div class="mt-6 space-y-6">
        <% category[:fields].each do |field| %>
          <div class="sm:grid sm:grid-cols-4 sm:gap-4 sm:items-start" 
               data-field-id="<%= field[:id] %>" 
               data-field-type="<%= field[:type] %>">
            
            <!-- Field label -->
            <div class="sm:col-span-1">
              <label for="<%= field[:name] %>" class="block text-sm font-medium text-gray-700">
                <%= field[:label] %>
                <% if field[:required] %>
                  <span class="text-red-500 ml-1">*</span>
                <% end %>
              </label>
              
              <% if field[:help_text].present? %>
                <p class="mt-1 text-xs text-gray-500"><%= field[:help_text] %></p>
              <% end %>
            </div>
            
            <!-- Field input -->
            <div class="mt-1 sm:mt-0 sm:col-span-3 relative">
              <!-- Autosave status indicator -->
              <div class="absolute top-0 right-0 autosave-indicator opacity-0 transition-opacity duration-200 z-10">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  Saved
                </span>
              </div>
              
              <%= form_for raw_content, url: FieldTypeService.form_path(field), remote: true, authenticity_token: true, html: { class: "field-form" } do |f| %>
                <%= hidden_field_tag "entity[entity_id]",   raw_content.id %>
                <%= hidden_field_tag "entity[entity_type]", raw_content.class.name %>
                
                <%=
                  case field[:type]
                  when 'name', 'text_area', 'textarea'
                    render partial: 'content/form/rich_text_input', locals: {
                      f:            f, 
                      content:      content,
                      field:        field,
                      show_label:   false,
                      autocomplete: AutocompleteService.for_field_label(content_model: raw_content.class, label: field[:label]),
                      autosave:     true
                    }
                  when 'universe'
                    render partial: 'content/form/field_types/universe', locals: {
                      f:         f,
                      field:     field,
                      page:      content,
                      raw_model: raw_content
                    }
                  when 'tags'
                    render partial: 'content/form/field_types/tags', locals: {
                      f:         f,
                      field:     field,
                      page:      content,
                      raw_model: raw_content
                    }
                  when 'link'
                    render partial: 'content/form/field_types/link', locals: {
                      f:         f,
                      field:     field,
                      page:      content,
                      raw_model: raw_content
                    }
                  end
                %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<style>
.field-form input:focus,
.field-form textarea:focus {
  @apply ring-2 ring-blue-500 border-blue-500;
}

.field-form.saving input,
.field-form.saving textarea {
  @apply ring-2 ring-yellow-400 border-yellow-400;
}

.field-form.saved input,
.field-form.saved textarea {
  @apply ring-2 ring-green-400 border-green-400;
}

.field-form.error input,
.field-form.error textarea {
  @apply ring-2 ring-red-400 border-red-400;
}

.autosave-indicator.show {
  @apply opacity-100;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Enhanced autosave feedback
  document.addEventListener('autosave:start', function(e) {
    const form = e.target.closest('.field-form');
    if (form) {
      form.classList.add('saving');
      form.classList.remove('saved', 'error');
    }
  });
  
  document.addEventListener('autosave:success', function(e) {
    const form = e.target.closest('.field-form');
    if (form) {
      form.classList.add('saved');
      form.classList.remove('saving', 'error');
      
      const indicator = form.querySelector('.autosave-indicator');
      if (indicator) {
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
      }
    }
  });
  
  document.addEventListener('autosave:error', function(e) {
    const form = e.target.closest('.field-form');
    if (form) {
      form.classList.add('error');
      form.classList.remove('saving', 'saved');
    }
  });
});
</script>