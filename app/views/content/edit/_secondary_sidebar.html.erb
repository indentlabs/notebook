<!-- Secondary Sidebar - Edit Tools and Quick Actions -->
<div class="h-full overflow-y-auto">
  <div class="p-4 space-y-4">
    
    <!-- Tools -->
    <div class="pb-4 border-b border-gray-200">
      <div class="w-full space-y-2">
        <% if BasilService::ENABLED_PAGE_TYPES.include?(raw_content.class.name) %>
          <%= link_to basil_content_path(raw_content.class.name, raw_content.id),
                      target: "_blank",
                      class: "group flex items-center justify-between p-3 w-full rounded-lg hover:bg-gray-100 transition-all duration-200 bg-gray-50" do %>
            <div class="flex items-center">
              <i class="material-icons text-xl text-gray-400 group-hover:text-purple-500 mr-3">visibility</i>
              <div>
                <div class="font-medium text-gray-700 group-hover:text-purple-700 text-sm">Visualize</div>
                <div class="text-xs text-gray-500 group-hover:text-purple-600">Generate images</div>
              </div>
            </div>
            <i class="material-icons text-gray-400 group-hover:text-purple-500 text-lg">arrow_outward</i>
          <% end %>
        <% end %>

        <%= link_to polymorphic_path(@content, action: :changelog),
                    class: "group flex items-center justify-between p-3 w-full rounded-lg hover:bg-gray-100 transition-all duration-200 bg-gray-50" do %>
          <div class="flex items-center">
            <i class="material-icons text-xl text-gray-400 group-hover:text-blue-500 mr-3">history</i>
            <div>
              <div class="font-medium text-gray-700 group-hover:text-blue-700 text-sm">Changelog</div>
              <div class="text-xs text-gray-500 group-hover:text-blue-600">View history</div>
            </div>
          </div>
          <i class="material-icons text-gray-400 group-hover:text-blue-500 text-lg">arrow_forward</i>
        <% end %>

        <% if forum_url = ForumsLinkbuilderService.worldbuilding_url(raw_content.class) %>
          <%= link_to forum_url,
                      class: "group flex items-center justify-between p-3 w-full rounded-lg hover:bg-gray-100 transition-all duration-200 bg-gray-50" do %>
            <div class="flex items-center">
              <i class="material-icons text-xl text-gray-400 group-hover:text-blue-500 mr-3">forum</i>
              <div>
                <div class="font-medium text-gray-700 group-hover:text-blue-700 text-sm">Community</div>
                <div class="text-xs text-gray-500 group-hover:text-blue-600">Get feedback</div>
              </div>
            </div>
            <i class="material-icons text-gray-400 group-hover:text-blue-500 text-lg">arrow_outward</i>
          <% end %>
        <% end %>
      </div>
    </div>
    <!-- Save Status -->
    <div class="bg-gray-50 rounded-lg px-3 py-2 mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="w-2 h-2 bg-green-400 rounded-full mr-2" id="save-indicator"></div>
          <span class="text-sm text-gray-700">Saved</span>
        </div>
        <div class="text-xs text-gray-500" id="last-saved">
          Auto-saving...
        </div>
      </div>
    </div>
    
    <!-- Page Stats -->
    <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 mb-4">
      <h4 class="font-medium text-gray-700 mb-2 flex items-center">
        <i class="material-icons text-sm <%= content.class_text_color %> mr-1.5">analytics</i>
        Page Stats
      </h4>
      <div class="space-y-1.5">

        <!-- Effective Visibility -->
        <% if raw_content.respond_to?(:privacy) %>
          <div class="flex justify-between items-center">
            <span>Visibility</span>
            <button @click="switchView('privacy')"
                    :class="isEffectivelyPublic ?
                      'inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium transition-colors hover:bg-gray-200 bg-gray-200 text-gray-700' :
                      'inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium transition-colors hover:bg-gray-200 bg-gray-200 text-gray-700'"
                    title="Click to manage privacy settings">
              <i class="material-icons text-xs mr-0.5"
                 x-text="isEffectivelyPublic ? 'public' : 'lock'"></i>
              <span x-text="isEffectivelyPublic ? 'Public' : 'Private'"></span>
              <span x-show="showUniverseIndicator"
                    class="text-xs ml-0.5">(via universe)</span>
            </button>
          </div>
        <% end %>

        <div class="flex justify-between">
          <span>Word count</span>
          <kbd class="px-1 py-0.5 bg-gray-200 rounded">
            <%= number_with_delimiter(content.cached_word_count || 0) %>
          </kbd>
        </div>

        <div class="flex justify-between">
          <span>Last saved</span>
          <span class="text-gray-700" id="last-saved-time">
            <%= distance_of_time_in_words(raw_content.updated_at, Time.current) %> ago
          </span>
        </div>

        <%
          total_fields = content.data[:categories].map { |cat| cat[:fields].count }.sum
          completed_fields = content.data[:categories].map { |cat| cat[:fields].count { |field| field[:value].present? } }.sum
          completion_percent = total_fields > 0 ? (completed_fields.to_f / total_fields * 100).round : 0
        %>
        <div class="flex justify-between">
          <span>Completion</span>
          <span class="text-gray-700">
            <%= completion_percent %>%
            <span class="text-gray-500">(<%= completed_fields %>/<%= total_fields %>)</span>
          </span>
        </div>
      </div>
    </div>
    
    <!-- Keyboard Shortcuts Help -->
    <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600">
      <h4 class="font-medium text-gray-700 mb-2">Keyboard Shortcuts</h4>
      <div class="space-y-1">
        <div class="flex justify-between">
          <span>Save current field</span>
          <kbd class="px-1 py-0.5 bg-gray-200 rounded keyboard-shortcut-save">⌘S</kbd>
        </div>
        <div class="flex justify-between">
          <span>Exit editing</span>
          <kbd class="px-1 py-0.5 bg-gray-200 rounded">Esc</kbd>
        </div>
        <div class="flex justify-between">
          <span>Navigate fields</span>
          <kbd class="px-1 py-0.5 bg-gray-200 rounded">Tab</kbd>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Detect OS and update keyboard shortcuts
document.addEventListener('DOMContentLoaded', function() {
  const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0 || 
                navigator.userAgent.toUpperCase().indexOf('MAC') >= 0;
  
  // Update all save shortcut displays
  document.querySelectorAll('.keyboard-shortcut-save').forEach(function(element) {
    element.textContent = isMac ? '⌘S' : 'Ctrl+S';
  });
});

// Update save status
document.addEventListener('autosave:success', function() {
  const lastSavedEl = document.getElementById('last-saved');
  const saveIndicator = document.getElementById('save-indicator');
  const saveText = saveIndicator?.parentElement.querySelector('span');
  
  if (lastSavedEl) {
    lastSavedEl.textContent = new Date().toLocaleTimeString();
  }
  if (saveIndicator) {
    saveIndicator.className = 'w-2 h-2 bg-green-400 rounded-full mr-2';
  }
  if (saveText) {
    saveText.textContent = 'Saved';
    saveText.className = 'text-sm text-gray-700';
  }
});

// Show saving status when autosave starts
document.addEventListener('autosave:start', function() {
  const saveIndicator = document.getElementById('save-indicator');
  const saveText = saveIndicator?.parentElement.querySelector('span');
  
  if (saveIndicator) {
    saveIndicator.className = 'w-2 h-2 bg-yellow-400 rounded-full mr-2';
  }
  if (saveText) {
    saveText.textContent = 'Saving...';
    saveText.className = 'text-sm text-yellow-700';
  }
});

// Show unsaved changes when user starts typing
document.addEventListener('input', function(e) {
  if (e.target.matches('.autosave-closest-form-on-change')) {
    const saveIndicator = document.getElementById('save-indicator');
    const saveText = saveIndicator?.parentElement.querySelector('span');
    
    if (saveIndicator) {
      saveIndicator.className = 'w-2 h-2 bg-amber-400 rounded-full mr-2';
    }
    if (saveText) {
      saveText.textContent = 'Unsaved changes';
      saveText.className = 'text-sm text-amber-700';
    }
  }
});
</script>