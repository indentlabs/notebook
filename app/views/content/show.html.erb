<%
  page_description = "#{@content.name}, #{@content.description} â€” a fictional #{@content.class.name.downcase} on Notebook.ai"
  page_description ||= @content.description
  page_description ||= "#{@content.name} is a fictional #{@content.class.name.downcase} on Notebook.ai"

  set_meta_tags title:       @content.name,
                description: page_description.truncate(160),
                image_src:   @content.first_public_image,
                og:          { type: 'website' },
                twitter:     { card: 'photo', image: @content.first_public_image }
%>

<div class="min-h-screen bg-gray-50 dark:bg-gray-900 pt-10"
     x-data="showPageController()"
     x-init="init()">
  
  <!-- Header with breadcrumbs -->
  <%= render partial: 'content/header', locals: { 
    content: @serialized_content, 
    show_edit_controls: true,
    current_page: :show 
  } %>

  <!-- Hero Image Header -->
  <div class="relative h-64 md:h-80 lg:h-96 bg-gray-900 overflow-hidden">
    <% 
      # Get images using the same logic as dashboard cards
      regular_images = @content.image_uploads.ordered.to_a
      # Filter for public if the current user isn't the owner
      unless user_signed_in? && @content.user_id == current_user.id
        regular_images = regular_images.select { |img| img.privacy == 'public' }
      end
      basil_images = @content.basil_commissions.where.not(saved_at: nil).ordered.to_a
      
      # Use get_preview_image to prioritize pinned images, then randomize
      preview_image = get_preview_image(regular_images, basil_images)
    %>
    
    <% if preview_image.present? %>
      <% image_type = preview_image[:type] %>
      <% image_data = preview_image[:data] %>
      
      <% if image_type == 'image_upload' %>
        <%= image_tag image_data.src.url, 
                      class: "w-full h-full object-cover",
                      alt: "#{@content.name} banner image" %>
      <% elsif image_type == 'basil_commission' %>
        <% if image_data.image.attached? %>
          <%= image_tag rails_blob_path(image_data.image, disposition: "attachment"), 
                        class: "w-full h-full object-cover",
                        alt: "#{@content.name} banner image" %>
        <% else %>
          <%= image_tag "card-headers/#{@content.class.name.downcase.pluralize}.jpg", 
                        class: "w-full h-full object-cover",
                        alt: "#{@content.name} banner image" %>
        <% end %>
      <% end %>
    <% else %>
      <%= image_tag "card-headers/#{@content.class.name.downcase.pluralize}.jpg", 
                    class: "w-full h-full object-cover",
                    alt: "#{@content.name} banner image" %>
    <% end %>
      
    <!-- Strong gradient overlay for text contrast -->
    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>
      
      <!-- Content overlay with solid background -->
      <div class="absolute bottom-0 left-0 right-0 p-6 lg:p-8">
        <div class="max-w-4xl mx-auto">
          <!-- Sophisticated header container -->
          <div class="bg-notebook-blue bg-opacity-60 backdrop-blur-xl rounded-2xl px-4 py-2 border border-white border-opacity-20 shadow-2xl">
            <div class="flex items-center space-x-4">
              <!-- Premium page icon -->
              <div class="flex-shrink-0">
                <div class="w-12 h-12 <%= @serialized_content.class_color %> rounded-xl flex items-center justify-center shadow-lg ring-2 ring-white ring-opacity-20">
                  <i class="material-icons text-white text-xl font-light"><%= @serialized_content.class_icon %></i>
                </div>
              </div>
              
              <!-- Enhanced typography section -->
              <div class="flex-1 min-w-0">
                <!-- Page name with refined typography -->
                <h1 class="text-xl lg:text-2xl font-semibold text-white truncate mb-1 tracking-tight leading-tight">
                  <%= @content.name %>
                </h1>
                
                <!-- Universe information -->
                <% if @content.respond_to?(:universe) && @content.universe.present? %>
                  <div class="mt-3">
                    <span class="inline-flex items-center text-white <%= Universe.color %> px-3 py-1.5 rounded-full text-sm font-medium shadow-sm">
                      <i class="material-icons text-sm mr-2"><%= Universe.icon %></i>
                      <span class="font-medium"><%= @content.universe.name %></span>
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Main responsive layout -->
  <div class="max-w-full mx-auto">
    <div class="flex min-h-screen relative">
      
      <!-- Left Column - Navigation (Desktop only) -->
      <div class="hidden lg:block w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0">
        <%= render partial: 'content/show/navigation_sidebar', locals: {
          content: @serialized_content,
          raw_content: @content
        } %>
      </div>

      <!-- Mobile/Tablet Left Sidebar Toggle Tab -->
      <div class="lg:hidden fixed left-0 top-28 z-40">
        <button @click="showLeftSidebar = !showLeftSidebar"
                class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-r-md shadow-lg transition-all duration-300 flex items-center gap-1"
                title="Navigation">
          <i class="material-icons text-base" x-show="!showLeftSidebar">menu</i>
          <i class="material-icons text-base" x-show="!showLeftSidebar">chevron_right</i>
          <i class="material-icons text-base" x-show="showLeftSidebar">chevron_left</i>
        </button>
      </div>

      <!-- Mobile/Tablet Left Sidebar Overlay -->
      <div x-show="showLeftSidebar"
           x-transition:enter="transition-opacity ease-linear duration-200"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition-opacity ease-linear duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           @click="showLeftSidebar = false"
           class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-50">
      </div>

      <!-- Mobile/Tablet Left Sidebar -->
      <div x-show="showLeftSidebar"
           x-transition:enter="transform transition ease-in-out duration-200"
           x-transition:enter-start="-translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transform transition ease-in-out duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="-translate-x-full"
           class="lg:hidden fixed left-0 top-0 h-full w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-xl z-50 overflow-y-auto">

        <!-- Close button -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Navigation</h2>
            <button @click="showLeftSidebar = false"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
              <i class="material-icons text-gray-500">close</i>
            </button>
          </div>
        </div>

        <%= render partial: 'content/show/navigation_sidebar', locals: {
          content: @serialized_content,
          raw_content: @content
        } %>
      </div>

      <!-- Center Column - Dynamic Content -->
      <div class="flex-1 bg-white dark:bg-gray-900">
        <%= render partial: 'content/show/dynamic_content', locals: { 
          content: @serialized_content, 
          raw_content: @content 
        } %>
      </div>
      
      <!-- Right Column - Desktop Only -->
      <div class="hidden lg:block w-64 bg-gray-50 dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex-shrink-0">
        <%= render partial: 'content/show/secondary_sidebar', locals: { 
          content: @serialized_content, 
          raw_content: @content 
        } %>
      </div>
      
      <!-- Mobile/Tablet Right Sidebar Toggle Tab -->
      <div class="lg:hidden fixed right-0 top-28 z-40">
        <button @click="toggleRightSidebar()"
                class="bg-notebook-blue hover:bg-blue-600 text-white p-2 rounded-l-md shadow-lg transition-all duration-300 flex items-center gap-1"
                title="Quick Links">
          <i class="material-icons text-base" x-show="!showRightSidebar">chevron_left</i>
          <i class="material-icons text-base" x-show="!showRightSidebar">link</i>
          <i class="material-icons text-base" x-show="showRightSidebar">chevron_right</i>
        </button>
      </div>
      
      <!-- Mobile/Tablet Right Sidebar Overlay -->
      <div x-show="showRightSidebar" 
           x-transition:enter="transition-opacity ease-linear duration-200"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition-opacity ease-linear duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           @click="showRightSidebar = false"
           class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-50">
      </div>
      
      <!-- Mobile/Tablet Right Sidebar -->
      <div x-show="showRightSidebar"
           x-transition:enter="transform transition ease-in-out duration-200"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transform transition ease-in-out duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full"
           class="lg:hidden fixed right-0 top-0 h-full w-72 bg-gray-50 dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-xl z-50 overflow-y-auto">
        
        <!-- Close button -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Quick Links</h2>
            <button @click="showRightSidebar = false" 
                    class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
              <i class="material-icons text-gray-500">close</i>
            </button>
          </div>
        </div>
        
        <%= render partial: 'content/show/secondary_sidebar', locals: { 
          content: @serialized_content, 
          raw_content: @content 
        } %>
      </div>
      
    </div>
  </div>

  <!-- Floating action buttons -->
  <div class="fixed bottom-8 right-8 z-20 flex flex-col space-y-3">
    <!-- Share to Stream button -->
    <button @click="$dispatch('open-modal', 'share-to-stream-modal')"
            class="flex items-center justify-center w-12 h-12 rounded-full bg-white bg-opacity-80 backdrop-blur-sm shadow-lg text-gray-600 hover:text-green-600 hover:bg-white transition-all duration-200 border border-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:text-green-400 dark:hover:bg-gray-700 dark:border-gray-700 tooltip-left"
            data-tooltip="Share with community">
      <i class="material-icons">campaign</i>
    </button>
  </div>

  <!-- Share to Stream Modal -->
  <%= render 'shared/share_to_stream_modal',
             content: @content,
             content_type: @content.class.name,
             content_id: @content.id,
             content_name: @content.name,
             content_owner: @content.user %>
</div>

<!-- Alpine.js Controller for dynamic content switching -->
<script>
function showPageController() {
  return {
    currentView: 'overview',
    currentCategory: '<%= @serialized_content.data[:categories].find { |cat| cat[:label] != "Gallery" }&.dig(:label) %>',
    expandAllCategories: false,
    showRightSidebar: false,
    showLeftSidebar: false,

    init() {
      // Set initial view from URL hash if present
      const hash = window.location.hash.substring(1);
      if (['overview', 'details', 'gallery', 'associations', 'collections', 'timelines', 'feedback', 'contributors', 'privacy', 'shares'].includes(hash)) {
        this.currentView = hash;
        if (hash !== 'overview') {
          this.currentCategory = null;
        }
      }
      
      // Close sidebars on window resize to desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) { // lg breakpoint
          this.showRightSidebar = false;
          this.showLeftSidebar = false;
        }
      });

      // Default to expanded categories on mobile for better UX
      if (window.innerWidth < 1024) {
        this.expandAllCategories = true;
        this.currentCategory = null;
      }
    },
    
    switchView(view) {
      this.currentView = view;
      this.currentCategory = null;
      this.expandAllCategories = false;
      window.location.hash = view;

      // Close mobile sidebars when switching views
      this.showLeftSidebar = false;
      this.showRightSidebar = false;

      // Scroll to top of content area
      document.getElementById('dynamic-content').scrollTop = 0;
    },
    
    showCategory(categoryName) {
      this.currentView = 'overview';
      this.currentCategory = categoryName;
      this.expandAllCategories = false;
      window.location.hash = 'overview';

      // Close mobile sidebar when navigating
      this.showLeftSidebar = false;
    },
    
    showAllCategories() {
      this.currentView = 'overview';
      this.currentCategory = null;
      this.expandAllCategories = true;
      window.location.hash = 'overview';

      // Close mobile sidebar when navigating
      this.showLeftSidebar = false;
    },
    
    isViewActive(view) {
      return this.currentView === view;
    },
    
    isCategoryActive(categoryName) {
      return this.currentView === 'overview' && this.currentCategory === categoryName && !this.expandAllCategories;
    },
    
    isExpandAllActive() {
      return this.currentView === 'overview' && this.expandAllCategories;
    },
    
    toggleRightSidebar() {
      this.showRightSidebar = !this.showRightSidebar;
    }
  }
}
</script>