<%
  content_name = f.object.class.content_name

  # TODO we can probably just value = field[:value] now instead of this block?

  field_id = "#{content_name}_#{field[:id]}"
  value = if f.object.respond_to?(field[:id].to_sym)
    value = f.object.send(field[:id].to_sym)
  else
    value = field[:value]
  end
%>
<div class="content-field">
  <div class="input-field">
    <% unless defined?(show_label) && !show_label %>
      <%= f.label field do %>
        <%= field[:label].present? ? field[:label] : ' ' %>
        <% if defined?(autocomplete) && autocomplete %>
          <i class="material-icons grey-text lighten-2 tooltipped"
             style="font-size: 100%"
             data-tooltip="This field may suggest some ideas for you when you start typing."
             data-position="right"
          >
            offline_bolt
          </i>
        <% end %>
      <% end %>
    <% end %>

    <%
      placeholder = I18n.translate "attributes.#{content_name}.#{field[:label].underscore}",
        scope: :serendipitous_questions,
        name: f.object.send('name') || "this #{content_name}",
        default: 'Write as little or as much as you want!'
    %>

    <%= hidden_field_tag "#{content_name}[custom_attribute_values][][name]", field[:id] %>
    <%=
      text_area_tag "#{content_name}[custom_attribute_values][][value]",
                    value,
                    class: "materialize-textarea #{defined?(autocomplete) && autocomplete ? ('autocomplete ' + 'js-autocomplete-' + field[:id].to_s) : ''}",
                    placeholder: placeholder
    %>
    <% unless field[:type] == 'name' || field[:type] == 'universe' %>
      <%= render 'content/form/attribute_field_dropdown', field: field %>
    <% end %>

    <div class="content-field-link-bar-container"></div>
  </div>
</div>

<% if defined?(autocomplete) && autocomplete %>
  <%= content_for :javascript do %>
    $(function() {
      // This setTimeout is an unfortunate hack to ensure this runs after initializing materialize
      setTimeout(function() {
        console.log("Initializing autocomplete for #<%= "#{content_name}_#{field[:label]}" %>");

        $('.js-autocomplete-<%= field[:id].to_s %>').autocomplete({
          limit: 5,
          data: {
            <% autocomplete.each do |autocomplete_option| %>
              "<%= autocomplete_option %>": null,
            <% end %>
          }
        });
      }, 1000);
    });
  <% end %>
<% end %>
