<div class="category-card bg-white rounded-lg shadow-md overflow-hidden border-l-4 <%= category.hidden? ? 'border-gray-300 opacity-60 archived-category' : '' %>"
     data-category-id="<%= category.id %>"
     data-position="<%= category.position %>"
     data-archived="<%= category.hidden? %>"
     x-data="{ isOpen: false }"
     :class="{ 'ring-2 ring-opacity-70': selectedCategory == <%= category.id %> }"
     :style="selectedCategory == <%= category.id %> ? '--tw-ring-color: var(--content-type-color);' : ''"
     style="<%= category.hidden? ? '' : "border-color: #{content_type_class.hex_color};" %>"
     <% if category.hidden? %>style="display: none;"<% end %>>
  
  <!-- Category Header -->
  <div class="flex items-center p-3 cursor-pointer category-header" 
       @click="console.log('Category header clicked, toggling isOpen from', isOpen, 'to', !isOpen); isOpen = !isOpen; if (isOpen) { $dispatch('select-category', { id: <%= category.id %> }) }"
       <%= category.hidden? ? 'style="background-color: #f9fafb;"' : "style=\"background-color: #{content_type_class.hex_color}20;\"" %>>
    <!-- Drag Handle -->
    <div class="category-drag-handle flex items-center justify-center p-2 mr-2 rounded hover:bg-white hover:bg-opacity-50 cursor-move" 
         @click.stop>
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </div>
    
    <!-- Category Icon -->
    <div class="category-icon flex-shrink-0 w-8 h-8 rounded-full <%= category.hidden? ? 'bg-white' : 'bg-white' %> flex items-center justify-center mr-3 shadow-sm">
      <i class="material-icons <%= category.hidden? ? 'text-gray-400' : '' %> text-lg"
         <%= category.hidden? ? '' : "style=\"color: #{content_type_class.hex_color};\"" %>><%= category.icon %></i>
    </div>
    
    <!-- Category Title -->
    <div class="flex-grow">
      <h3 class="category-label text-gray-900 font-medium">
        <%= category.label %>
        <% if category.hidden? %>
          <i class="material-icons text-amber-600 text-sm ml-1.5 align-middle">archive</i>
        <% end %>
      </h3>
      <p class="text-gray-500 text-xs">
        <%= pluralize(category.attribute_fields.count, 'field') %>
        <% if category.hidden? %>
          <span class="text-amber-600 ml-2">â€” Archived</span>
        <% end %>
      </p>
    </div>
    
    <!-- Actions -->
    <div class="flex items-center space-x-1">
      <!-- Edit Button -->
      <button class="p-1.5 rounded hover:bg-white hover:bg-opacity-50" 
              title="Configure Category"
              @click.stop="$dispatch('select-category', { id: <%= category.id %> })">
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
      </button>
      
      <!-- Archive Toggle -->
      <button class="category-archive-toggle p-1.5 rounded hover:bg-white hover:bg-opacity-50 transition-colors" 
              data-category-id="<%= category.id %>"
              data-archived="<%= category.hidden? %>"
              title="<%= category.hidden? ? 'Archived category - Click to restore' : 'Active category - Click to archive' %>"
              @click.stop="toggleCategoryArchive(<%= category.id %>, $el.dataset.archived === 'true')">
        <% if category.hidden? %>
          <i class="material-icons text-amber-600 text-sm">unarchive</i>
        <% else %>
          <i class="material-icons text-gray-500 text-sm">archive</i>
        <% end %>
          <% if category.hidden? %>
            <!-- Hidden state - show EYE CLOSED icon -->
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
          <% else %>
            <!-- Visible state - show EYE OPEN icon -->
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          <% end %>
        </svg>
      </button>
      
      <!-- Expand/Collapse Button -->
      <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" 
           :class="{ 'transform rotate-180': isOpen }" 
           fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>
  </div>
  
  <!-- Category Body -->
  <div x-show="isOpen" 
       x-transition
       class="p-4 category-body">
    
    <!-- Fields Container -->
    <div class="fields-container space-y-2" data-category-id="<%= category.id %>">
      <% category.attribute_fields.order(:position).each do |field| %>
        <%= render partial: 'content/attributes/tailwind/field_item', locals: {
          field: field,
          content_type_class: content_type_class,
          content_type: content_type
        } %>
      <% end %>
    </div>
    
    <!-- Add Field Section -->
    <div class="mt-4 pt-3 border-t border-gray-100" x-data="{ addingField: false, fieldType: 'text_area' }">
      <button x-show="!addingField"
              @click="addingField = true" 
              class="flex items-center text-sm hover:underline focus:outline-none"
              style="color: <%= content_type_class.hex_color %>;">
        <i class="material-icons text-sm mr-1">add_circle_outline</i>
        <span>Add Field</span>
      </button>
      
      <!-- Add Field Form -->
      <div x-show="addingField" class="mt-3 space-y-4">
        <div class="flex space-x-2">
          <button @click="fieldType = 'text_area'" 
                  :style="fieldType === 'text_area' ? 'background-color: <%= content_type_class.hex_color %>20; border-color: <%= content_type_class.hex_color %>; color: <%= content_type_class.hex_color %>;' : ''"
                  :class="fieldType === 'text_area' ? '' : 'bg-white border-gray-300 text-gray-700'"
                  class="flex-1 py-2 px-3 border rounded-md text-sm font-medium flex justify-center items-center">
            <i class="material-icons text-sm mr-1.5">text_fields</i>
            Text
          </button>
          <button @click="fieldType = 'link'" 
                  :style="fieldType === 'link' ? 'background-color: <%= content_type_class.hex_color %>20; border-color: <%= content_type_class.hex_color %>; color: <%= content_type_class.hex_color %>;' : ''"
                  :class="fieldType === 'link' ? '' : 'bg-white border-gray-300 text-gray-700'"
                  class="flex-1 py-2 px-3 border rounded-md text-sm font-medium flex justify-center items-center">
            <i class="material-icons text-sm mr-1.5">link</i>
            Link
          </button>
        </div>
        
        <!-- Text Field Form -->
        <div x-show="fieldType === 'text_area'">
          <%= form_for(category.attribute_fields.build, method: :post, html: { class: "space-y-3", 'data-type': 'json', 'data-remote': 'true', '@submit.prevent': 'submitFieldForm($event)' }, remote: true) do |f| %>
            <%= f.hidden_field :attribute_category_id, value: category.id %>
            <%= f.hidden_field :field_type, value: 'text_area' %>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Field Name</label>
              <%= f.text_field :label, class: "shadow-sm block w-full sm:text-sm border-gray-300 rounded-md js-field-input focus:outline-none focus:ring-2 focus:ring-offset-2", style: "--tw-ring-color: #{content_type_class.hex_color}; border-color: #{content_type_class.hex_color};" %>
            </div>
            
            <div class="flex justify-end space-x-2">
              <button type="button" @click="addingField = false" class="px-3 py-1.5 border border-gray-300 rounded-md text-xs font-medium text-gray-700 hover:bg-gray-50">
                Cancel
              </button>
              <%= f.submit 'Add Text Field', class: "px-3 py-1.5 border border-transparent rounded-md shadow-sm text-xs font-medium text-white", style: "background-color: #{content_type_class.hex_color};" %>
            </div>
          <% end %>
          
          <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="text-xs font-medium text-gray-700 mb-2">Field Suggestions</div>
            <div class="suggest-fields-container flex flex-wrap gap-2 mb-2"></div>
            <button type="button" class="js-show-field-suggestions px-3 py-1 border border-gray-300 rounded-md text-xs font-medium text-gray-700 hover:bg-gray-50">
              Show Suggestions
            </button>
          </div>
        </div>
        
        <!-- Link Field Form -->
        <div x-show="fieldType === 'link'">
          <%= form_for(category.attribute_fields.build, method: :post, html: { class: "space-y-3", 'data-type': 'json', 'data-remote': 'true', '@submit.prevent': 'submitFieldForm($event)' }, remote: true) do |f| %>
            <%= f.hidden_field :attribute_category_id, value: category.id %>
            <%= f.hidden_field :field_type, value: 'link' %>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Field Name</label>
              <%= f.text_field :label, class: "shadow-sm block w-full sm:text-sm border-gray-300 rounded-md js-field-input focus:outline-none focus:ring-2 focus:ring-offset-2", style: "--tw-ring-color: #{content_type_class.hex_color}; border-color: #{content_type_class.hex_color};" %>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Link to Content Types</label>
              <div class="border border-gray-300 rounded-md shadow-sm p-2 max-h-32 overflow-y-auto">
                <% Rails.application.config.content_types[:all].each do |content_type| %>
                  <div class="flex items-center mb-1 last:mb-0">
                    <input type="checkbox" name="attribute_field[field_options][linkable_types][]" 
                           value="<%= content_type.name %>"
                           id="link_type_<%= content_type.name.downcase %>_<%= category.id %>"
                           class="h-4 w-4 border-gray-300 rounded focus:ring-2 focus:ring-offset-2"
                           style="color: <%= content_type_class.hex_color %>; --tw-ring-color: <%= content_type_class.hex_color %>;"
                    <label for="link_type_<%= content_type.name.downcase %>_<%= category.id %>" class="ml-2 block text-sm text-gray-700">
                      <i class="material-icons text-xs align-middle mr-1"><%= content_type.icon %></i>
                      <%= content_type.name.pluralize %>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            
            <div class="flex justify-end space-x-2">
              <button type="button" @click="addingField = false" class="px-3 py-1.5 border border-gray-300 rounded-md text-xs font-medium text-gray-700 hover:bg-gray-50">
                Cancel
              </button>
              <%= f.submit 'Add Link Field', class: "px-3 py-1.5 border border-transparent rounded-md shadow-sm text-xs font-medium text-white", style: "background-color: #{content_type_class.hex_color};" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>