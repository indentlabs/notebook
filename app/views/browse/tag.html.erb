<%
  # Calculate stats
  total_items = @tagged_content.sum { |group| group[:content].count }
  creators_count = @tagged_content.flat_map { |group| group[:content].map(&:user_id) }.uniq.count

  # Flatten all content into a single array for unified masonry grid
  all_content = @tagged_content.flat_map do |group|
    group[:content].map do |item|
      {
        item: item,
        type: group[:type],
        icon: group[:icon],
        color: group[:color]
      }
    end
  end.sort_by { |c| c[:item].updated_at }.reverse
%>

<!-- How to Join Dialog -->
<dialog id="how-to-join-dialog" class="rounded-xl p-0 max-w-lg w-full mx-4 backdrop:bg-black backdrop:bg-opacity-50">
  <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden">
    <div class="bg-purple-600 px-6 py-4">
      <h2 class="text-xl font-semibold text-white flex items-center">
        <i class="material-icons mr-2">info</i>
        How to join this showcase
      </h2>
    </div>
    <div class="p-6">
      <p class="text-gray-700 dark:text-gray-300 mb-4">Want your page to appear here? Follow these steps:</p>
      <ol class="list-decimal list-inside space-y-3 text-gray-700 dark:text-gray-300 mb-6">
        <li>Add the <span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-200 rounded font-medium">ArtFight2025</span> tag to your notebook page</li>
        <li>Set your page's privacy to <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 rounded font-medium">Public</span></li>
        <li>That's it! Your page will appear here automatically</li>
      </ol>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Note: It may take a few minutes for new content to appear.</p>
      <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center mb-3">
          <i class="material-icons text-purple-600 mr-2">brush</i>
          What is Art Fight?
        </h3>
        <p class="text-gray-700 dark:text-gray-300 mb-3">Art Fight is an annual art trading event that runs during July where:</p>
        <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 mb-4">
          <li>Artists are divided into two opposing teams</li>
          <li>Participants "attack" the opposing team by drawing their original characters (OCs)</li>
          <li>Each completed artwork earns points for your team</li>
          <li>The team with the most points at the end of July wins</li>
        </ul>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          Note: Notebook.ai is not officially affiliated with Art Fight. Visit
          <a href="https://artfight.net" target="_blank" class="text-purple-600 hover:text-purple-700 dark:text-purple-400 underline">artfight.net</a>
          to learn more.
        </p>
      </div>
    </div>
    <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 flex justify-end">
      <button onclick="this.closest('dialog').close()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors">
        Got it
      </button>
    </div>
  </div>
</dialog>

<!-- Compact Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
  <!-- Left: Tag + Stats -->
  <div class="flex items-center gap-3 flex-wrap">
    <span class="inline-flex items-center px-3 py-1.5 bg-purple-600 text-white text-sm font-medium rounded-full">
      <i class="material-icons text-sm mr-1.5"><%= PageTag.icon %></i>
      <%= @tag %>
    </span>
    <span class="text-sm text-gray-500 dark:text-gray-400">
      <%= pluralize(total_items, 'page') %> from <%= pluralize(creators_count, 'creator') %>
    </span>
    <button onclick="document.getElementById('how-to-join-dialog').showModal()"
            class="text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
            aria-label="How to join"
            title="How to join">
      <i class="material-icons text-lg">help_outline</i>
    </button>
  </div>

  <!-- Right: Filters + Sort -->
  <div class="flex items-center gap-2 overflow-x-auto pb-1">
    <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium transition-colors bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-200"
            data-category="all"
            onclick="filterByCategory('all')">
      All
    </button>
    <% @tagged_content.each do |content_group| %>
      <button class="category-filter px-3 py-1.5 rounded-full text-xs font-medium transition-colors bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"
              data-category="<%= content_group[:type].downcase %>"
              onclick="filterByCategory('<%= content_group[:type].downcase %>')">
        <%= content_group[:type].pluralize %>
      </button>
    <% end %>

    <select id="sortSelect"
            class="ml-2 px-2 py-1.5 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs focus:ring-1 focus:ring-purple-500"
            onchange="applySorting(this.value)">
      <option value="latest">Latest</option>
      <option value="oldest">Oldest</option>
      <option value="name_asc">A-Z</option>
      <option value="name_desc">Z-A</option>
      <option value="random">Random</option>
    </select>
  </div>
</div>

<!-- Masonry Grid -->
<% if all_content.empty? %>
  <div class="text-center py-16">
    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 mb-4">
      <i class="material-icons text-3xl text-gray-400">sell</i>
    </div>
    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No public content with this tag</h2>
    <p class="text-gray-500 dark:text-gray-400">
      No one has created any public content with the "<%= @tag %>" tag yet.
    </p>
  </div>
<% else %>
  <div class="columns-2 sm:columns-3 md:columns-4 lg:columns-5 xl:columns-6 gap-3" id="masonry-grid">
    <% all_content.each do |content_data| %>
      <%
        content = content_data[:item]
        content_type = content_data[:type]
        content_icon = content_data[:icon]

        # Get content name
        content_name = content.respond_to?(:name) ? content.name : content.title
        content_name = content_name.presence || 'Untitled'

        # Find image for this content
        content_image = @random_image_pool_cache.fetch([content.class.name, content.id], [])
          .sample
          .try(:src, :medium)

        if @saved_basil_commissions
          content_image ||= @saved_basil_commissions.fetch([content.class.name, content.id], [])
            .sample
            .try(:image)
            .try(:url)
        end

        content_image ||= asset_path("card-headers/#{content.class.name.downcase.pluralize}.webp")

        # Get user
        user = @users_cache[content.user_id]
      %>

      <div class="masonry-item break-inside-avoid mb-3"
           data-content-type="<%= content_type.downcase %>"
           data-updated-at="<%= content.updated_at.iso8601 %>"
           data-name="<%= content_name.downcase %>">
        <%= link_to content,
            target: (content.is_a?(Document) ? '_blank' : nil),
            class: "block relative overflow-hidden rounded-lg group" do %>

          <!-- Image -->
          <img src="<%= content_image %>"
               alt="<%= content_name %>"
               class="w-full"
               loading="lazy">

          <!-- Content type badge (top-right) -->
          <span class="absolute top-2 right-2 px-2 py-0.5 bg-black bg-opacity-50 rounded text-white text-xs flex items-center">
            <i class="material-icons text-xs mr-0.5"><%= content_icon %></i>
            <%= content_type %>
          </span>

          <!-- Bottom overlay: title + creator -->
          <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black to-transparent p-3 pt-10">
            <h3 class="text-white text-sm font-medium line-clamp-2 mb-1">
              <%= ContentFormatterService.show(text: content_name, viewing_user: current_user) %>
            </h3>
            <% if user %>
              <div class="flex items-center gap-1.5 text-white text-xs opacity-80">
                <% if user.image_url.present? %>
                  <img src="<%= user.image_url.html_safe %>"
                       alt="<%= user.display_name %>"
                       class="w-4 h-4 rounded-full"
                       loading="lazy">
                <% else %>
                  <div class="w-4 h-4 rounded-full bg-gray-500 flex items-center justify-center">
                    <i class="material-icons text-xs">person</i>
                  </div>
                <% end %>
                <span class="truncate"><%= user.display_name %></span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<!-- JavaScript -->
<script type="text/javascript">
  let currentCategory = 'all';

  document.addEventListener('DOMContentLoaded', function() {
    // Apply initial filter from URL hash
    let initialCategory = window.location.hash.substring(1) || 'all';
    if (!initialCategory || initialCategory.startsWith('!')) initialCategory = 'all';
    filterByCategory(initialCategory);

    // Apply initial sort from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const sortParam = urlParams.get('sort');
    if (sortParam) {
      document.getElementById('sortSelect').value = sortParam;
      applySorting(sortParam, false);
    }
  });

  function filterByCategory(category) {
    category = (category || 'all').toLowerCase();
    currentCategory = category;

    // Update button states
    document.querySelectorAll('.category-filter').forEach(btn => {
      const btnCategory = btn.dataset.category;
      const isActive = btnCategory === category;

      btn.classList.toggle('bg-purple-100', isActive);
      btn.classList.toggle('dark:bg-purple-900', isActive);
      btn.classList.toggle('text-purple-700', isActive);
      btn.classList.toggle('dark:text-purple-200', isActive);
      btn.classList.toggle('bg-gray-100', !isActive);
      btn.classList.toggle('dark:bg-gray-700', !isActive);
      btn.classList.toggle('text-gray-600', !isActive);
      btn.classList.toggle('dark:text-gray-300', !isActive);
    });

    // Show/hide cards
    document.querySelectorAll('.masonry-item').forEach(card => {
      const cardType = card.dataset.contentType;
      const shouldShow = category === 'all' || cardType === category;
      card.classList.toggle('hidden', !shouldShow);
    });

    // Update URL
    if (category === 'all') {
      window.history.replaceState(null, null, window.location.pathname + window.location.search);
    } else {
      window.history.replaceState(null, null, '#' + category);
    }

    return false;
  }

  function applySorting(sortValue, updateURL = true) {
    if (updateURL) {
      const url = new URL(window.location);
      url.searchParams.set('sort', sortValue);
      window.history.replaceState({}, '', url);
    }

    const grid = document.getElementById('masonry-grid');
    if (!grid) return;

    const items = Array.from(grid.querySelectorAll('.masonry-item'));

    items.sort((a, b) => {
      switch (sortValue) {
        case 'latest':
          return new Date(b.dataset.updatedAt) - new Date(a.dataset.updatedAt);
        case 'oldest':
          return new Date(a.dataset.updatedAt) - new Date(b.dataset.updatedAt);
        case 'name_asc':
          return (a.dataset.name || '').localeCompare(b.dataset.name || '');
        case 'name_desc':
          return (b.dataset.name || '').localeCompare(a.dataset.name || '');
        case 'random':
          return Math.random() - 0.5;
        default:
          return 0;
      }
    });

    items.forEach(item => grid.appendChild(item));
  }
</script>
