<%# Left Sidebar Content Partial (for mobile overlay) %>
<%# Locals: timeline, timeline_event_tags, timeline_content_summary %>

<!-- Sidebar Content -->
<div class="flex-1 overflow-y-auto">
  <!-- Quick Actions -->
  <div class="p-6 border-b border-gray-100 dark:border-gray-700">
    <button id="js-create-timeline-event-mobile"
            onclick="document.getElementById('js-create-timeline-event').click()"
            class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-sm transition-colors">
      <i class="material-icons text-lg mr-2">add</i>
      Add Event
    </button>
  </div>

  <!-- Filter Events Section -->
  <div class="p-6 border-b border-gray-100 dark:border-gray-700">
    <button @click="showFilterSection = !showFilterSection"
            class="w-full flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg p-2 -m-2 transition-colors">
      <div class="flex items-center">
        <i class="material-icons text-sm mr-2 text-gray-600 transition-transform duration-200"
           :class="showFilterSection ? 'rotate-90' : ''">chevron_right</i>
        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-200">Filter Events</h4>
      </div>
      <span x-show="selectedTagFilters.length > 0"
            class="text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded-full">
        Active
      </span>
    </button>

    <!-- Collapsible Filter Content -->
    <div x-show="showFilterSection"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 -translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-2"
         class="mt-4">

      <!-- Search Box -->
      <div class="relative mb-4">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="material-icons text-gray-400 text-lg">search</i>
        </div>
        <input type="text"
               x-model="searchQuery"
               @input="applyEventFilters()"
               @keydown.escape="searchQuery = ''; applyEventFilters()"
               placeholder="Search timeline..."
               class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-green-500 focus:border-green-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400">
      </div>

      <!-- Filter Mode Toggle -->
      <div class="mb-4">
        <div class="flex rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
          <button @click="changeTagFilterMode('filter')"
                  :class="tagFilterMode === 'filter' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                  class="flex-1 px-3 py-1 text-sm font-medium rounded-md transition-colors">
            Filter
          </button>
          <button @click="changeTagFilterMode('highlight')"
                  :class="tagFilterMode === 'highlight' ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'"
                  class="flex-1 px-3 py-1 text-sm font-medium rounded-md transition-colors">
            Highlight
          </button>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          <span x-show="tagFilterMode === 'filter'">Show only events with selected tags</span>
          <span x-show="tagFilterMode === 'highlight'">Show all events, highlight selected tags</span>
        </p>
      </div>

      <!-- Tag Selection List -->
      <% if timeline_event_tags.any? %>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          <% timeline_event_tags.each do |tag_data| %>
            <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded px-2 py-1 transition-colors">
              <input type="checkbox"
                     x-model="selectedTagFilters"
                     value="<%= tag_data[:name] %>"
                     @change="applyEventFilters()"
                     class="rounded border-gray-300 text-green-600 focus:ring-green-500 focus:ring-offset-0">
              <span class="flex-1 text-gray-700 dark:text-gray-300"><%= tag_data[:name] %></span>
              <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full"><%= tag_data[:count] %></span>
            </label>
          <% end %>
        </div>

        <!-- Clear Filters -->
        <div class="mt-3 pt-3 border-t border-gray-200">
          <button @click="clearTagFilters()"
                  x-show="selectedTagFilters.length > 0"
                  class="text-sm text-gray-600 hover:text-gray-900 transition-colors">
            <i class="material-icons text-sm mr-1">clear</i>
            Clear all filters
          </button>
        </div>
      <% else %>
        <div class="text-center py-4 text-gray-500">
          <i class="material-icons text-2xl mb-2 text-gray-300">label_outline</i>
          <p class="text-sm">No tags found</p>
          <p class="text-xs text-gray-400">Add tags to events to enable filtering</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Linked Content Summary -->
  <div class="p-6">
    <h4 class="text-sm font-medium text-gray-900 mb-3">Linked Content</h4>

    <% if timeline_content_summary.any? %>
      <div class="space-y-2">
        <% timeline_content_summary.each do |content_type, summary_data| %>
          <% content_class = summary_data[:content_class] %>

          <!-- Content Type Header -->
          <div class="group">
            <button type="button"
                    @click="toggleContentSummarySection('<%= content_type.downcase %>')"
                    class="w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-center min-w-0 flex-1">
                <i class="material-icons text-sm mr-2 <%= content_class.text_color %> transition-transform duration-200"
                   :class="isContentSummaryCollapsed('<%= content_type.downcase %>') ? '' : 'rotate-90'">
                  chevron_right
                </i>
                <i class="material-icons text-sm mr-2 <%= content_class.text_color %> flex-shrink-0">
                  <%= content_class.icon %>
                </i>
                <span class="text-sm font-medium text-gray-700 truncate">
                  <%= content_type.pluralize %>
                </span>
              </div>
              <span class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full ml-2 flex-shrink-0">
                <%= summary_data[:count] %>
              </span>
            </button>

            <!-- Expandable Content List -->
            <div x-show="!isContentSummaryCollapsed('<%= content_type.downcase %>')"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 -translate-y-2"
                 class="ml-6 mt-2 space-y-1">

              <% summary_data[:items].each do |item| %>
                <% item_name = item.name.presence || "Untitled #{content_type}" %>
                <div class="flex items-center py-1 hover:bg-gray-50 dark:hover:bg-gray-700 px-2 py-1 rounded transition-colors">
                  <i class="material-icons text-xs mr-2 text-gray-400">link</i>
                  <%= link_to item_name, item,
                      target: '_blank',
                      class: 'text-sm text-gray-600 hover:text-gray-900 hover:underline transition-colors truncate',
                      onclick: 'event.stopPropagation()' %>
                </div>
              <% end %>

              <% if summary_data[:total_items] > 10 %>
                <div class="text-xs text-gray-500 py-1 pl-5">
                  <i class="material-icons text-xs mr-1">more_horiz</i>
                  <%= summary_data[:total_items] - 10 %> more <%= content_type.pluralize.downcase %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-6">
        <div class="w-12 h-12 mx-auto rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-3">
          <i class="material-icons text-gray-400 dark:text-gray-500">link_off</i>
        </div>
        <p class="text-sm text-gray-500">
          No linked content yet
        </p>
        <p class="text-xs text-gray-400 mt-1">
          Content will appear here when you link pages to events
        </p>
      </div>
    <% end %>
  </div>

  <!-- Timeline Stats -->
  <div class="p-6 border-t border-gray-100 dark:border-gray-700">
    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-200 mb-3">Timeline Stats</h4>
    <div class="space-y-3">
      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600 dark:text-gray-400">Total Events</span>
        <span class="text-sm font-medium text-gray-900 dark:text-gray-200"><%= timeline.timeline_events.count %></span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600 dark:text-gray-400">Word Count</span>
        <span class="text-sm font-medium text-gray-900 dark:text-gray-200"><%= number_with_delimiter(timeline.cached_word_count) %></span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600 dark:text-gray-400">Total Linked Pages</span>
        <span class="text-sm font-medium text-gray-900 dark:text-gray-200"><%= timeline.timeline_events.joins(:timeline_event_entities).count %></span>
      </div>
    </div>
  </div>
</div>
