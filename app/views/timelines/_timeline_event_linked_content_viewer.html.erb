<% if timeline_event.timeline_event_entities.any? %>
  <div class="border-t border-gray-100 pt-4" id="linked-content-<%= timeline_event.id %>">
    
    <% 
      # Group entities by type for better organization
      grouped_entities = timeline_event.timeline_event_entities.includes(:entity).order(:entity_type).group_by(&:entity_type)
    %>
    
    <div class="space-y-4">
      <% grouped_entities.each do |entity_type, entity_list| %>
        <% entity_list.reject! { |te_entity| te_entity.entity.nil? } %>
        <% next if entity_list.empty? %>
        <% klass = content_class_from_name(entity_type) %>
        
        <div class="linked-content-group" 
             x-data="{ expanded: false }"
             x-init="expanded = <%= entity_list.count <= 4 ? 'true' : 'false' %>">
          <!-- Content Type Header (Collapsible) -->
          <div @click="expanded = !expanded" 
               class="flex items-center justify-between cursor-pointer hover:bg-gray-50 -mx-2 px-2 py-2 rounded-lg transition-colors">
            <div class="flex items-center">
              <i class="material-icons text-sm mr-2 <%= klass.text_color %>"><%= klass.icon %></i>
              <h5 class="text-sm font-medium text-gray-800"><%= entity_type.pluralize %></h5>
              <span class="ml-2 text-xs text-gray-500">(<%= entity_list.count %>)</span>
            </div>
            <i class="material-icons text-sm text-gray-400 transition-transform duration-200"
               :class="expanded ? 'rotate-180' : ''">expand_more</i>
          </div>
          
          <!-- Horizontal Scrolling Cards -->
          <div x-show="expanded" 
               x-transition:enter="transition ease-out duration-200"
               x-transition:enter-start="opacity-0 -translate-y-2"
               x-transition:enter-end="opacity-100 translate-y-0"
               x-transition:leave="transition ease-in duration-150"
               x-transition:leave-start="opacity-100 translate-y-0"
               x-transition:leave-end="opacity-0 -translate-y-2"
               class="overflow-x-auto pb-2 mt-2">
            <div class="flex space-x-3" style="width: max-content;">
              <% entity_list.each do |te_entity| %>
                <% entity = te_entity.entity %>
                <% entity_name = entity.name.presence || "Untitled #{te_entity.entity_type}" %>
                
                <div class="group flex-shrink-0 w-50 h-30 rounded-xl overflow-hidden border border-gray-200 hover:border-gray-300 hover:shadow-lg transition-all duration-300 bg-white">
                  <!-- Full Background Image with Overlay Content -->
                  <div class="relative w-full h-full">
                    <!-- Background Image -->
                    <% if entity.respond_to?(:pinned_or_random_image_including_private) %>
                      <% preview_image = entity.pinned_or_random_image_including_private(format: :medium) %>
                      <% if preview_image.present? && !preview_image.include?('card-headers') %>
                        <img src="<%= preview_image %>" 
                             alt="<%= entity_name %>" 
                             class="w-full h-full object-cover"
                             loading="lazy">
                      <% else %>
                        <!-- Icon Placeholder Background -->
                        <div class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                          <i class="material-icons text-4xl text-white opacity-60"><%= klass.icon %></i>
                        </div>
                      <% end %>
                    <% else %>
                      <!-- Icon Placeholder Background -->
                      <div class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <i class="material-icons text-4xl text-white opacity-60"><%= klass.icon %></i>
                      </div>
                    <% end %>
                    
                    <!-- Gradient Overlay for Text Readability -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                    
                    <!-- Content Type Badge -->
                    <div class="absolute top-2 right-2">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white/90 backdrop-blur-sm text-gray-700 shadow-sm">
                        <i class="material-icons text-xs mr-1 <%= klass.text_color %>"><%= klass.icon %></i>
                        <%= entity_type %>
                      </span>
                    </div>
                    
                    <!-- Content Info Overlay -->
                    <div class="absolute bottom-0 left-0 right-0 p-3">
                      <h6 class="font-semibold text-white text-sm leading-tight mb-1 group-hover:text-green-200 transition-colors">
                        <%= link_to entity_name, entity, 
                            class: "hover:underline",
                            target: "_blank" %>
                      </h6>
                      
                      <!-- Content Description Preview (if available) -->
                      <% if entity.respond_to?(:description) && entity.description.present? %>
                        <p class="text-xs text-gray-200 leading-relaxed line-clamp-2 opacity-90">
                          <%= truncate(strip_tags(entity.description), length: 60) %>
                        </p>
                      <% end %>
                      
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>